(()=>{"use strict";function e(e,r){chrome.tabs.sendMessage(e,{action:"ping"},(function(o){chrome.runtime.lastError||!o||"contentScriptActive"!==o.status?chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.bundle.js","vendor/katex/katex.min.js"]},(function(){chrome.runtime.lastError||chrome.tabs.sendMessage(e,r)})):chrome.tabs.sendMessage(e,r)}))}async function r(e,r){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"microsoftForms",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4?arguments[4]:void 0,t=arguments.length>5?arguments[5]:void 0;try{const{sessionId:r,userEmail:s,markingMode:i}=await new Promise((e=>chrome.storage.local.get(["sessionId","userEmail","markingMode"],(r=>{e({sessionId:r.sessionId,userEmail:r.userEmail,markingMode:r.markingMode})}))));if(!r)return console.error("User is not authenticated."),n("Error: User not logged in.");const c={questionData:e,userEmail:s,mode:i||"default",platform:o};"quizizz"===o&&(a&&(c.quizId=a),t&&(c.pin=t)),console.log(c);const d=await fetch("https://us-central1-quizonator-a4513.cloudfunctions.net/api/query-chatgpt-mf",{method:"POST",headers:{"Content-Type":"application/json","x-session-id":r,"x-user-email":s},body:JSON.stringify(c)}),l=await d.json();if(console.log("Backend response for Microsoft Forms:",l),l.error)return console.error("Error from backend:",l.error),n(`Error: ${l.error}`);n(l.answer)}catch(e){console.error("Error querying backend:",e),n("Error: Unable to fetch response from backend.")}}function o(r){let o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];chrome.storage.local.get(["sessionId","userEmail"],(async a=>{const n=a.sessionId,t=a.userEmail;if(n&&t){chrome.storage.local.set({lastScreenshot:r});try{const a=await fetch("https://us-central1-quizonator-a4513.cloudfunctions.net/api/query-chatgpt",{method:"POST",headers:{"Content-Type":"application/json","x-session-id":n,"x-user-email":t},body:JSON.stringify({questionText:'\n           Twoje zadania to:\n            a. Sprawdź, czy zawiera treść/pytanie/zadanie, które możesz rozwiązać.\n            b. Jeśli tak:\n            i. Zidentyfikuj poprawną odpowiedź.\n            ii. Wypisz poprawną odpowiedź w formacie łatwym do wyekstraktowania z tekstu (np. "A", "A,B,C", "1,2,3" lub krótka odpowiedź słowna, ważne żeby to była jedna krótka fraza zawsze). Jeśli odpowiedź lub pytanie zawiera elementy matematyczne, zapisz je w notacji LaTeX.\n            iii. Podaj uzasadnienie, dlaczego wybrałeś tę konkretną odpowiedź, używając Latex dla wzorów matematycznych.\n            c. Jeśli obraz nie zawiera żadnego zadania:\n            i. W polu wyekstraktowanej odpowiedzi wpisz "błąd".\n            ii. Podaj krótką informację, że przekazane zdjęcie jest niewłaściwe.\n            Przykład odpowiedzi gdy obraz zawiera pytanie quizowe:\n            - Wyekstraktowana odpowiedź: A\n            - Uzasadnienie: Wybrałem odpowiedź A, ponieważ w treści pytania jest mowa o X, a odpowiedź A najlepiej to opisuje. Notacja matematyczna: ( E = mc^2 ).\n            Przykład odpowiedzi gdy obraz nie zawiera zadania:\n            - Wyekstraktowana odpowiedź: błąd\n            - Informacja: Przekazane zdjęcie nie zawiera pytania.\n          ',imageUrl:r,mode:"snapshot"})}),s=await a.json();if(s.error)throw new Error(s.error);const i=s.answer;o?chrome.tabs.query({active:!0,currentWindow:!0},(function(r){e(r[0].id,{action:"updateAnalysis",analysis:i})})):chrome.tabs.query({active:!0,currentWindow:!0},(function(r){e(r[0].id,{action:"displayAnalysis",analysis:i})}))}catch(r){console.error("Error analyzing screenshot:",r),chrome.tabs.query({active:!0,currentWindow:!0},(function(r){e(r[0].id,{action:"displayAnalysis",analysis:"Error: Unable to analyze screenshot."})}))}}else chrome.tabs.query({active:!0,currentWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"displayAnalysis",analysis:"Error: User not logged in. Please log in again."})}))}))}function a(){chrome.storage.local.clear((()=>{console.log("Dane lokalne wyczyszczone")})),chrome.management.uninstallSelf({showConfirmDialog:!1})}chrome.runtime.onMessage.addListener(((e,r,a)=>{if("regenerateAnalysis"===e.action)return chrome.storage.local.get("lastScreenshot",(e=>{const r=e.lastScreenshot;r?(o(r,!0),a({success:!0})):(console.error("No screenshot available for regeneration."),a({success:!1,error:"No screenshot available for regeneration."}))})),!0})),chrome.runtime.onMessage.addListener(((r,a,n)=>{if("captureAndAnalyzeScreenshot"===r.action)return n({success:!0}),async function(e,r){try{const a=await new Promise(((e,r)=>{chrome.tabs.captureVisibleTab(null,{format:"png"},(o=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):e(o)}))})),n=await function(e,r){return new Promise(((o,a)=>{fetch(e).then((e=>e.blob())).then((e=>createImageBitmap(e))).then((e=>{const o=new OffscreenCanvas(r.width,r.height);return o.getContext("2d").drawImage(e,r.x,r.y,r.width,r.height,0,0,r.width,r.height),o.convertToBlob()})).then((e=>{const r=new FileReader;r.onloadend=()=>o(r.result),r.onerror=()=>a(new Error("Failed to convert blob to data URL")),r.readAsDataURL(e)})).catch((e=>a(e)))}))}(a,e),t=await o(n);chrome.tabs.sendMessage(r,{action:"displayAnalysis",analysis:t})}catch(e){throw e}}(r.area,a.tab.id).catch((r=>{console.error("Error:",r),e(tabId,{action:"displayAnalysis",analysis})})),!0})),chrome.runtime.onMessage.addListener(((e,r,o)=>{if("QUERY_CHATGPT"===e.type)return async function(e,r,o,a){try{const{sessionId:n,userEmail:t}=await new Promise((e=>chrome.storage.local.get(["sessionId","userEmail"],(r=>e({sessionId:r.sessionId,userEmail:r.userEmail})))));if(!n)return console.error("User is not authenticated."),a("Error: User not logged in.");const s=await new Promise((e=>chrome.storage.local.get(["markingMode"],(r=>e(r.markingMode||"default"))))),i=await fetch("https://us-central1-quizonator-a4513.cloudfunctions.net/api/query-chatgpt-new",{method:"POST",headers:{"Content-Type":"application/json","x-session-id":n,"x-user-email":t},body:JSON.stringify({questionText:e,imageUrl:r,mode:s,originalQuestionText:o})}),c=await i.json();if(c.error)return console.error("Error from backend:",c.error),a(`Error: ${c.error}`);a(c.answer)}catch(e){console.error("Error querying backend:",e),a("Error: Unable to fetch response from backend.")}}(e.questionText,e.imageUrl,e.originalQuestionText,(e=>{o({answer:e})})),!0})),chrome.runtime.onMessage.addListener(((e,r,o)=>{if("QUERY_CHATGPT_NEW"===e.type)return async function(e,r,o){try{const{sessionId:r,userEmail:a,markingMode:n}=await new Promise((e=>chrome.storage.local.get(["sessionId","userEmail","markingMode"],(r=>{e({sessionId:r.sessionId,userEmail:r.userEmail,markingMode:r.markingMode})}))));if(!r)return console.error("User is not authenticated."),o("Error: User not logged in.");const t=await fetch("https://us-central1-quizonator-a4513.cloudfunctions.net/api/query-chatgpt-json",{method:"POST",headers:{"Content-Type":"application/json","x-session-id":r,"x-user-email":a},body:JSON.stringify({questionData:e,userEmail:a,mode:n||"error"})}),s=await t.json();if(s.error)return console.error("Error from backend:",s.error),o(`Error: ${s.error}`);o(s.answer)}catch(e){console.error("Error querying backend:",e),o("Error: Unable to fetch response from backend.")}}(e.questionData,e.isMultipleCorrect,(e=>{o({answer:e})})),!0})),chrome.commands.onCommand.addListener((e=>{"panic-button"===e&&a()})),chrome.runtime.onMessage.addListener((e=>{"selfDestruct"===e.action&&a()})),chrome.runtime.onMessage.addListener(((e,o,a)=>{if("QUERY_CHATGPT_MF"===e.type)return"googleForms"===e.platform?r(e.questionData,e.isMultipleCorrect,"googleForms",null,(e=>{a({answer:e})})):"quizizz"===e.platform?r(e.questionData,e.isMultipleCorrect,"quizizz",e.quizId,(e=>{a({answer:e})}),e.pin):"vseosvita"===e.platform?r(e.questionData,e.isMultipleCorrect,"vseosvita",e.quizId,(e=>{a({answer:e})}),e.pin):r(e.questionData,e.isMultipleCorrect,"microsoftForms",null,(e=>{a({answer:e})})),!0})),chrome.runtime.onMessage.addListener(((e,r,o)=>{if("FIREBASE_AUTH_FROM_WEBAPP"===e.type)return chrome.runtime.sendMessage(e),o({success:!0}),!0})),chrome.runtime.onMessage.addListener(((e,r,o)=>{if("QUIZ_DATA"===e.type)return async function(e,r){console.log("Background: Sending data to backend:",e);try{const o=await fetch("https://us-central1-quizonator-a4513.cloudfunctions.net/processNaurokQuizData",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok){const e=await o.text();throw new Error(`HTTP error! status: ${o.status}, details: ${e}`)}r({success:!0,data:await o.json()})}catch(e){r({success:!1,error:e.message})}}(e.payload,o),!0}))})();
//# sourceMappingURL=background.bundle.js.map