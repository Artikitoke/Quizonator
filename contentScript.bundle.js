(()=>{"use strict";function e(e,t,o,n,r){let i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];return new Promise(((a,l)=>{const c=function(e,t,o){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=arguments.length>6?arguments[6]:void 0,a=`${e}\n\n`;if("multipleChoice"===o){if(!Array.isArray(t))throw console.error("possibleAnswers is not an array:",t),new Error("possibleAnswers should be an array for multipleChoice");s&&s.length>0&&(a+="Rozwiąż na bazie załączonego zdjęcia, zanim zaznaczyć odpowiedź przeanalizuj zdjęcie.\n"),a+=i?"Podaj wszystkie poprawne odpowiedzi. Musisz podać co najmniej jedną odpowiedź. Napisz bardzo krótkie uzasadnienie, następnie daj znak '|$|' a po nim napisz jedynie numery poprawnych odpowiedzi.\n\n":"Jest jedynie jedna poprawna odpowiedź, zaznacz tą która wydaje się być najbardziej prawidłowa. Napisz bardzo krótkie uzasadnienie następnie daj znak '|$|' a po nim napisz jedynie numer poprawnej.\n\n",t.forEach(((e,t)=>{a+=`${t+1}. ${e}\n`}))}else if("trueFalse"===o){if(!Array.isArray(t))throw console.error("possibleAnswers is not an array:",t),new Error("possibleAnswers should be an array for trueFalse");a+="Podaj poprawną odpowiedź (True/False). Podaj jedynie samą odpowiedź nic więcej.\n\n",t.forEach(((e,t)=>{a+=`${t+1}. ${e}\n`}))}else if("matching"===o){if(!Array.isArray(t))throw console.error("possibleAnswers is not an array:",t),new Error("possibleAnswers should be an array for matching");a+="Dopasuj każdy termin do jednej z podanych opcji. Odpowiedz wyłącznie numerami opcji w kolejności ich występowania, oddzielając je przecinkami, np. '3, 1, 2'. Bez dodatkowych komentarzy.\n\n",t.forEach((e=>{if(!e||!Array.isArray(e.options))throw console.error("pair.options is not an array:",e),new Error("pair.options should be an array in matching");a+=`Termin: ${e.term}\nOpcje:\n`,e.options.forEach(((e,t)=>{a+=`  ${t+1}. ${e}\n`}))}))}else if("cloze"===o){if(!Array.isArray(t))throw console.error("possibleAnswers is not an array:",t),new Error("possibleAnswers should be an array for cloze");a+="Dopasuj odpowiednie odpowiedzi do każdej luki w tekście. Podaj numer każdej poprawnej opcji w kolejności ich występowania, bez dodatkowych komentarzy. Na przykład, jeśli poprawne odpowiedzi to 'długoterminowe planowanie', 'strategiczne planowanie', odpowiedź powinna wyglądać tak: '1, 4'.\n\n",t.forEach(((e,t)=>{if(!Array.isArray(e))throw console.error("options is not an array:",e),new Error("options should be an array in cloze");a+=`Luka ${t+1}:\n`,e.forEach(((e,t)=>{a+=`  ${t+1}. ${e}\n`}))}))}else if("cloze-multianswer"===o)a+="Jeśli pytanie ma listę opcji, podaj cyfry numerków poprawnych odpowiedzi. Jeśli pytanie wymaga odpowiedzi tekstowej i nie ma możliwych odpowiedzi, odpowiedz jednym słowem do wpisania. Nie pisz nic poza odpowiedzią. Albo piszesz np. '1,2' albo np. 'well-paid' nie dodawaj nic poza odpowiedzią.\n\n";else if("shortAnswer"===o)a+=n>1?"Podaj odpowiedzi dla każdego pola tekstowego w osobnym wierszu, w takiej kolejności, jak są one widoczne. Nie dodawaj żadnych dodatkowych informacji ani wyjaśnień.\n\n":"Podaj jedno słowo lub krótką frazę jako odpowiedź na poniższe pytanie. Nie dodawaj żadnych dodatkowych informacji ani wyjaśnień. Po prostu wpisz odpowiedź.\n\n";else if("longAnswer"===o)a+="Podaj pełną odpowiedź na poniższe pytanie. Proszę, aby odpowiedź była szczegółowa i wyczerpująca ale ma być w kilku zdaniach, nie przekraczaj 600 znaków.\n\n";else if("dragAndDrop"===o)a+="Dopasuj każdą frazę do odpowiedniego miejsca w tekście. Podaj numer każdej poprawnej frazy w kolejności ich występowania, bez dodatkowych komentarzy. Na przykład, jeśli poprawne odpowiedzi to '1, 3, 2', odpowiedź powinna wyglądać tak: '1, 3, 2'.\n\n",t.forEach(((e,t)=>{a+=`${t+1}. ${e}\n`}));else{if("ordering"===o)return a=`${e.trim()}\n\n`,a+="Podaj poprawną kolejność elementów, podając ich nazwy w odpowiedniej kolejności, oddzielając je przecinkami. Na przykład: 'Element1, Element2, Element3'.\n\n",r.forEach((e=>{a+=`${e.trim()}\n`})),a;if("opowiedzZAI"===o)a="Proszę opowiedzieć o poniższym tekście w kilku zdaniach:\n\n",a+=e;else if("openEnded"===o)a+="Podaj jedno słowo lub krótką frazę jako odpowiedź na poniższe pytanie. Nie dodawaj żadnych dodatkowych informacji ani wyjaśnień (chyba że ewidetnie z treści pytania wynika, że trzeba się rozpisać). Po prostu wpisz odpowiedź. Przykłądowo dla treści pytania 'She has been working here ___ five years.' twoja odpowiedz powinna brzmieć dokładnie tak: 'for'\n\n",a+=e;else{if(a+="Podaj poprawną odpowiedź.\n\n",!Array.isArray(t))throw console.error("possibleAnswers is not an array:",t),new Error("possibleAnswers should be an array");t.forEach(((e,t)=>{a+=`${t+1}. ${e}\n`}))}}return a}(e,t,o,n,r,i,s),u=s.length>0?s[0]:null;chrome.runtime.sendMessage({type:"QUERY_CHATGPT",questionText:c,imageUrl:u,originalQuestionText:e},(e=>{e&&e.answer?a(e.answer):l("No answer received from ChatGPT.")}))}))}function t(e,t){return new Promise(((o,n)=>{chrome.runtime.sendMessage({type:"QUERY_CHATGPT_MF",questionData:e,isMultipleCorrect:t},(e=>{e&&e.answer?o(e.answer):n("No answer received from ChatGPT.")}))}))}function o(){const e=new URLSearchParams(window.location.search).get("page"),t=null!==e?parseInt(e,10):0;return isNaN(t)?0:t}function n(e){const t=(navigator.language||navigator.userLanguage).split("-")[0],o={correctAnswer:{pl:"Poprawna odpowiedź:",en:"Correct answer:",ru:"Правильный ответ:",uk:"Правильна відповідь:",default:"Correct answer:"}}[e]||{};return o[t]||o.default||e}function r(e){const t=(JSON.parse(localStorage.getItem("instructionsRanges"))||[]).find((t=>null!==t.startPage&&null!==t.endPage&&e>=t.startPage&&e<=t.endPage));return t?t.instructionText:""}function i(e,t,o){return`\n    Instructions: ${t||"(brak)"}\n    Question: ${e}\n    Choices: ${o?o.join(" | "):"(brak)"}\n    `}async function s(e){const t=e.cloneNode(!0);return t.querySelectorAll('script[type="math/tex"], script[type="math/tex; mode=display"]').forEach((e=>{const t=e.textContent.trim();e.parentElement?e.parentElement.replaceWith(document.createTextNode(` \\(${t}\\) `)):e.remove()})),t.querySelectorAll(".MathJax_Preview, .MJX_Assistive_MathML").forEach((e=>e.remove())),t.innerText.trim().replace(/\s+/g," ")}async function a(e){const t=e.querySelector(".formulation").querySelectorAll("img"),o=[];for(const e of t){const t=await l(e);o.push(t)}return o}function l(e){return new Promise(((t,o)=>{const n=document.createElement("canvas"),r=n.getContext("2d");n.width=e.width,n.height=e.height,r.drawImage(e,0,0),n.toBlob((e=>{const n=new FileReader;n.onloadend=()=>{t(n.result)},n.onerror=()=>{o("Error converting image to base64.")},n.readAsDataURL(e)}),"image/png")}))}async function c(t){const n=document.querySelectorAll(".formulation");let s=[];function a(e){let t="";return e.childNodes.forEach((e=>{if(e.nodeType===Node.TEXT_NODE)t+=e.textContent;else if(e.nodeType===Node.ELEMENT_NODE){const o=e;if(o.classList.contains("subquestion")){const e=o.querySelector("select"),n=o.querySelector("input[type='text']");if(e){let o=[];e.querySelectorAll("option").forEach(((e,t)=>{""!==e.value&&o.push(`${t}: ${e.textContent.trim()}`)})),t+=` [${o.join(", ")}] `}else n&&(t+=" [___] ")}else t+=a(o)}})),t}n.forEach(((e,t)=>{let o=a(e);o=o.replace(/\s+/g," ").trim(),s.push(`Pytanie ${t+1}: ${o}`)}));const l=r(o());e(i(s,l),[],"cloze-multianswer").then((e=>{const o=e.split("\n").map((e=>e.trim())).filter((e=>""!==e));!function(e,t){const o=e.querySelectorAll(".subquestion");chrome.storage.local.get(["markingMode"],(e=>{const n=e.markingMode||"default",r=t.join(",").split(",").map((e=>e.trim())).filter((e=>""!==e));o.forEach(((e,t)=>{const o=e.querySelector("select"),i=e.querySelector("input[type='text']");if(t>=r.length)return;const s=r[t];if(o){const e=parseInt(s,10);if(isNaN(e))return;const t=o.options[e];if(!t)return;if("default"===n)t.style.color="#4CAF50";else if("immediate"===n)o.value=t.value;else if("saveMode"===n){const e=t.textContent.trim();e.length>0&&(t.innerHTML=`<strong>${e[0]}</strong>${e.slice(1)}`),t.style.color="#A9A9A9"}}else if(i)if("default"===n){const e=document.createElement("div");e.style.color="#4CAF50",e.style.fontWeight="bold",e.innerText=s,i.insertAdjacentElement("afterend",e)}else"immediate"===n?i.value=s:"saveMode"===n&&(i.addEventListener("focus",(function(){i.placeholder=s})),i.addEventListener("blur",(function(){i.placeholder=""})),i.style.color="#A9A9A9",i.addEventListener("input",(function(){i.style.color=""})));else console.warn(`⚠ subquestion nr ${t+1} nie zawiera <select> ani <input>.`)}))}))}(t,o)})).catch((e=>{console.error("Error processing multi-answer question with ChatGPT:",e)}))}async function u(e){const t=await async function(e){try{return(await fetch(e,{method:"HEAD"})).ok}catch(e){return!1}}(e);return t?e:await async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"image/jpeg";const o=await fetch(e);if(!o.ok)throw new Error(`Błąd fetch: ${o.status} - ${o.statusText}`);let n=o.headers.get("content-type")||"";n.startsWith("image/")||(n=t);let r=await o.blob();return r=new Blob([r],{type:n}),new Promise(((e,t)=>{const o=new FileReader;o.onload=()=>e(o.result),o.onerror=e=>t(e),o.readAsDataURL(r)}))}(e)}async function d(e){if(!e)return[];const t=e.querySelectorAll("img"),o=Array.from(t).map((async e=>{const t=e.getAttribute("src");return t?{url:await u(t),alt:e.alt||""}:null}));return(await Promise.all(o)).filter(Boolean)}async function p(e){const t=e.querySelectorAll(".question_answers .answer_container"),o=[];for(let e=0;e<t.length;e++){const n=t[e].querySelector(".answer_body");if(!n)continue;const r=n.innerText.trim(),i=await d(n);o.push({id:"ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e],label:r,images:i})}return o}async function m(e,o,n){if("true"===e.dataset.alreadyHandled)return null;e.dataset.alreadyHandled="true";const r=await async function(e){const t=function(e){const t=e.querySelector('input[name="givenAnswer.questionType"]');if(!t)return console.warn("Nie znaleziono typu pytania w:",e),"unknown";switch(t.value){case"TRUE_FALSE":return"trueFalse";case"SINGLE_ANSWER":case"SURVEY":return"singleChoice";case"MULTI_ANSWER":return"multipleChoice";case"SHORT_ANSWER":return"shortAnswer";case"DESCRIPTIVE":return"openText";default:return"unknown"}}(e),o=e.querySelector(".question_essence");let n=o?o.innerText.trim():"";const r=await d(o),i={id:e.getAttribute("id")||`q-${Date.now()}`,text:n,images:r,metadata:{difficulty:"unknown"}};switch(t){case"trueFalse":case"singleChoice":i.type="singlechoice",i.options=await p(e),i.format={responseType:"optionId",description:"Odpowiedz jako pojedyncza litera lub numer odpowiadający właściwej opcji."};break;case"multipleChoice":i.type="multiple",i.options=await p(e),i.format={responseType:"optionIds",description:'Odpowiedz jako tablica numerów/oznaczeń [np. ["1", "3"]].'};break;case"shortAnswer":i.type="shortanswer",i.options=[],i.placeholder="Wpisz krótką odpowiedź";const t=e.querySelector(".all_short_answers input[type='text']");i.answerLength=t?"short":"long","long"===i.answerLength?i.format={responseType:"text",description:"Podaj wyczerpującą odpowiedź."}:i.format={responseType:"text",description:"Podaj krótką odpowiedź."};break;case"openText":i.type="shortanswer",i.options=[],i.placeholder="Wpisz odpowiedź opisową",i.answerLength="long",i.format={responseType:"text",description:"Podaj rozwiniętą odpowiedź tekstową (descriptive)."};break;default:return null}return i}(e);return r?t(r,n).then((t=>t&&t.correctAnswer?(function(e,t,o,n){n=(n||"default").toLowerCase();const r=o.type;if(!e.querySelector(".correct-answer-info")&&!e.dataset.alreadyMarked)if(e.dataset.alreadyMarked="true","singlechoice"===r||"multiple"===r){const r=e.querySelectorAll(".question_answers .answer_container");if(!r||0===r.length)return;let i=[];Array.isArray(t)?i=t.map((e=>e.trim().toUpperCase())):"string"==typeof t&&(i=t.includes(",")?t.split(",").map((e=>e.trim().toUpperCase())):[t.trim().toUpperCase()]),r.forEach(((e,t)=>{const r=o.options[t]?.id.toUpperCase();if(r&&i.includes(r)){const t=e.querySelector("input[type='checkbox'], input[type='radio']"),o=e.querySelector(".answer_body");if(!o)return;const r=0===o.innerText.replace(/zoom-in\s*Powiększ obraz/i,"").trim().length;if("immediate"===n||r&&("default"===n||"savemode"===n))t&&(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})));else if("savemode"===n){const e=o.innerText;e.length>0&&(o.innerHTML=`<span style="font-weight: 600;">${e[0]}</span>${e.slice(1)}`)}else o.style.color="#4CAF50",o.style.fontWeight="700"}}))}else if("shortanswer"===r){let o=e.querySelector(".all_short_answers input[type='text']");if(o||(o=e.querySelector(".rich-text-answer-area")),!o)return;let r="";if("string"==typeof t?r=t.trim():t&&t.value&&(r=String(t.value).trim()),"immediate"===n)if("input"===o.tagName.toLowerCase())o.value=r,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}));else{const e=document.getElementById("givenAnswer");e&&(e.value=r,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})));const t=document.getElementById("givenAnswer_ifr");if(t){const e=t.contentDocument||t.contentWindow.document;(e.querySelector(".mce-content-body")||e.body).innerHTML=`<p>${r}</p>`}}else if("savemode"===n)if("input"===o.tagName.toLowerCase())o.value="",o.placeholder="",o.addEventListener("focus",(()=>{o.placeholder=r})),o.addEventListener("blur",(()=>{o.placeholder=""}));else{const e=document.createElement("div");e.textContent=`Podpowiedź: ${r}`,e.style.color="#ccc",e.style.fontSize="0.8em",e.style.opacity="0.1",e.style.transition="opacity 0.2s ease",e.style.marginTop="4px",e.style.userSelect="text",e.addEventListener("mouseenter",(()=>{e.style.opacity="1"})),e.addEventListener("mouseleave",(()=>{e.style.opacity="0.1"})),o.insertAdjacentElement("afterend",e)}else{const e=document.createElement("div");if(e.classList.add("correct-answer-info"),e.style.background="#f0fff0",e.style.border="1px solid #ddeedd",e.style.borderRadius="4px",e.style.marginTop="10px",e.style.marginBottom="10px",e.style.padding="8px 12px",e.style.width="100%",e.style.boxSizing="border-box",e.style.fontSize="14px",e.style.color="green",e.innerHTML=`\n                <div style="font-weight: bold; margin-bottom: 4px;">Poprawna odpowiedź:</div>\n                <div>${r}</div>\n            `,"input"===o.tagName.toLowerCase()){const t=o.closest(".all_short_answers");t?t.appendChild(e):o.insertAdjacentElement("afterend",e)}else o.insertAdjacentElement("afterend",e)}}}(e,t.correctAnswer,r,o),t.correctAnswer):(delete e.dataset.alreadyHandled,null))).catch((t=>(console.error("Błąd zapytania do endpointu /query-chatgpt-mf (TestPortal):",t),delete e.dataset.alreadyHandled,null))):(delete e.dataset.alreadyHandled,null)}async function y(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return new Promise((o=>{if(e.complete&&0!==e.naturalWidth)return o();const n=setTimeout(o,t);e.addEventListener("load",(()=>{clearTimeout(n),o()})),e.addEventListener("error",(()=>{clearTimeout(n),o()}))}))}async function f(e){const t=e.querySelectorAll("img"),o=[];for(const e of t)await y(e),o.push({url:e.src,alt:e.alt||""});return o}function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300;const o=Date.now();return new Promise((n=>{!function r(){const i=e.querySelector('script[type="math/tex"]');if(i)return n(i.textContent.trim());const s=e.querySelectorAll(".MathJax, [data-mathml]");if(s.length>0||Date.now()-o>=t){let t="";s.forEach((e=>{e.hasAttribute("data-mathml")?t+=" "+e.getAttribute("data-mathml").trim():e.innerText&&e.innerText.trim().length>0&&(t+=" "+e.innerText.trim())}));const o=e.innerHTML,r=/\$(.*?)\$/g;let i;for(;null!==(i=r.exec(o));)i[1]&&i[1].trim().length>0&&(t+=" "+i[1].trim());n(t.trim())}else setTimeout(r,10)}()}))}async function g(e){let t=e.querySelectorAll('[data-automation-id="choiceItem"]');const o=[],n="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let r=0;if(!t||0===t.length){const t=e.querySelector("div.-bT-49");if(t)return t.querySelectorAll("img").forEach(((e,t)=>{const r=n[t]||""+(t+1);o.push({id:r,label:`Opcja ${t+1}`,images:[{url:e.src,alt:e.alt||""}]})})),o}for(let e of t){let t="";const i=e.querySelector("[data-automation-value]");if(i)t=i.getAttribute("data-automation-value").trim();else{const o=e.querySelector('script[type="math/tex"]');if(o)t=o.textContent.trim();else{const o=await h(e);t=(e.querySelector(".text-format-content")?.innerText.trim()||"")+(o?"\n"+o:"")}}const s=await f(e),a=n[r]||""+(r+1);o.push({id:a,label:t,images:s}),r++}return o}async function w(){if(document.querySelector('[aria-label*="Informacje o uczniu"], [aria-label*="Student Information"]'))return;const{markingMode:e}=await new Promise((e=>{chrome.storage.local.get(["markingMode"],(t=>{e({markingMode:t.markingMode||"default"})}))})),o=document.querySelectorAll('[data-automation-id="questionItem"]');if(0===o.length)return;const n=Array.from(o).map((o=>async function(e,o){if("true"===e.dataset.alreadyHandled)return null;e.dataset.alreadyHandled="true";const n=await async function(e){const t=function(e){if(e.querySelector('[data-automation-id="likerTableTh"]')||e.querySelector('[data-automation-id="likerTableTr"]'))return"likert";if(e.querySelector('[data-automation-id="likerSubQuestion"]'))return"likert";const t=e.querySelector('[data-automation-id="questionTitle"] [aria-hidden="true"]');if(t){const e=t.innerText.toLowerCase().trim();if(e.includes("pojedynczy wybór")||e.includes("jednokrotny wybór"))return"singleChoice";if(e.includes("wielokrotny wybór")||e.includes("multi wybór"))return"multipleChoice";if(e.includes("data"))return"date";if(e.includes("tekst"))return"openText";if(e.includes("klasyfikacja"))return"ranking"}return e.querySelector('input[type="radio"]')?"singleChoice":e.querySelector('input[type="checkbox"]')?"multipleChoice":e.querySelector('[data-automation-id="textInput"]')||e.querySelector("textarea")?"openText":e.querySelector('[data-automation-id="dateContainer"]')?"date":e.querySelector('[data-automation-id="rankingItemContent"]')?"ranking":"unknown"}(e),{text:o,images:n}=await async function(e){const t=e.querySelector('[data-automation-id="questionTitle"] .text-format-content'),o=e.querySelector('[data-automation-id="questionSubTitle"] .text-format-content');let n="";if(t){n+=t.innerText.trim();const e=await h(t);e&&(n+="\n"+e)}if(o){n+="\n"+o.innerText.trim();const e=await h(o);e&&(n+="\n"+e)}const r=e.querySelector(':not([data-automation-id="choiceItem"])'),i=r?await h(r):"";i&&!n.includes(i)&&(n+="\n"+i);const s=await f(e);return{text:n.trim(),images:s}}(e);let r={id:e.getAttribute("id")||`q-${Date.now()}`,text:o,images:n,metadata:{difficulty:"unknown"}};switch(t){case"singleChoice":r.type="singlechoice",r.options=await g(e),r.format={responseType:"optionId",description:"Odpowiedz jako pojedyncza litera odpowiadająca właściwej opcji."};break;case"multipleChoice":r.type="multiple",r.options=await g(e),r.format={responseType:"optionIds",description:'Odpowiedz jako tablica liter odpowiadających właściwym opcjom (np. ["A", "C"]).'};break;case"date":r.type="date";const t=await async function(e){const t=e.querySelector('[data-automation-id="dateContainer"]');let o="Wprowadź datę (dd.MM.yyyy)";if(t){const e=t.querySelector('input[type="text"]');e&&(o=e.placeholder||o)}return{placeholder:o,images:await f(e)}}(e);r.options=[],r.placeholder=t.placeholder,r.format={responseType:"date",description:"Podaj datę w formacie dd.MM.yyyy."};break;case"openText":r.type="shortanswer";const o=await async function(e){const t=e.querySelector('input[type="text"], textarea'),o=await f(e);return{placeholder:t&&t.placeholder||"Wprowadź odpowiedź",images:o}}(e);r.options=[],r.placeholder=o.placeholder;const n=e.querySelector('input[type="text"], textarea');n&&"textarea"===n.tagName.toLowerCase()?r.answerLength="long":r.answerLength="short","long"===r.answerLength?r.format={responseType:"text",description:"Podaj wyczerpującą, szczegółową odpowiedź tekstową."}:r.format={responseType:"text",description:"Podaj krótką odpowiedź tekstową."};break;case"likert":r.type="likert";const i=await async function(e){if(e.querySelector('[data-automation-id="likerTableTr"]')){const t=e.querySelectorAll('[data-automation-id="likerStatementTd"] .text-format-content'),o=e.querySelectorAll('[data-automation-id="likerTableTh"] .text-format-content'),n=await Promise.all(Array.from(t).map((async(e,t)=>{const o=await f(e);return{id:`s${t+1}`,text:e.innerText.trim(),images:o}}))),r=["P","F"];return{commonOptions:await Promise.all(Array.from(o).map((async(e,t)=>{const o=await f(e);return{id:r[t]||String.fromCharCode(65+t),label:e.innerText.trim(),images:o}}))),statements:n}}if(e.querySelector('[data-automation-id="likerSubQuestion"]')){const t=e.querySelectorAll('[data-automation-id="likerSubQuestion"]'),o=await Promise.all(Array.from(t).map((async(e,t)=>{const o=e.querySelector(".-q--329 .text-format-content"),n=o?await f(o):[];return{id:`s${t+1}`,text:o?o.innerText.trim():"",images:n}}))),n=e.querySelector('[data-automation-id="likerSubQuestion"]');let r=[];n&&(r=n.querySelectorAll('[data-automation-id="likerOption"]'));const i=["P","F"];return{commonOptions:await Promise.all(Array.from(r).map((async(e,t)=>{const o=e.querySelector(".-jt-333 .text-format-content"),n=o?await f(o):[];return{id:i[t]||String.fromCharCode(65+t),label:o?o.innerText.trim():"",images:n}}))),statements:o}}return{commonOptions:[],statements:[]}}(e);r.commonOptions=i.commonOptions,r.statements=i.statements,r.format={responseType:"matrix",description:"Odpowiedz jako obiekt JSON, gdzie każdy klucz to id stwierdzenia (np. 's1'), a wartość to identyfikator wybranej opcji ('P' dla Prawda lub 'F' dla Fałsz)."};break;case"ranking":r.type="ranking";const s=await async function(e){const t=e.querySelectorAll('[data-automation-id="rankingItemContent"]');return{ranking:Array.from(t).map(((e,t)=>({id:t+1,label:e.innerText.trim()})))}}(e);r.ranking=s.ranking,r.format={responseType:"ranking",description:"Podaj poprawną kolejność elementów jako uporządkowaną listę numerów, np. [2, 1, 3, 4]."};break;default:return null}return r}(e);if(!n)return null;if(!["singlechoice","multiple","shortanswer","likert","ranking","date"].includes(n.type))return n;try{const r=await t(n);r&&r.correctAnswer?function(e,t,o,n){n=n.toLowerCase();const r=o.type;if("singlechoice"===r||"multiple"===r){let i=e.querySelectorAll('[data-automation-id="choiceItem"]');i&&0!==i.length||(i=e.querySelectorAll("div.-mf-91"));const s="string"==typeof t&&/^[\d,\s]+$/.test(t.trim());let a=[],l=[];s?a=t.split(",").map((e=>parseInt(e.trim(),10)-1)).filter((e=>!isNaN(e)&&e>=0)):Array.isArray(t)?l=t.map((e=>e.toUpperCase())):"string"==typeof t&&(l=[t.trim().toUpperCase()]),i.forEach(((e,t)=>{const r=e.querySelector(".text-format-content")||e,i=o.options[t]?.id||String.fromCharCode(65+t);let c=!1;if(s?a.includes(t)&&(c=!0):i&&l.includes(i.toUpperCase())&&(c=!0),c)if("default"===n){const t=r.querySelector(".MathJax");t?t.getBoundingClientRect().height<5?setTimeout((()=>{t.style.boxShadow="0 0 10px rgba(0, 128, 0, 0.7)",t.style.border="2px solid rgba(0, 128, 0, 0.7)",t.style.backgroundColor="rgba(0, 128, 0, 0.1)",t.style.transition="all 0.3s ease",t.style.padding="10px",t.style.borderRadius="5px"}),200):(t.style.boxShadow="0 0 10px rgba(0, 128, 0, 0.7)",t.style.border="2px solid rgba(0, 128, 0, 0.7)",t.style.backgroundColor="rgba(0, 128, 0, 0.1)",t.style.transition="all 0.3s ease",t.style.padding="10px",t.style.borderRadius="5px"):(r.style.color="green",r.style.fontWeight="700");const o=e.querySelector("img");o?o.naturalWidth<20?setTimeout((()=>{r.style.boxShadow="0 0 10px rgba(0, 128, 0, 0.7)",r.style.border="2px solid rgba(0, 128, 0, 0.7)",r.style.backgroundColor="rgba(0, 128, 0, 0.1)",r.style.transition="all 0.3s ease",r.style.padding="10px",r.style.borderRadius="5px"}),300):(r.style.boxShadow="0 0 10px rgba(0, 128, 0, 0.7)",r.style.border="2px solid rgba(0, 128, 0, 0.7)",r.style.backgroundColor="rgba(0, 128, 0, 0.1)",r.style.transition="all 0.3s ease",r.style.padding="10px",r.style.borderRadius="5px"):(r.style.color="green",r.style.fontWeight="700")}else if("immediate"===n){const t=e.querySelector('input[type="radio"], input[type="checkbox"]');t&&("checkbox"===t.type?t.checked||(t.checked=!0):t.click(),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})))}else if("savemode"===n){const e=r.querySelector(".MathJax");if(e)e.style.boxShadow="0 0 0 1px rgba(0, 128, 0, 0.03)",e.style.border="1px solid rgba(0, 128, 0, 0.03)",e.style.backgroundColor="rgba(0, 128, 0, 0.01)",e.style.padding="2px",e.style.borderRadius="3px";else{const e=r.textContent;e.length>0&&(r.innerHTML=`<span style="font-weight:600; opacity:0.8;">${e.charAt(0)}</span>${e.slice(1)}`)}}}))}else if("shortanswer"===r){const c=e.querySelector('[data-automation-id="textInput"]');if(!c)return;if(c.classList.contains("savemode-input")||c.classList.add("savemode-input"),"default"===n){const u=e.querySelector('[data-automation-id="textInput"]');if(!u)return;const d=u.parentElement;d.style.display="block";let p=d.querySelector(".correct-answer-info");p||(p=document.createElement("div"),p.classList.add("correct-answer-info"),p.style.display="block",p.style.marginTop="10px",p.style.marginBottom="5px",p.style.color="green",p.style.fontWeight="500",p.style.whiteSpace="normal",p.style.overflow="auto",p.style.width="100%",p.style.boxSizing="border-box",p.style.position="relative",p.style.zIndex="10",p.style.padding="8px",p.style.border="1px solid #e0e0e0",p.style.borderRadius="4px",p.style.backgroundColor="#f0f8f0",p.style.fontSize="14px",p.style.lineHeight="1.5",p.style.wordWrap="break-word",p.innerText=`${function(){const e={pl:"Poprawna odpowiedź:",en:"Correct answer:",de:"Richtige Antwort:",es:"Respuesta correcta:",fr:"Réponse correcte:",it:"Risposta corretta:",ru:"Правильный ответ:",cs:"Správná odpověď:",sk:"Správna odpoveď:",uk:"Правильна відповідь:"};return e[(navigator.language||navigator.userLanguage).split("-")[0]]||e.en}()} ${t}`,d.insertAdjacentElement("afterend",p))}else if("immediate"===n)c.value=String(t),c.dispatchEvent(new Event("input",{bubbles:!0})),c.dispatchEvent(new Event("change",{bubbles:!0})),c.focus(),c.blur();else if("savemode"===n){const m=e.querySelector('[data-automation-id="textInput"]');if(!m)return;m.classList.contains("savemode-input")||m.classList.add("savemode-input");const y=m.getAttribute("placeholder")||"";m.dataset.originalPlaceholder=y;const f=e.querySelector('div[jsname="LwH6nd"]');if(m.addEventListener("focus",(function(){""===this.value&&(this.placeholder=String(t)),f&&(f.style.display="none")})),m.addEventListener("blur",(function(){this.placeholder=this.dataset.originalPlaceholder,f&&(f.style.display="")})),m.addEventListener("input",(function(){""!==this.value?this.placeholder="":document.activeElement===this&&(this.placeholder=String(t))})),!document.getElementById("savemode-placeholder-style")){const h=document.createElement("style");h.id="savemode-placeholder-style",h.textContent="\n                    /* Gdy input ma fokus, placeholder w kolorze jasno szarym */\n                    .savemode-input:focus::placeholder {\n                        color: #ccc !important;\n                    }\n                    /* Gdy input nie ma fokusu, placeholder w kolorze czarnym */\n                    .savemode-input:not(:focus)::placeholder {\n                        color: #000 !important;\n                    }\n                ",document.head.appendChild(h)}}}else if("ranking"===r){if("string"==typeof t)try{t=JSON.parse(t)}catch(g){}if("default"===n){const w=e.querySelector(".lrp-ranking-container");if(!w)return;function b(){const e=Array.from(w.querySelectorAll(".rank-item"));e.forEach(((e,t)=>{e.getAttribute("data-original-id")||e.setAttribute("data-original-id",t+1)}));const o=e.map((e=>parseInt(e.getAttribute("data-original-id"))));e.forEach(((e,n)=>{o[n]!==t[n]?e.style.border="2px solid red":e.style.border="2px solid green"}))}b(),new MutationObserver((()=>{b()})).observe(w,{childList:!0,subtree:!0})}if("immediate"===n){const x=e.querySelector(".lrp-ranking-container");if(!x)return;const S=Array.from(x.querySelectorAll(".rank-item"));S.forEach(((e,t)=>{e.getAttribute("data-original-id")||e.setAttribute("data-original-id",t+1)}));const q=t.map(String).map((e=>S.find((t=>t.getAttribute("data-original-id")===e))));if(q.includes(void 0))return;x.innerHTML="",q.forEach((e=>x.appendChild(e)))}else if("savemode"===n){const v=e.querySelector(".lrp-ranking-container");if(!v)return;function k(){const e=Array.from(v.querySelectorAll(".rank-item"));e.forEach(((e,t)=>{e.getAttribute("data-original-id")||e.setAttribute("data-original-id",t+1)}));const o=e.map((e=>parseInt(e.getAttribute("data-original-id"))));e.forEach(((e,n)=>{o[n]!==t[n]?e.style.border="1px solid #ebebeb":e.style.border=""}))}k(),new MutationObserver((()=>{k()})).observe(v,{childList:!0,subtree:!0})}}else if("date"===r){const T=e.querySelector('[data-automation-id="dateContainer"]');if(!T)return;const A=T.querySelector('input[type="text"]');if(!A)return;if("default"===n){let E=T.parentElement.querySelector(".correct-answer-date-info");E||(E=document.createElement("div"),E.classList.add("correct-answer-date-info"),E.style.display="block",E.style.marginTop="5px",E.style.color="green",E.style.fontWeight="700",T.parentElement.insertAdjacentElement("afterend",E)),E.innerText=`Poprawna data: ${t}`}else"immediate"===n?(A.value=String(t),A.dispatchEvent(new Event("input",{bubbles:!0})),A.dispatchEvent(new Event("change",{bubbles:!0})),A.focus(),A.blur()):"savemode"===n&&(A.addEventListener("focus",(function(){A.placeholder=String(t)})),A.addEventListener("blur",(function(){A.placeholder=unified.placeholder})))}else if("likert"===r)if("string"==typeof t.value){const C=t.value.split(",").filter((e=>""!==e));let z={};o.commonOptions&&o.commonOptions.length>0&&o.commonOptions.forEach(((e,t)=>{z[t+1]=e.id.toUpperCase()}));let M=e.querySelectorAll('[data-automation-id="likerTableTr"]');0===M.length&&(M=e.querySelectorAll('[data-automation-id="likerSubQuestion"]'));const P=M.length>0&&"likerSubQuestion"===M[0].getAttribute("data-automation-id");M.forEach(((e,t)=>{if(!z[C[t]])return;const o=`input[data-choice-id="${C[t]}"]`,r=e.querySelector(o);if(r){if("immediate"===n)if(P){const e=r.closest("label");e&&e.click()}else r.click();const t=r.parentElement.querySelector("svg path");if(t)"savemode"===n?(t.style.stroke="#ccc",t.style.strokeWidth="2"):"default"===n&&(t.style.stroke="green",t.style.strokeWidth="2");else{const t=e.querySelector(".text-format-content");t&&("savemode"===n?t.style.color="gray":(t.style.color="green",t.style.fontWeight="700"))}if(P){const e=r.closest('[data-automation-id="likerOption"]');e&&("savemode"===n?e.style.border="2px solid lightgray":"default"===n&&(e.style.border="2px solid green",e.style.fontWeight="700"))}}}))}else{if("object"!=typeof t.value||null===t.value)return;{let j={};o.commonOptions&&o.commonOptions.length>0&&o.commonOptions.forEach(((e,t)=>{j[e.id.toUpperCase()]=t+1}));let L=[];o.statements&&o.statements.length>0&&o.statements.forEach((e=>{let o=t.value[e.id];if(o){let e=j[o.toUpperCase()];L.push(void 0!==e?e:o)}else L.push("")}));const I=L.join(",")+",",N=(t={value:I,answerRepresentation:"numeric"}).value.split(",").filter((e=>""!==e));let $={};o.commonOptions&&o.commonOptions.length>0&&o.commonOptions.forEach(((e,t)=>{$[t+1]=e.id.toUpperCase()}));let O=e.querySelectorAll('[data-automation-id="likerTableTr"]');0===O.length&&(O=e.querySelectorAll('[data-automation-id="likerSubQuestion"]'));const _=O.length>0&&"likerSubQuestion"===O[0].getAttribute("data-automation-id");O.forEach(((e,t)=>{if(!$[N[t]])return;const o=`input[data-choice-id="${N[t]}"]`,r=e.querySelector(o);if(r){if("immediate"===n)if(_){const e=r.closest("label");e&&e.click()}else r.click();const t=r.parentElement.querySelector("svg path");if(t)"savemode"===n?(t.style.stroke="#ccc",t.style.strokeWidth="2"):"default"===n&&(t.style.stroke="green",t.style.strokeWidth="2");else{const t=e.querySelector(".text-format-content");t&&("savemode"===n?t.style.color="gray":"default"===n&&(t.style.color="green",t.style.fontWeight="700"))}if(_){const e=r.closest('[data-automation-id="likerOption"]');e&&("savemode"===n?e.style.border="2px solid lightgray":"default"===n&&(e.style.border="2px solid green",e.style.fontWeight="700"))}}}))}}}(e,r.correctAnswer,n,o):console.error("Brak pola 'correctAnswer' w odpowiedzi z backendu:",r)}catch(t){console.error("Błąd podczas wysyłania pytania do ChatGPT:",t),delete e.dataset.alreadyHandled}return n}(o,e)));(await Promise.all(n)).filter((e=>null!==e))}let b=null,x=null,S="default",q=null;function v(){const e=document.querySelector('[data-testid="question-container"]');if(!e)return console.warn("Nie znaleziono kontenera pytania"),null;const t=e.querySelector("#questionText");if(!t)return console.warn("Nie znaleziono elementu tekstu pytania"),null;let o=M(t.textContent.replace(/\n/g," ").replace(/\s+/g," ").trim());const n=e.closest(".quiz-container");if(!n)return console.warn("Nie znaleziono kontenera quizu"),null;const r=n.querySelectorAll(".options-grid .option"),i=[];r.forEach(((e,t)=>{const o=e.querySelector("#optionText");if(o){let e=M(o.textContent.replace(/\n/g," ").replace(/\s+/g," ").trim());i.push({text:e,id:String(t+1)})}else console.warn(`Opcja ${t+1} nie ma elementu #optionText`)}));const s=!!(document.querySelector(".multiple-choice-metadata-title")||document.querySelector('[data-test="multiple-choice-info"]')||document.querySelector(".msq-text")||document.querySelector(".is-msq"));return{question:{text:o},options:i,type:s?"MSQ":"MCQ"}}async function k(){try{await new Promise((e=>{function t(){chrome.storage.local.get("autoMode",(o=>{if(!o.autoMode)return void e();const n=document.querySelector('[data-testid="question-container"]'),r=document.querySelector("#questionText");n&&r?e():setTimeout(t,500)}))}if(document.body)t();else{const e=setInterval((()=>{document.body&&(clearInterval(e),t())}),100)}}))}catch(e){return void console.warn("Timeout podczas oczekiwania na elementy Quizizz",e)}const e=v();if(!e||!e.question?.text)return void console.warn("Nie można pobrać tekstu aktualnego pytania");const t=e.question.text,o=window.location.href;b&&q===t?chrome.storage.local.get(["markingMode","autoMode"],(e=>{S=e.markingMode||"default",e.autoMode?E():C()})):(b=null,q=t,chrome.storage.local.get(["markingMode","userEmail","sessionId","autoMode"],(t=>{S=t.markingMode||"default";const n=t.userEmail,r=t.sessionId,i=!!t.autoMode;if(!r||!n)return void console.error("Brak danych uwierzytelniających");if(!i)return;const s=function(e){try{const t=new URL(e).pathname.split("/"),o=t.indexOf("game");return-1!==o&&o+1<t.length?t[o+1]:e.split("?")[0]}catch(t){return console.error("Błąd przy ekstrakcji ID quizu:",t),e}}(o),a=function(){const e=document.querySelector(".v-popper--theme-tooltip button.room-code");if(e)return e.innerText.replace(/\s+/g,"");try{const e=localStorage.getItem("previousContext");if(e){const t=JSON.parse(e);if(t&&t.game&&t.game.roomCode)return t.game.roomCode}}catch(e){console.error("Error reading from localStorage:",e)}return null}();chrome.runtime.sendMessage({type:"QUERY_CHATGPT_MF",platform:"quizizz",quizId:o,quizSimpleId:s,pin:a,mode:S,userEmail:n,questionData:e},(e=>{e&&e.answer?(b=e.answer.correctAnswer,i&&E()):console.error("❌ Błąd:",e?.error||"Brak odpowiedzi")}))})))}function T(e){return z(e).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim()}setTimeout((function(){chrome.storage.local.get(["failedQuizitQuizzes"],(e=>{if(e.failedQuizitQuizzes)try{const t=JSON.parse(e.failedQuizitQuizzes),o=Date.now(),n=6048e5;let r={},i=!1;for(const[e,s]of Object.entries(t))"boolean"==typeof s?(r[e]={failed:!0,timestamp:o},i=!0):"object"==typeof s&&s.timestamp&&(o-s.timestamp<n?r[e]=s:i=!0);i&&chrome.storage.local.set({failedQuizitQuizzes:JSON.stringify(r)})}catch(e){console.error("Błąd przy czyszczeniu cache:",e)}}))}),5e3);let A={};function E(){C(),A={},x=setInterval((()=>{chrome.storage.local.get("autoMode",(async e=>{if(e.autoMode)try{const e=v();if(!e||!e.question?.text)return void console.warn("Nie można pobrać tekstu aktualnego pytania");const t=e.question.text;if(q!==t)return void await k();b&&function(e){const t=v();if(!t||!t.question?.text)return void console.warn("Nie można pobrać aktualnego pytania (DOM)");const o=t.question.text,n=function(e,t){const o=e.replace(/\s+/g,"");for(const n of t){if(!n.question||!n.question.text){console.warn("Nieprawidłowa struktura pytania:",n);continue}const t=z(n.question.text).trim();if(o===t.replace(/\s+/g,""))return n;const r=T(e),i=T(t);if(r.includes(i)||i.includes(r))return n}return 1===t.length?t[0]:(console.warn("Nie znaleziono dopasowania"),null)}(o,e);if(!n)return void console.warn("Nie znaleziono dopasowania dla pytania:",o);const r=n.answers,i=document.querySelector('[data-testid="question-container"]');if(!i)return void console.warn("Nie znaleziono kontenera pytania");const s=i.closest(".quiz-container");if(!s)return void console.warn("Nie znaleziono kontenera quizu");const a=s.querySelectorAll(".options-grid .option");switch(S){case"immediate":!function(e,t){const o=document.querySelector('[data-testid="question-container"]').closest(".quiz-container").querySelector("textarea.typed-option-input");if(o){const e=Array.isArray(t)&&t.length>0&&t[0].text?z(t[0].text).trim():"";return o.value=e,void o.dispatchEvent(new Event("input",{bubbles:!0}))}const n=document.querySelector('[data-testid="question-container"] #questionText');if(!n)return;const r=T(n.innerText.trim()).substring(0,50);if(A[r])return;const i=[];if(t.forEach((t=>{let o="";if("object"==typeof t&&t.text)o=z(t.text).trim();else if("string"==typeof t)o=z(t).trim();else{if("number"!=typeof t)return void console.warn("Nieznany format odpowiedzi:",t);o=String(t)}let n=[];o.indexOf(",")>-1?n=o.split(",").map((e=>e.trim())):n.push(o),n.forEach((t=>{e.forEach(((e,o)=>{const n=e.querySelector("#optionText");if(!n)return;const r=n.innerText.trim();let s=r===t||T(r)===T(t);s||isNaN(parseInt(t))||(s=o===parseInt(t)-1),s&&i.push(o)}))}))})),i.length>0){i.forEach(((t,o)=>{setTimeout((()=>{try{const o=e[t];o&&o.click()}catch(e){console.error(`Błąd podczas klikania opcji ${t}:`,e)}}),300*o)})),A[r]=i;const t=Object.keys(A);t.length>20&&delete A[t[0]]}}(a,r);break;case"saveMode":!function(e,t){const o=document.querySelector(".options-grid"),n=o&&o.classList.contains("flex-col"),r=document.querySelector('[data-testid="question-container"]')?.closest(".quiz-container");if(!r)return void console.warn("Nie znaleziono kontenera quizu");const i=r.querySelector("textarea.typed-option-input");if(i){const e=Array.isArray(t)&&t.length>0&&t[0].text?z(t[0].text).trim():"";return i.addEventListener("focus",(function(){i.setAttribute("placeholder",e)})),void i.addEventListener("blur",(function(){i.setAttribute("placeholder","")}))}t.forEach((t=>{let o="";if("object"==typeof t&&t.text)o=z(t.text).trim();else if("string"==typeof t)o=z(t).trim();else{if("number"!=typeof t)return void console.warn("Nieznany format odpowiedzi:",t);o=String(t)}e.forEach(((e,t)=>{const r=e.querySelector("#optionText");if(!r)return;const i=r.innerText.trim();let s=i===o||T(i)===T(o);s||isNaN(parseInt(o))||(s=t===parseInt(o)-1),s&&(n?(e.style.boxShadow="0 0 5px 3px rgba(255, 255, 255, 0.2)",e.style.backgroundColor="rgba(255, 255, 255, 0.05)"):e.style.boxShadow="0 0 5px 3px rgba(255, 255, 255, 0.2)")}))}))}(a,r);break;default:!function(e,t){const o=document.querySelector('[data-testid="question-container"]').closest(".quiz-container"),n=o.querySelector("textarea.typed-option-input");if(n){const e=Array.isArray(t)&&t.length>0&&t[0].text?z(t[0].text).trim():"";let r=o.querySelector(".bg-correct-answer");return r||(r=document.createElement("div"),r.classList.add("bg-correct-answer"),r.style.color="green",r.style.fontWeight="700",r.style.marginTop="5px",n.parentElement.appendChild(r)),void(r.textContent=e)}Array.isArray(t)?t.forEach((t=>{let o="";if("object"==typeof t&&t.text)o=z(t.text).trim();else if("string"==typeof t)o=z(t).trim();else{if("number"!=typeof t)return void console.warn("Nieznany format odpowiedzi:",t);o=String(t)}let n=[];o.indexOf(",")>-1?n=o.split(",").map((e=>e.trim())):n.push(o),n.forEach((t=>{let o=!1;e.forEach(((e,n)=>{const r=e.querySelector("#optionText");if(!r)return;const i=r.innerText.trim();let s=i===t;if(!s){const e=T(t);s=T(i)===e}s||isNaN(parseInt(t))||(s=n===parseInt(t)-1),s&&(o=!0,e.style.border="3px solid #2ecc71",e.style.boxShadow="0 0 10px rgba(46, 204, 113, 0.7)",e.style.backgroundColor="rgba(46, 204, 113, 0.2)")})),o||console.warn(`⚠️ Nie znaleziono dopasowania dla backendowej odpowiedzi: "${t}"`)}))})):console.error("correctAnswers nie jest tablicą:",t)}(a,r)}}(b)}catch(e){console.error("Błąd podczas sprawdzania pytania:",e)}else C()}))}),1e3)}function C(){x&&(clearInterval(x),x=null)}function z(e){return e.replace(/<[^>]*>/g,"")}function M(e){return(e=e.replace(/[\u{1D434}-\u{1D44D}]/gu,(e=>String.fromCharCode(e.codePointAt(0)-119860+65)))).replace(/[\u{1D44E}-\u{1D467}]/gu,(e=>String.fromCharCode(e.codePointAt(0)-119886+97)))}async function P(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return new Promise((o=>{if(e.complete&&0!==e.naturalWidth)return o();const n=setTimeout(o,t);e.addEventListener("load",(()=>{clearTimeout(n),o()})),e.addEventListener("error",(()=>{clearTimeout(n),o()}))}))}async function j(e){const t=e.querySelectorAll("img"),o=[];for(const e of t)await P(e),o.push({url:e.src,alt:e.alt||""});return o}function L(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300;const o=Date.now();return new Promise((n=>{!function r(){const i=e.querySelectorAll(".mathml, .katex, [data-math]");if(i.length>0||Date.now()-o>=t){let t="";i.forEach((e=>{e.hasAttribute("data-math")?t+=" "+e.getAttribute("data-math").trim():e.innerText&&e.innerText.trim().length>0&&(t+=" "+e.innerText.trim())}));const o=e.innerHTML,r=/\$(.*?)\$/g;let s;for(;null!==(s=r.exec(o));)s[1]&&s[1].trim().length>0&&(t+=" "+s[1].trim());n(t.trim())}else setTimeout(r,10)}()}))}async function I(e){let t=[];e.querySelector('.uVccjd[role="checkbox"]')?t=e.querySelectorAll('.eBFwI[role="listitem"]'):e.querySelector('.Od2TWd[role="radio"]')?t=e.querySelectorAll(".nWQGrd.zwllIb"):e.querySelector('.MocG8c[role="option"]')?t=e.querySelectorAll('.MocG8c[role="option"]:not(:first-child)'):e.querySelector('.lLfZXe[role="radiogroup"]')&&(t=e.querySelectorAll(".nWQGrd.zwllIb"),0===t.length&&(t=e.querySelectorAll('.lLfZXe[role="radiogroup"] .docssharedWizToggleLabeledContainer'))),t.length;const o=[];for(let e=0;e<t.length;e++){const n=t[e];if(n.classList.contains("vm96I"))continue;let r="";const i=n.querySelector(".aDTYNe, .ulDsOb span"),s=n.querySelector(".aDTYNe.snByac.OvPDhc"),a=n.querySelector(".vRMGwf.oJeWuf");r=i?i.textContent:s?s.textContent:a?a.textContent:n.textContent;const l=await L(n);l&&(r+="\n"+l);const c=await j(n),u="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e]||String(e+1);o.push({id:u,label:r.trim(),images:c})}return o}async function N(e){const t=e.querySelector('input[type="text"]:not([role="combobox"]), textarea'),o=await j(e);return{placeholder:t&&t.placeholder||"Wprowadź odpowiedź",images:o}}function $(){const e={pl:"Poprawna odpowiedź:",en:"Correct answer:",de:"Richtige Antwort:",es:"Respuesta correcta:",fr:"Réponse correcte:",it:"Risposta corretta:",ru:"Правильный ответ:",cs:"Správná odpověď:",sk:"Správna odpoveď:",uk:"Правильна відповідь:"};return e[(navigator.language||navigator.userLanguage).split("-")[0]]||e.en}async function O(e,t){if("true"===e.dataset.alreadyHandled)return null;e.dataset.alreadyHandled="true";const o=await async function(e){const t=function(e){const t=e.querySelector(".M7eMe")?.innerText?.toLowerCase()||"";return t.includes("email")||t.includes("e-mail")||t.includes("imię")||t.includes("imie")||t.includes("nazwisko")||t.includes("name")||t.match(/^\s*name\s*$/i)?"personal":e.querySelector('.lLfZXe[role="radiogroup"]')&&e.querySelector(".V4d7Ke.wzWPxe.OIC90c")&&e.querySelectorAll('.lLfZXe[role="radiogroup"]').length>1?"grid":e.querySelector(".mxSrOe")&&e.querySelectorAll(".q9ZqCb").length>0?"checkboxGrid":e.querySelector(".N9Qcwe")&&e.querySelector('.lLfZXe.fnxRtf.BpKDyb[role="radiogroup"]')?"scale":e.querySelector('.Od2TWd[role="radio"]')?"singleChoice":e.querySelector('.uVccjd[role="checkbox"]')?"multipleChoice":e.querySelector('.jgvuAb[role="listbox"]')||e.querySelector('.MocG8c[role="option"]')?"dropdown":e.querySelector('input[type="date"]')||e.querySelector('[data-includesyear="true"]')?"date":e.querySelector('.ocBCTb[role="group"]')||e.querySelector('[jscontroller="OZjhxc"]')?"time":e.querySelector('input[type="text"]:not([role="combobox"]), textarea')?e.querySelector("textarea")?"longText":"shortText":e.querySelector(".rFrNMe")?"openText":e.querySelector('.lLfZXe[role="radiogroup"]')?"singleChoice":"unknown"}(e);if("personal"===t)return null;const{text:o,images:n}=await async function(e){const t=e.querySelector(".M7eMe");let o="";if(t){o=t.innerText.trim();const e=await L(t);e&&(o+="\n"+e)}const n=e.querySelector(".gubaDc.OIC90c.RjsPE");n&&n.innerText.trim()&&(o+="\n"+n.innerText.trim());const r=await j(e);return r.length,{text:o,images:r}}(e);if(!o&&"grid"!==t&&"checkboxGrid"!==t)return null;let r={id:e.id||`q-${Date.now()}`,text:o,images:n,metadata:{difficulty:"unknown"}};switch(t){case"grid":r.type="likert";const t=await async function(e){const t=['.lLfZXe[role="radiogroup"] .V4d7Ke.wzWPxe.OIC90c',".V4d7Ke.wzWPxe.OIC90c"];let o=[];for(const n of t)if(o=e.querySelectorAll(n),o.length>0)break;const n=[],r=new Set;for(let e=0;e<o.length;e++){const t=o[e].textContent.trim();if(t&&!r.has(t)){r.add(t);const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[n.length]||String(n.length+1);n.push({id:e,text:t})}}const i=e.querySelector(".ssX1Bd.KZt9Tc"),s=i?i.querySelectorAll(".V4d7Ke.OIC90c"):[],a=[];for(let e=0;e<s.length;e++){const t=s[e].textContent.trim();if(t){const o=String(e+1);a.push({id:o,label:t})}}if(0===a.length){const t=e.querySelector('.lLfZXe[role="radiogroup"]');t&&t.querySelectorAll('.Od2TWd[role="radio"]').forEach(((e,t)=>{const o=e.getAttribute("data-value");o&&a.push({id:String(t+1),label:o})}))}return{statements:n,commonOptions:a}}(e);r.statements=t.statements,r.commonOptions=t.commonOptions,r.format={responseType:"matrix",description:"Podaj odpowiedź dla każdego wiersza, wybierając poprawną opcję z kolumny."};break;case"checkboxGrid":r.type="checkboxGrid";const o=await async function(e){const t=[".V4d7Ke.wzWPxe.OIC90c",".V4d7Ke.wzWPxe",".mxSrOe .V4d7Ke.wzWPxe.OIC90c"],o=[],n="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let r=[];for(const o of t)if(r=e.querySelectorAll(o),r.length>0)break;if(0===r.length){const t=e.querySelectorAll(".mxSrOe"),r=[];t.forEach(((e,t)=>{const o=e.querySelector(".wzWPxe")?.textContent.trim();o&&o.length>3&&r.push({element:e,text:o})})),r.forEach(((e,t)=>{const r=n[t]||String(t+1);o.push({id:r,text:e.text})}))}else for(let e=0;e<r.length;e++){const t=r[e].textContent.trim();if(t){const r=n[e]||String(e+1);o.push({id:r,text:t})}}const i=[".ssX1Bd.KZt9Tc .V4d7Ke.OIC90c",".ssX1Bd.KZt9Tc > .V4d7Ke",".V4d7Ke.OIC90c"],s=[];let a=[];for(const t of i){a=e.querySelectorAll(t);const o=a.length>0&&!a[0].textContent.trim()?1:0;if(a.length>o){for(let e=o;e<a.length;e++){const t=a[e].textContent.trim();if(t){const n=String(e-o+1);s.push({id:n,label:t})}}break}}if(0===s.length&&o.length>0){const t=e.querySelector(".mxSrOe"),o=t?t.querySelectorAll('.uVccjd[role="checkbox"]'):[],n=o.length>0?o.length:3;for(let e=0;e<n;e++){const t=String(e+1),o=`Opcja ${t}`;s.push({id:t,label:o})}}return{statements:o,commonOptions:s}}(e);r.statements=o.statements,r.commonOptions=o.commonOptions,r.format={responseType:"checkboxMatrix",description:"Zaznacz odpowiednie opcje dla każdego wiersza, odpowiedź jako obiekt {wiersz: [kolumny]}."};break;case"scale":r.type="scale";const n=await async function(e){const t=[];e.querySelectorAll(".T5pZmf").forEach(((e,o)=>{const n=e.querySelector(".Zki2Ve")?.innerText.trim();n&&t.push({id:String(o+1),label:n})}));const o=e.querySelector(".g4s2gf")?.innerText.trim()||"",n=e.querySelector('[jsname="jq1lEb"]')?.innerText.trim()||"";return{options:t,lowLabel:o,highLabel:n}}(e);r.options=n.options,r.lowLabel=n.lowLabel,r.highLabel=n.highLabel,r.format={responseType:"optionId",description:"Odpowiedz jako numer odpowiadający wartości na skali."};break;case"singleChoice":r.type="singlechoice",r.options=await I(e),r.format={responseType:"optionId",description:"Odpowiedz jako pojedyncza litera odpowiadająca właściwej opcji."};break;case"multipleChoice":r.type="multiple",r.options=await I(e),r.format={responseType:"optionIds",description:'Odpowiedz jako tablica liter odpowiadających właściwym opcjom (np. ["A", "C"]).'};break;case"dropdown":r.type="dropdown",r.options=await async function(e){const t=[],o=e.querySelectorAll('.MocG8c[role="option"]'),n=o.length>0&&o[0].classList.contains("LMgvRb")?1:0;for(let e=n;e<o.length;e++){const r=o[e],i=r.querySelector(".vRMGwf")?.innerText.trim()||"";if(i){const o="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e-n]||String(e-n+1);t.push({id:o,label:i})}}return t}(e),r.format={responseType:"optionId",description:"Odpowiedz jako pojedyncza litera odpowiadająca właściwej opcji z listy rozwijanej."};break;case"date":r.type="date";const i=await async function(e){const t=e.querySelector('input[type="date"]');return{format:t?.placeholder||"YYYY-MM-DD"}}(e);r.format={responseType:"date",description:"Podaj odpowiedź w formacie YYYY-MM-DD.",format:i.format};break;case"time":r.type="time";const s=await async function(e){const t=e.querySelector('[jsname="MKaSrf"] input'),o=e.querySelector('[jsname="QbtXXe"] input');return{format:t&&o?"HH:MM":"unknown"}}(e);r.format={responseType:"time",description:"Podaj odpowiedź w formacie HH:MM.",format:s.format};break;case"shortText":r.type="shortanswer";const a=await N(e);r.options=[],r.placeholder=a.placeholder,r.format={responseType:"text",description:"Podaj krótką, zwięzłą odpowiedź tekstową (max. kilka słów)."};break;case"longText":r.type="longanswer";const l=await N(e);r.options=[],r.placeholder=l.placeholder,r.format={responseType:"text",description:"Podaj wyczerpującą, szczegółową odpowiedź tekstową."};break;case"openText":r.type="shortanswer";const c=await N(e);r.options=[],r.placeholder=c.placeholder;const u=e.querySelector("textarea");r.answerLength=u?"long":"short","long"===r.answerLength?r.format={responseType:"text",description:"Podaj wyczerpującą, szczegółową odpowiedź tekstową."}:r.format={responseType:"text",description:"Podaj krótką, zwięzłą odpowiedź tekstową (max. kilka słów)."};break;default:return null}return r}(e);if(!o)return null;const n="multiple"===o.type;try{const r=await function(e,t){return new Promise(((o,n)=>{chrome.runtime.sendMessage({type:"QUERY_CHATGPT_MF",questionData:e,isMultipleCorrect:t,platform:"googleForms"},(e=>{e&&e.answer?o(e.answer):n("No answer received from ChatGPT.")}))}))}(o,n);return r&&r.correctAnswer?(function(e,t,o,n){n=n.toLowerCase();const r=o.type;if("personal"!==r)if("singlechoice"===r){let r=e.querySelectorAll(".nWQGrd.zwllIb");0===r.length&&(r=e.querySelectorAll('.lLfZXe[role="radiogroup"] .docssharedWizToggleLabeledContainer'));let i=-1;if("string"==typeof t){const e=t.trim().toUpperCase();i=o.options.map((e=>e.id.toUpperCase())).indexOf(e)}if(i>=0&&i<r.length){const e=r[i];if("default"===n){const t=e.querySelector(".Hvn9fb, .RWzxl, .aDTYNe");t&&(t.style.color="green",t.style.fontWeight="700");const o=e.querySelector("img");if(o){const e=o.parentElement;e.style.boxShadow="0 0 10px rgba(0, 128, 0, 0.7)",e.style.border="2px solid rgba(0, 128, 0, 0.7)"}}else if("immediate"===n){const t=e.querySelector('.zJKIV, .Od2TWd[role="radio"], .d7L4fc .Od2TWd');t?t.click():e.click()}else if("savemode"===n){const t=e.querySelector(".Hvn9fb, .RWzxl, .aDTYNe");if(t){const e=t.textContent||t.value||"";if(e.length>0)if(t.dataset.originalText||(t.dataset.originalText=e),void 0!==t.value)t.dataset.originalValue=t.value,t.addEventListener("focus",(function(){this.dataset.originalValue&&(this.value=this.dataset.originalValue)}));else{const o=e.charAt(0),n=e.substring(1);t.textContent="";const r=document.createElement("span");r.style.fontWeight="600",r.textContent=o,t.appendChild(r),t.appendChild(document.createTextNode(n))}}}}}else if("multiple"===r){const r=e.querySelectorAll('.eBFwI[role="listitem"]');let i=[];if(Array.isArray(t)){const e=t.map((e=>e.toUpperCase())),n=o.options.map((e=>e.id.toUpperCase()));e.forEach((e=>{const t=n.indexOf(e);t>=0&&i.push(t)}))}else if("string"==typeof t){const e=t.split(",");for(const t of e){const e=t.trim().toUpperCase(),n=o.options.findIndex((t=>t.id.toUpperCase()===e));n>=0&&i.push(n)}}i.forEach((e=>{if(e>=0&&e<r.length){const t=r[e];if("default"===n){const e=t.querySelector(".Hvn9fb, .RWzxl, .aDTYNe");e&&(e.style.color="green",e.style.fontWeight="700");const o=t.querySelector("img");if(o){const e=o.parentElement;e.style.boxShadow="0 0 10px rgba(0, 128, 0, 0.7)",e.style.border="2px solid rgba(0, 128, 0, 0.7)"}}else if("immediate"===n){const e=t.querySelector('.uVccjd[role="checkbox"]');if(e)e.click();else{const e=t.querySelector("label");e?e.click():t.click()}}else if("savemode"===n){const e=t.querySelector(".Hvn9fb, .RWzxl, .aDTYNe");if(e){const t=e.textContent||e.value||"";if(t.length>0)if(e.dataset.originalText||(e.dataset.originalText=t),void 0!==e.value)e.dataset.originalValue=e.value,e.addEventListener("focus",(function(){this.dataset.originalValue&&(this.value=this.dataset.originalValue)}));else{const o=t.charAt(0),n=t.substring(1);e.textContent="";const r=document.createElement("span");r.style.fontWeight="600",r.textContent=o,e.appendChild(r),e.appendChild(document.createTextNode(n))}}}}}))}else if("shortanswer"===r||"longanswer"===r){const o=e.querySelector('input[type="text"]:not([role="combobox"]), textarea');if(!o)return;const i="textarea"===o.tagName.toLowerCase()||"longanswer"===r;let s=String(t||"");if("shortanswer"===r&&s.length>50&&(s=s.split(/[.,;]|\s+/)[0].trim(),s.length>50&&(s=s.substring(0,50))),"default"===n){const t=$(),n=e.querySelector(".correct-answer-info");n&&n.remove();const r=e.querySelector(".AgroKb"),a=document.createElement("div");a.classList.add("correct-answer-info"),a.style.display="block",a.style.marginTop="10px",a.style.marginBottom="5px",a.style.color="green",a.style.fontWeight="500",a.style.whiteSpace="normal",a.style.overflow="auto",a.style.width="100%",a.style.boxSizing="border-box",a.style.position="relative",a.style.zIndex="10",a.style.padding="8px",a.style.border="1px solid #e0e0e0",a.style.borderRadius="4px",a.style.backgroundColor="#f0f8f0",a.style.fontSize="14px",a.style.lineHeight="1.5",a.style.wordWrap="break-word",i&&(a.style.maxHeight="200px");const l=document.createElement("div");l.style.fontWeight="bold",l.style.marginBottom="4px",l.textContent=t;const c=document.createElement("div");if(c.style.fontFamily="inherit",c.style.whiteSpace="pre-wrap",c.textContent=s,a.appendChild(l),a.appendChild(c),r)r.insertAdjacentElement("afterend",a);else{const t=e.querySelector(".SL4Sz");if(t)t.insertAdjacentElement("beforebegin",a);else{const e=o.closest(".AgroKb, .geS5n");if(e)e.insertAdjacentElement("afterend",a);else{const e=o.closest("div");e&&e.parentElement.appendChild(a)}}}}else if("immediate"===n)o.value=s,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}));else if("savemode"===n){const t=e.querySelector("input, textarea");if(!t)return void console.warn("Savemode: Nie znaleziono pola odpowiedzi w pytaniu");const o=t.getAttribute("placeholder")||"";t.dataset.originalPlaceholder=o;const n=e.querySelector('div[jsname="LwH6nd"]'),r=function(){""===this.value&&(this.placeholder=i&&s.length>50?s.substring(0,50)+"...":s),n&&(n.style.display="none")},a=function(){const e=this.dataset.originalPlaceholder||"";this.placeholder=e,n&&(n.style.display="")},l=function(){""!==this.value?this.placeholder="":document.activeElement===this&&(this.placeholder=i&&s.length>50?s.substring(0,50)+"...":s)};t.saveFocusHandler&&t.removeEventListener("focus",t.saveFocusHandler),t.saveBlurHandler&&t.removeEventListener("blur",t.saveBlurHandler),t.saveInputHandler&&t.removeEventListener("input",t.saveInputHandler),t.saveFocusHandler=r,t.saveBlurHandler=a,t.saveInputHandler=l,t.addEventListener("focus",r),t.addEventListener("blur",a),t.addEventListener("input",l),document.activeElement===t?r.call(t):a.call(t)}}else if("dropdown"===r){const r=e.querySelector('.jgvuAb[role="listbox"]');if(!r)return;let i="";"string"==typeof t&&(i=t.trim().toUpperCase());let s="";if(i&&o.options){const e=o.options.find((e=>e.id.toUpperCase()===i));e&&(s=e.label)}s&&("default"===n?(r.click(),setTimeout((()=>{const e=document.querySelectorAll('.MocG8c[role="option"]');let t=!1;for(const o of e)if(o.textContent.trim()===s){const e=o.querySelector(".vRMGwf");e&&(e.style.color="green",e.style.fontWeight="bold"),t=!0}t&&document.body.click()}),300)):"immediate"===n?(r.click(),setTimeout((()=>{const e=document.querySelectorAll('.MocG8c[role="option"]');for(const t of e)if(t.textContent.trim()===s){t.click();break}}),300)):"savemode"===n&&(r.click(),setTimeout((()=>{const e=document.querySelectorAll('.MocG8c[role="option"]');let t=!1;for(const o of e)if(o.textContent.trim()===s){const e=o.querySelector(".vRMGwf");e&&(e.style.color="#505050",e.style.fontWeight="600"),t=!0}t&&document.body.click()}),300)))}else if("scale"===r){let o;if("string"==typeof t?o=t.trim():"number"==typeof t&&(o=String(t)),!o)return;const r=e.querySelectorAll(".T5pZmf");let i=null;for(const e of r){const t=e.querySelector(".Zki2Ve")?.textContent.trim();if(t===o){i=e;break}}if(i)if("default"===n){const e=i.querySelector(".Zki2Ve");e&&(e.style.color="green",e.style.fontWeight="bold")}else if("immediate"===n){const e=i.querySelector('.Od2TWd[role="radio"]');e?e.click():i.click()}else if("savemode"===n){const e=i.querySelector(".AB7Lab.Id5V1");e&&(e.style.border="2px solid #8f949c")}}else if("date"===r){let o="";if("string"==typeof t){const e=t.match(/(\d{4})[-.\/]?(\d{1,2})[-.\/]?(\d{1,2})/);if(e){const t=e[1],n=e[2].padStart(2,"0"),r=e[3].padStart(2,"0");o=`${t}-${n}-${r}`}else try{const e=new Date(t);if(!isNaN(e.getTime())){const t=e.getFullYear(),n=(e.getMonth()+1).toString().padStart(2,"0"),r=e.getDate().toString().padStart(2,"0");o=`${t}-${n}-${r}`}}catch(e){}}if(!o)return;const r=e.querySelector('input[type="date"]');if(r)if("default"===n){const[t,n,r]=o.split("-"),i=`${r}.${n}.${t}`,s=$(),a=e.closest(".geS5n")||e,l=a.querySelector(".correct-answer-info");l&&l.remove();const c=document.createElement("div");c.classList.add("correct-answer-info"),c.style.background="#f0fff0",c.style.border="1px solid #ddeedd",c.style.borderRadius="4px",c.style.marginTop="10px",c.style.marginBottom="10px",c.style.padding="8px 12px",c.style.width="100%",c.style.boxSizing="border-box",c.style.fontSize="14px",c.style.color="green",c.innerHTML=`\n                    <div style="font-weight: bold; margin-bottom: 4px;">${s}</div>\n                    <div>${i}</div>\n                `;const u=a.querySelector(".SL4Sz");u?u.parentNode.insertBefore(c,u):a.appendChild(c)}else if("immediate"===n)r.value=o,r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}));else if("savemode"===n){const e=r.style.border;r.dataset.originalBorder=e,r.addEventListener("focus",(function(){this.setAttribute("placeholder",o)})),r.addEventListener("blur",(function(){this.removeAttribute("placeholder")}))}}else if("time"===r){let o="",r="";if("string"==typeof t){const e=t.match(/(\d{1,2}):(\d{2})/);e&&(o=e[1].padStart(2,"0"),r=e[2])}if(!o||!r)return;const i=e.querySelector('[jsname="MKaSrf"] input'),s=e.querySelector('[jsname="QbtXXe"] input');if(i&&s)if("default"===n){const t=$(),n=e.closest(".geS5n")||e,i=n.querySelector(".correct-answer-info");i&&i.remove();const s=document.createElement("div");s.classList.add("correct-answer-info"),s.style.background="#f0fff0",s.style.border="1px solid #ddeedd",s.style.borderRadius="4px",s.style.marginTop="10px",s.style.marginBottom="10px",s.style.padding="8px 12px",s.style.width="100%",s.style.boxSizing="border-box",s.style.fontSize="14px",s.style.color="green",s.innerHTML=`\n                    <div style="font-weight: bold; margin-bottom: 4px;">${t}</div>\n                    <div>${o}:${r}</div>\n                `;const a=n.querySelector(".SL4Sz");a?a.parentNode.insertBefore(s,a):n.appendChild(s)}else if("immediate"===n)i.value=o,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})),s.value=r,s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}));else if("savemode"===n){const e=i.style.border,t=s.style.border;i.dataset.originalBorder=e,s.dataset.originalBorder=t,i.addEventListener("focus",(function(){this.setAttribute("placeholder",o)})),i.addEventListener("blur",(function(){this.removeAttribute("placeholder")})),s.addEventListener("focus",(function(){this.setAttribute("placeholder",r)})),s.addEventListener("blur",(function(){this.removeAttribute("placeholder")}))}}else if("checkboxGrid"===r)try{let r={};if("object"!=typeof t||Array.isArray(t)||null===t){if("string"==typeof t)try{const e=JSON.parse(t);"object"==typeof e&&null!==e&&(r=e)}catch(e){}}else r=t.value&&"object"==typeof t.value?t.value:t;const i=e.querySelectorAll(".mxSrOe");o.statements.forEach(((e,t)=>{if(t>=i.length)return;const s=i[t],a=r[e.id];if(!a||!Array.isArray(a))return;const l=s.querySelectorAll('.uVccjd[role="checkbox"]');a.forEach((e=>{let t;if(t=isNaN(parseInt(e))?o.commonOptions.findIndex((t=>t.id.toUpperCase()===e.toUpperCase())):parseInt(e)-1,t>=0&&t<l.length){const e=l[t];"default"===n?e.style.outline="2px solid green":"immediate"===n?e.click():"savemode"===n&&(e.style.outline="1px solid #d7d9db")}}))}))}catch(e){}else if("likert"===r)try{let r={};if(t&&t.value&&"string"==typeof t.value){const e=t.value.split(",").filter((e=>""!==e.trim()));let n={};o.commonOptions&&o.commonOptions.length>0&&o.commonOptions.forEach(((e,t)=>{n[t+1]=e.id})),o.statements.forEach(((t,o)=>{o<e.length&&(r[t.id]=e[o])}))}else if("object"!=typeof t||Array.isArray(t)||null===t){if("string"==typeof t)try{const e=JSON.parse(t);"object"==typeof e&&null!==e&&(r=e)}catch(e){}}else r=t.value&&"object"==typeof t.value?t.value:t;const i=e.querySelectorAll('.lLfZXe[role="radiogroup"]');o.statements.forEach(((e,t)=>{if(t>=i.length)return;const s=i[t],a=r[e.id];if(!a)return;let l=parseInt(a)-1;if(isNaN(l)){const e=o.commonOptions.findIndex((e=>e.id.toUpperCase()===a.toUpperCase()));e>=0&&(l=e)}const c=s.querySelectorAll('.Od2TWd[role="radio"]');if(l>=0&&l<c.length){const e=c[l];if("default"===n){const t=e.querySelector(".AB7Lab.Id5V1");t?t.style.border="3px solid green":e.style.border="3px solid green"}else if("immediate"===n)e.click();else if("savemode"===n){const t=e.querySelector(".AB7Lab.Id5V1");t?t.style.border="2px solid #8f949c":e.style.border="2px solid #8f949c"}}}))}catch(e){}}(e,r.correctAnswer,o,t),o):null}catch(t){return delete e.dataset.alreadyHandled,console.error("Błąd wysyłania pytania do backendu:",t),null}}location.href;let _=!1,F="";function D(e){if(!e)return null;const t=e.getAttribute("style");if(!t)return null;const o=t.match(/background-image\s*:\s*url\s*\(\s*["']?([^"')]+)["']?\s*\)/i);return o?o[1]:null}async function H(e){const t=e.querySelectorAll(".test-option"),o=[],n="ABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let e=0;e<t.length;e++){const r=t[e];let i="",s=[];const a=r.querySelector(".question-option-inner-content");a&&(i=a.innerText.trim());const l=r.querySelector(".question-option-image");if(l){const t=D(l);t&&s.push({url:t,alt:`Option ${n[e]} image`})}const c=n[e]||String(e+1);o.push({id:c,label:i||`Option ${c}`,images:s})}return o}function Q(){let e=!1;const t=function(e){let t;return function(){for(var o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];clearTimeout(t),t=setTimeout((()=>e.apply(this,n)),250)}}((async()=>{if(e||_)return;const t=function(){const e=document.querySelector(".test-content-text-inner"),t=document.querySelectorAll(".test-option");let o=e?e.textContent.trim():"";return t.length>0&&(o+="|OPTIONS|",t.forEach((e=>{const t=e.querySelector(".question-option-inner-content");t&&(o+=t.textContent.trim()+";")}))),o}();if(t&&t!==F){e=!0,F=t;try{await async function(){if(_)return console.log("Przetwarzanie Naurok już aktywne, pomijam."),[];_=!0;try{const{markingMode:t}=await new Promise((e=>{chrome.storage.local.get(["markingMode"],(t=>{e({markingMode:t.markingMode||"default"})}))})),o=document.querySelector('.test-container-inner[ng-show="test.scene == 1"]');if(!o)return console.log("Nie znaleziono kontenera pytania Naurok."),[];(e=o).querySelectorAll(".question-option-inner").forEach((e=>{e.style.border="",e.style.backgroundColor="",e.style.outline=""})),e.querySelectorAll(".question-option-image").forEach((e=>{e.style.border="",e.style.boxShadow="",e.style.outline=""}));const n=100;n>0&&(console.log(`Czekam ${n}ms na załadowanie formularza (można testować mniejsze wartości).`),await new Promise((e=>setTimeout(e,n))));try{const e=await async function(e,t){const o=await async function(e){const t=function(e){return e.querySelector(".question-option-inner[ng-if=\"test.question.type == 'quiz'\"]")?"singleChoice":e.querySelector(".question-option-inner[ng-if=\"test.question.type == 'multiquiz'\"]")?"multipleChoice":"unknown"}(e),{text:o,images:n}=await async function(e){const t=e.querySelector(".test-content-text-inner");let o="";t&&(o=t.innerText.trim());const n=e.querySelector(".test-content-image");let r=[];if(n&&!n.classList.contains("ng-hide")){const e=n.querySelector("img");e&&!e.classList.contains("ng-hide")&&e.src&&r.push({url:e.src,alt:e.alt||""})}return{text:o,images:r}}(e);if(!o&&0===n.length)return console.log("Brak tekstu pytania i obrazków, pomijam budowanie."),null;let r={id:Date.now().toString(),text:o,images:n,metadata:{difficulty:"unknown"}};switch(t){case"singleChoice":r.type="singlechoice",r.options=await H(e),r.format={responseType:"optionId",description:"Odpowiedz jako pojedyncza litera odpowiadająca właściwej opcji."};break;case"multipleChoice":r.type="multiple",r.options=await H(e),r.format={responseType:"optionIds",description:'Odpowiedz jako tablica liter odpowiadających właściwym opcjom (np. ["A", "C"]).'};break;default:return console.log("Nieznany typ pytania:",t),null}return r}(e);if(!o)return null;const n="multiple"===o.type;try{const r=await function(e,t){return new Promise(((o,n)=>{chrome.runtime.sendMessage({type:"QUERY_CHATGPT_MF",questionData:e,isMultipleCorrect:t,platform:"naurok"},(e=>{e&&e.answer?o(e.answer):n("No answer received from ChatGPT.")}))}))}(o,n);return r&&r.correctAnswer?(function(e,t,o,n){const r=o.type;if(n=n.toLowerCase(),"singlechoice"===r){let r=-1;if("string"==typeof t){const e=t.trim().toUpperCase();r=o.options.map((e=>e.id.toUpperCase())).indexOf(e)}const i=e.querySelectorAll(".test-option");if(r>=0&&r<i.length){const e=i[r].querySelector(".question-option-inner");if(e)if("default"===n){e.style.border="3px solid green",e.style.backgroundColor="rgba(0, 128, 0, 0.1)";const t=e.querySelector(".question-option-image");t&&(t.style.boxShadow="0 0 8px 2px rgba(0, 128, 0, 0.5)")}else if("immediate"===n)e.click();else if("savemode"===n){e.style.border="1px solid rgba(0, 128, 0, 0.3)";const t=e.querySelector(".question-option-image");t&&(t.style.border="1px solid rgba(0, 128, 0, 0.2)")}}}else if("multiple"===r){let r=[];if(Array.isArray(t)){const e=t.map((e=>e.toUpperCase())),n=o.options.map((e=>e.id.toUpperCase()));e.forEach((e=>{const t=n.indexOf(e);t>=0&&r.push(t)}))}else if("string"==typeof t){const e=t.split(",");for(const t of e){const e=t.trim().toUpperCase(),n=o.options.findIndex((t=>t.id.toUpperCase()===e));n>=0&&r.push(n)}}const i=e.querySelectorAll(".test-option");r.forEach((e=>{if(e>=0&&e<i.length){const t=i[e].querySelector(".question-option-inner");if(t)if("default"===n){t.style.border="3px solid green",t.style.backgroundColor="rgba(0, 128, 0, 0.1)";const e=t.querySelector(".question-option-image");e&&(e.style.boxShadow="0 0 8px 2px rgba(0, 128, 0, 0.5)")}else if("immediate"===n)t.click();else if("savemode"===n){t.style.border="1px solid rgba(0, 128, 0, 0.3)";const e=t.querySelector(".question-option-image");e&&(e.style.border="1px solid rgba(0, 128, 0, 0.2)")}}}))}}(e,r.correctAnswer,o,t),o):(console.log("Brak poprawnej odpowiedzi z backendu lub odpowiedź niekompletna."),null)}catch(e){return console.error("Błąd wysyłania pytania do backendu:",e),null}}(o,t);return document.body.style.cursor="default",e?[e]:[]}catch(e){return console.error(`Błąd przetwarzania pytania: ${e.message}`),document.body.style.cursor="default",[]}}catch(e){return document.body.style.cursor="default",console.error(`Krytyczny błąd w processNaurok: ${e.message}`),[]}finally{setTimeout((()=>{_=!1}),300)}var e}()}finally{setTimeout((()=>{e=!1}),300)}}})),o=new MutationObserver((()=>{t()})),n=document.querySelector(".test-screen");return n?o.observe(n,{childList:!0,subtree:!0,attributeFilter:["class","style"],characterData:!1}):console.error("Nie znaleziono kontenera .test-screen do obserwacji."),o}let W=location.href;async function B(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return new Promise((o=>{if(e.complete&&0!==e.naturalWidth)return o();const n=setTimeout(o,t);e.addEventListener("load",(()=>{clearTimeout(n),o()})),e.addEventListener("error",(()=>{clearTimeout(n),o()}))}))}async function U(e){const t=e.querySelectorAll("img"),o=[];for(const e of t)await B(e),o.push({url:e.src,alt:e.alt||""});return o}function R(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300;const o=Date.now();return new Promise((n=>{!function r(){const i=e.querySelectorAll(".mathml, .katex, [data-math]");if(i.length>0||Date.now()-o>=t){let t="";i.forEach((e=>{e.hasAttribute("data-math")?t+=" "+e.getAttribute("data-math").trim():e.innerText&&e.innerText.trim().length>0&&(t+=" "+e.innerText.trim())}));const o=e.innerHTML,r=/\$(.*?)\$/g;let s;for(;null!==(s=r.exec(o));)s[1]&&s[1].trim().length>0&&(t+=" "+s[1].trim());n(t.trim())}else setTimeout(r,10)}()}))}async function V(e){let t=[];e.querySelector('input[type="checkbox"]')?t=e.querySelectorAll(".v-test-questions-checkbox-block"):e.querySelector('input[type="radio"]')&&(t=e.querySelectorAll(".v-test-questions-radio-block"));const o=[];for(let e=0;e<t.length;e++){const n=t[e];if(n.classList.contains("vm96I"))continue;let r="";const i=n.querySelector("p");r=i?i.textContent:n.textContent;const s=await R(n);s&&(r+="\n"+s);const a=await U(n),l="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e]||String(e+1);o.push({id:l,label:r.trim(),images:a})}return o}async function G(e){const t=e.querySelector('input[type="text"]:not([role="combobox"]), textarea'),o=await U(e);return{placeholder:t&&t.placeholder||"Wprowadź odpowiedź",images:o}}async function J(e,t){const o=await async function(e){const t=function(e){return e.querySelector('input[type="radio"]')?"singleChoice":e.querySelector('input[type="checkbox"]')?"multipleChoice":e.querySelector('input[type="text"]:not([role="combobox"]), textarea')?"longText":e.querySelector(".a-test-lab-inp input")?"openText":"unknown"}(e);if("personal"===t)return null;const{text:o,images:n}=await async function(e){const t=e.querySelector(".v-test-questions-title p");let o="";if(t){o=t.innerText.trim();const e=await R(t);e&&(o+="\n"+e)}const n=e.querySelector(".v-test-questions-title p img");n&&n.innerText.trim()&&(o+="\n"+n.innerText.trim());const r=await U(e);return r.length,{text:o,images:r}}(e);if(!o&&"grid"!==t&&"checkboxGrid"!==t)return null;let r={id:e.id||`q-${Date.now()}`,text:o,images:n,metadata:{difficulty:"unknown"}};switch(t){case"singleChoice":r.type="singlechoice",r.options=await V(e),r.format={responseType:"optionId",description:"Odpowiedz jako pojedyncza litera odpowiadająca właściwej opcji."};break;case"multipleChoice":r.type="multiple",r.options=await V(e),r.format={responseType:"optionIds",description:'Odpowiedz jako tablica liter odpowiadających właściwym opcjom (np. ["A", "C"]).'};break;case"shortText":r.type="shortanswer";const t=await G(e);r.options=[],r.placeholder=t.placeholder,r.format={responseType:"text",description:"Podaj krótką, zwięzłą odpowiedź tekstową (max. kilka słów)."};break;case"longText":r.type="longanswer";const o=await G(e);r.options=[],r.placeholder=o.placeholder,r.format={responseType:"text",description:"Podaj wyczerpującą, szczegółową odpowiedź tekstową."};break;case"openText":r.type="shortanswer";const n=await G(e);r.options=[],r.placeholder=n.placeholder;const i=e.querySelector("textarea");r.answerLength=i?"long":"short","long"===r.answerLength?r.format={responseType:"text",description:"Podaj wyczerpującą, szczegółową odpowiedź tekstową."}:r.format={responseType:"text",description:"Podaj krótką, zwięzłą odpowiedź tekstową (max. kilka słów)."};break;default:return null}return r}(e);if(!o)return null;const n="multiple"===o.type;try{const r=await function(e,t){return new Promise(((o,n)=>{chrome.runtime.sendMessage({type:"QUERY_CHATGPT_MF",questionData:e,isMultipleCorrect:t,platform:"vseosvita"},(e=>{e&&e.answer?o(e.answer):n("No answer received from ChatGPT.")}))}))}(o,n);return r&&r.correctAnswer?(function(e,t,o,n){n=n.toLowerCase();const r=o.type;if("personal"!==r)if("singlechoice"===r){let o=-1;if("string"==typeof t){const e=t.trim();/^[A-Za-z]$/i.test(e)?o=e.toUpperCase().charCodeAt(0)-65:/^\d+$/.test(e)&&(o=parseInt(e,10))}else"number"==typeof t&&(o=t);const r=e.querySelectorAll('.v-test-questions-radio-block input[type="radio"]');if(o>=0&&o<r.length){const e=r[o],t=e.closest(".v-test-questions-radio-block");if("default"===n){const e=t.querySelector("p");e&&(e.style.color="green",e.style.fontWeight="700");const o=t.querySelector("img");if(o){const e=o.parentElement;e.style.boxShadow="0 0 10px rgba(0, 128, 0, 0.7)",e.style.border="2px solid rgba(0, 128, 0, 0.7)"}}else if("immediate"===n){e.checked=!0;try{const e=t.querySelector("label");e&&e.click()}catch(e){console.error("Błąd podczas kliknięcia label:",e)}try{e.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){console.error("Błąd podczas wywoływania zdarzeń:",e)}}else if("savemode"===n){const e=t.querySelector("p");if(e&&e.textContent){const t=e.textContent;if(t.length>0){e.dataset.originalText||(e.dataset.originalText=t);const o=t.charAt(0),n=t.substring(1);e.textContent="";const r=document.createElement("span");r.style.fontWeight="600",r.textContent=o,e.appendChild(r),e.appendChild(document.createTextNode(n))}}}}else console.error(`Indeks ${o} jest poza zakresem (liczba elementów: ${r.length})`)}else if("multiple"===r){const r=e.querySelectorAll(".v-test-questions-checkbox-block");let i=[];if(Array.isArray(t)){const e=t.map((e=>e.toUpperCase())),n=o.options.map((e=>e.id.toUpperCase()));e.forEach((e=>{const t=n.indexOf(e);t>=0&&i.push(t)}))}else if("string"==typeof t){const e=t.split(",");for(const t of e){const e=t.trim().toUpperCase(),n=o.options.findIndex((t=>t.id.toUpperCase()===e));n>=0&&i.push(n)}}i.forEach((e=>{if(e>=0&&e<r.length){const t=r[e];if("default"===n){const e=t.querySelector(".v-test-questions-radio-block p,.v-test-questions-checkbox-block p");e&&(e.style.color="green",e.style.fontWeight="700");const o=t.querySelector("img");if(o){const e=o.parentElement;e.style.boxShadow="0 0 10px rgba(0, 128, 0, 0.7)",e.style.border="2px solid rgba(0, 128, 0, 0.7)"}}else if("immediate"===n){const e=t.querySelector('input[type="checkbox"]');if(e)e.click();else{const e=t.querySelector("label");e?e.click():t.click()}}else if("savemode"===n){const e=t.querySelector(".v-test-questions-radio-block p,.v-test-questions-checkbox-block p");if(e){const t=e.textContent||e.value||"";if(t.length>0)if(e.dataset.originalText||(e.dataset.originalText=t),void 0!==e.value)e.dataset.originalValue=e.value,e.addEventListener("focus",(function(){this.dataset.originalValue&&(this.value=this.dataset.originalValue)}));else{const o=t.charAt(0),n=t.substring(1);e.textContent="";const r=document.createElement("span");r.style.fontWeight="600",r.textContent=o,e.appendChild(r),e.appendChild(document.createTextNode(n))}}}}}))}else if("shortanswer"===r||"longanswer"===r){const o=e.querySelector('input[type="text"]:not([role="combobox"]), textarea');if(!o)return;const i="textarea"===o.tagName.toLowerCase()||"longanswer"===r;let s=String(t||"");if("shortanswer"===r&&s.length>50&&(s=s.split(/[.,;]|\s+/)[0].trim(),s.length>50&&(s=s.substring(0,50))),"default"===n){const t=function(){const e={pl:"Poprawna odpowiedź:",en:"Correct answer:",de:"Richtige Antwort:",es:"Respuesta correcta:",fr:"Réponse correcte:",it:"Risposta corretta:",ru:"Правильный ответ:",cs:"Správná odpověď:",sk:"Správna odpoveď:",uk:"Правильна відповідь:"};return e[(navigator.language||navigator.userLanguage).split("-")[0]]||e.en}(),n=e.querySelector(".correct-answer-info");n&&n.remove();const r=e.querySelector("input[type=text]"),a=document.createElement("div");a.classList.add("correct-answer-info"),a.style.display="block",a.style.marginTop="10px",a.style.marginBottom="5px",a.style.color="green",a.style.fontWeight="500",a.style.whiteSpace="normal",a.style.overflow="auto",a.style.width="100%",a.style.boxSizing="border-box",a.style.position="relative",a.style.zIndex="10",a.style.padding="8px",a.style.border="1px solid #e0e0e0",a.style.borderRadius="4px",a.style.backgroundColor="#f0f8f0",a.style.fontSize="14px",a.style.lineHeight="1.5",a.style.wordWrap="break-word",a.style.userSelect="text",a.style.webkitUserSelect="text",a.style.MozUserSelect="text",a.style.msUserSelect="text",a.style.setProperty("user-select","text","important"),a.style.setProperty("-webkit-user-select","text","important"),a.style.setProperty("-moz-user-select","text","important"),a.style.setProperty("-ms-user-select","text","important"),i&&(a.style.maxHeight="200px");const l=document.createElement("div");l.style.fontWeight="bold",l.style.marginBottom="4px",l.textContent=t;const c=document.createElement("div");if(c.style.fontFamily="inherit",c.style.whiteSpace="pre-wrap",c.textContent=s,a.appendChild(l),a.appendChild(c),r)r.insertAdjacentElement("afterend",a);else{const t=e.querySelector(".SL4Sz");if(t)t.insertAdjacentElement("beforebegin",a);else{const e=o.closest(".input[type=text], .v-test-question");if(e)e.insertAdjacentElement("afterend",a);else{const e=o.closest("div");e&&e.parentElement.appendChild(a)}}}}else if("immediate"===n)o.value=s,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}));else if("savemode"===n){const t=e.querySelector("input, textarea");if(!t)return void console.warn("Savemode: Nie znaleziono pola odpowiedzi w pytaniu");const o=t.getAttribute("placeholder")||"";t.dataset.originalPlaceholder=o;const n=function(){""===this.value&&(this.placeholder=i&&s.length>50?s.substring(0,50)+"...":s)},r=function(){const e=this.dataset.originalPlaceholder||"";this.placeholder=e},a=function(){""!==this.value?this.placeholder="":document.activeElement===this&&(this.placeholder=i&&s.length>50?s.substring(0,50)+"...":s)};t.saveFocusHandler&&t.removeEventListener("focus",t.saveFocusHandler),t.saveBlurHandler&&t.removeEventListener("blur",t.saveBlurHandler),t.saveInputHandler&&t.removeEventListener("input",t.saveInputHandler),t.saveFocusHandler=n,t.saveBlurHandler=r,t.saveInputHandler=a,t.addEventListener("focus",n),t.addEventListener("blur",r),t.addEventListener("input",a),document.activeElement===t?n.call(t):r.call(t)}}else if("checkboxGrid"===r)try{let r={};if("object"!=typeof t||Array.isArray(t)||null===t){if("string"==typeof t)try{const e=JSON.parse(t);"object"==typeof e&&null!==e&&(r=e)}catch(e){}}else r=t.value&&"object"==typeof t.value?t.value:t;const i=e.querySelectorAll(".mxSrOe");o.statements.forEach(((e,t)=>{if(t>=i.length)return;const s=i[t],a=r[e.id];if(!a||!Array.isArray(a))return;const l=s.querySelectorAll('.uVccjd[role="checkbox"]');a.forEach((e=>{let t;if(t=isNaN(parseInt(e))?o.commonOptions.findIndex((t=>t.id.toUpperCase()===e.toUpperCase())):parseInt(e)-1,t>=0&&t<l.length){const e=l[t];"default"===n?e.style.outline="2px solid green":"immediate"===n?e.click():"savemode"===n&&(e.style.outline="1px solid #d7d9db")}}))}))}catch(e){}else if("likert"===r)try{let r={};if(t&&t.value&&"string"==typeof t.value){const e=t.value.split(",").filter((e=>""!==e.trim()));let n={};o.commonOptions&&o.commonOptions.length>0&&o.commonOptions.forEach(((e,t)=>{n[t+1]=e.id})),o.statements.forEach(((t,o)=>{o<e.length&&(r[t.id]=e[o])}))}else if("object"!=typeof t||Array.isArray(t)||null===t){if("string"==typeof t)try{const e=JSON.parse(t);"object"==typeof e&&null!==e&&(r=e)}catch(e){}}else r=t.value&&"object"==typeof t.value?t.value:t;const i=e.querySelectorAll('.lLfZXe[role="radiogroup"]');o.statements.forEach(((e,t)=>{if(t>=i.length)return;const s=i[t],a=r[e.id];if(!a)return;let l=parseInt(a)-1;if(isNaN(l)){const e=o.commonOptions.findIndex((e=>e.id.toUpperCase()===a.toUpperCase()));e>=0&&(l=e)}const c=s.querySelectorAll('.Od2TWd[role="radio"]');if(l>=0&&l<c.length){const e=c[l];if("default"===n){const t=e.querySelector(".AB7Lab.Id5V1");t?t.style.border="3px solid green":e.style.border="3px solid green"}else if("immediate"===n)e.click();else if("savemode"===n){const t=e.querySelector(".AB7Lab.Id5V1");t?t.style.border="2px solid #8f949c":e.style.border="2px solid #8f949c"}}}))}catch(e){}}(e,r.correctAnswer,o,t),o):null}catch(e){return null}}async function Y(){try{const{markingMode:e}=await new Promise((e=>{chrome.storage.local.get(["markingMode"],(t=>{e({markingMode:t.markingMode||"default"})}))}));let t=document.querySelectorAll(".v-test-go-body");if(0===t.length){const e=[".v-test-go-body",".Qr7Oae"];for(const o of e){const e=document.querySelectorAll(o);if(e.length>0){t=e;break}}}await new Promise((e=>setTimeout(e,1e3)));const o=[];for(let n=0;n<t.length;n++){const r=t[n];await new Promise((e=>setTimeout(e,500)));try{const t=await J(r,e);t&&o.push(t)}catch(e){}}return document.body.style.cursor="default",o}catch(e){return document.body.style.cursor="default",[]}}function X(){const e={platform:"Naurok",scoreEarned:null,scorePossible:null,scorePercentage:null,quizTitle:null,homeworkTitle:null,teacher:null,student:null,dateTime:null,totalQuestions:null,correctAnswersCount:null,incorrectAnswersCount:null,skippedAnswersCount:0,totalTime:null,averageTimePerQuestion:null,questionsScoreRatio:null,questions:[],_rawScoreData:null,_rawPercentageResult:null,_rawAccuracyPercentage:null,error:null},t=document.querySelector(".homework-result-info");if(!t)return e.error="Main content container '.homework-result-info' not found.",e;try{e.quizTitle=t.querySelector(".homework-personal-stat-test")?.innerText.trim()||null;const o=t.querySelector('div[style="font-size:14px; line-height:1.5;"]');if(o){const t=o.querySelectorAll("div");e.homeworkTitle=t[0]?.innerText.replace("ДЗ: ","").trim()||null,e.teacher=t[1]?.innerText.replace("Вчитель: ","").trim()||null,e.student=t[2]?.innerText.replace("Виконав(ла): ","").trim()||null,e.dateTime=t[3]?.innerText.trim()||null}const n=t.querySelector(".homework-personal-stat-number");if(n&&n.firstChild){const t=n.firstChild.textContent.trim();isNaN(parseInt(t))||(e.totalQuestions=parseInt(t))}t.querySelectorAll(".homework-personal-stat-label").forEach(((t,o)=>{const n=t.innerText.trim().toUpperCase();let r=null,i=null,s=null;const a=t.closest('div[class*="col-"]');if(a&&a.nextElementSibling){const e=a.nextElementSibling;r="ТОЧНІСТЬ"===n?e.querySelector(".progress"):e.querySelector(".homework-personal-stat-value"),r&&(i=r.querySelector("span")?.innerText.trim(),s=r.innerText.trim())}if("ОЦІНКА"===n&&r&&i){const t=i.split("/").map((e=>e.trim()));2!==t.length||isNaN(parseInt(t[0]))||isNaN(parseInt(t[1]))?console.warn("Naurok Scraper: Failed to parse 'ОЦІНКА' from spanValue:",i,"Parts:",t):e._rawScoreData={earned:parseInt(t[0]),total:parseInt(t[1]),unit:s.split(/\s+/).pop()}}else if("РЕЗУЛЬТАТ"===n&&r&&i)isNaN(parseFloat(i))?console.warn("Naurok Scraper: Failed to parse 'РЕЗУЛЬТАТ' from spanValue:",i):e._rawPercentageResult=parseFloat(i);else if("ТОЧНІСТЬ"===n&&r){const t=r.querySelector(".progress-bar");if(t&&t.style.width){const o=t.style.width.replace("%","");isNaN(parseFloat(o))?console.warn("Naurok Scraper: Could not parse float from Точність progress bar width:",t.style.width):e._rawAccuracyPercentage=parseFloat(o)}else console.warn("Naurok Scraper: Progress bar or its width not found for 'ТОЧНІСТЬ'. ValueElement was:",r)}}));const r=Array.from(t.querySelectorAll(".homework-personal-stat-row")).filter((e=>!e.querySelector(".homework-personal-stat-label"))),i=r.find((e=>{const t=Array.from(e.querySelectorAll(".homework-personal-stat-value")).map((e=>e.innerText.trim())).join(" ");return t.includes("правильних")&&t.includes("неправильних")}));if(i){const t=i.querySelectorAll(".homework-personal-stat-value"),o=Array.from(t).find((e=>e.innerText.includes("правильних")));if(o){const t=o.querySelector("span")?.innerText.trim();t&&!isNaN(parseInt(t))&&(e.correctAnswersCount=parseInt(t))}const n=Array.from(t).find((e=>e.innerText.includes("неправильних")));if(n){const t=n.querySelector("span")?.innerText.trim();t&&!isNaN(parseInt(t))&&(e.incorrectAnswersCount=parseInt(t))}else e.incorrectAnswersCount=0;const r=Array.from(t).find((e=>e.innerText.includes("пропущено")));if(r){const t=r.querySelector("span")?.innerText.trim();t&&!isNaN(parseInt(t))&&(e.skippedAnswersCount=parseInt(t))}else e.skippedAnswersCount=0}const s=r.find((e=>{const t=Array.from(e.querySelectorAll(".homework-personal-stat-value")).map((e=>e.innerText.trim())).join(" ");return t.includes("Всього часу")&&t.includes("Ср. час / запитання")}));if(s){const t=Array.from(s.querySelectorAll(".homework-personal-stat-value")).find((e=>e.innerText.includes("Всього часу")));t&&(e.totalTime=t.querySelector("span")?.innerText.trim());const o=Array.from(s.querySelectorAll(".homework-personal-stat-value")).find((e=>e.innerText.includes("Ср. час / запитання")));o&&(e.averageTimePerQuestion=o.querySelector("span")?.innerText.trim())}"number"==typeof e.correctAnswersCount&&"number"==typeof e.totalQuestions&&e.totalQuestions>0&&(e.questionsScoreRatio=`${e.correctAnswersCount}/${e.totalQuestions}`),e._rawScoreData&&"number"==typeof e._rawScoreData.earned&&"number"==typeof e._rawScoreData.total&&(e.scoreEarned=e._rawScoreData.earned,e.scorePossible=e._rawScoreData.total),"number"==typeof e._rawPercentageResult?e.scorePercentage=e._rawPercentageResult:"number"==typeof e._rawAccuracyPercentage&&(e.scorePercentage=e._rawAccuracyPercentage),null===e.scorePercentage&&null!==e.scoreEarned&&null!==e.scorePossible&&e.scorePossible>0&&(e.scorePercentage=parseFloat((e.scoreEarned/e.scorePossible*100).toFixed(1))),e.questions=[],document.querySelectorAll(".homework-stats .content-block").forEach(((t,o)=>{const n={},r=t.querySelector(".homework-stat-question-line");if(!r)return;const i=r.querySelector("p");n.questionText=i?i.innerText.trim():`Pytanie ${o+1} (brak tekstu)`;const s=r.innerText.trim().match(/^(\d+)\./);n.questionNumber=s?parseInt(s[1]):o+1,n.options=[],t.querySelectorAll(".homework-stat-option-line").forEach((e=>{const t=e.querySelector(".homework-stat-option-value");if(t){const e=t.querySelector("p"),o=e?e.innerText.trim():"",r=t.classList.contains("correct"),i=!!t.querySelector("em");n.options.push({text:o,isCorrect:r,isUserAnswer:i})}}));const a=t.querySelector(".question-label");n.pointsAwarded=a?a.innerText.trim():"N/A",n.isAnsweredCorrectly=t.classList.contains("success"),e.questions.push(n)}))}catch(t){e.error=`Critical extraction error: ${t.message} at ${t.stack}`}return delete e._rawScoreData,delete e._rawPercentageResult,delete e._rawAccuracyPercentage,e}function K(){const e={platform:"Testportal",testTitle:null,resultPageUrl:window.location.href,respondentIdentifier:null,scorePercentage:null,pointsEarned:null,pointsPossible:null,testStatus:null,timeTaken:null,timeMax:null,startTime:null,endTime:null,date:null,totalQuestionsCountFromHeader:null,questions:[]};try{e.testTitle=document.querySelector(".test-name")?.innerText.trim()||null;const t=Array.from(document.querySelectorAll(".test-card")).find((e=>"Rozwiązujący"===e.querySelector(".test-page-title")?.innerText.trim()));e.respondentIdentifier=t?.querySelector(".mdc-typography--headline4")?.innerText.trim()||null;const o=Array.from(document.querySelectorAll(".result-tile .test-card")).find((e=>"Wynik"===e.querySelector(".test-page-title")?.innerText.trim()));if(o){const t=o.querySelector(".donut-percents");t&&(e.scorePercentage=parseFloat(t.innerText.trim().replace("%",""))||null);const n=o.querySelector(".donut-sub-value");if(n){const t=n.innerText.trim().match(/(\d+)\s*\/\s*(\d+)/);t&&3===t.length&&(e.pointsEarned=parseInt(t[1]),e.pointsPossible=parseInt(t[2]))}e.testStatus=o.querySelector(".test-sheet-summary-header .mdc-typography--headline4")?.innerText.trim()||"Status nieznany"}else{const t=Array.from(document.querySelectorAll(".test-card-body p")).find((e=>e.innerText.toLowerCase().includes("wynik testu jest ukryty")||e.innerText.toLowerCase().includes("wynik będzie dostępny później")));t&&(e.testStatus=t.innerText.trim())}const n=Array.from(document.querySelectorAll(".timer-tile .test-card")).find((e=>"Czas"===e.querySelector(".test-page-title")?.innerText.trim()));n&&(e.timeTaken=n.querySelector(".configuration-progress__text")?.firstChild?.textContent?.trim()||null,e.timeMax=n.querySelector(".configuration-progress__text-total-time")?.innerText.trim().replace("/","").trim()||null,n.querySelectorAll(".timer-tile-properties-container .mdc-property").forEach((t=>{const o=t.querySelector(".mdc-property-label")?.innerText.trim(),n=t.querySelector(".mdc-property-value")?.innerText.trim();"Start"===o&&(e.startTime=n),"Koniec"===o&&(e.endTime=n),"Data"===o&&(e.date=n)})));const r=document.querySelector(".questions-list-top-bar .test-page-title__counter");if(r){const t=r.innerText.trim().match(/\((\d+)\)/);t&&t[1]&&(e.totalQuestionsCountFromHeader=parseInt(t[1]))}document.querySelectorAll(".question-container").forEach(((t,o)=>{const n={questionNumberText:null,questionNumber:o+1,questionTextHTML:null,pointsEarnedForQuestion:null,pointsPossibleForQuestion:null,isAnsweredCorrectly:null,options:[],userAnswerText:null,possibleCorrectAnswersText:[],userSelectedOptionIds:[]};try{n.questionNumberText=t.querySelector(".question_header_content")?.innerText.trim()||`Pyt. ${o+1}`;const e=n.questionNumberText.match(/Pyt\.\s*(\d+)/i);e&&e[1]&&(n.questionNumber=parseInt(e[1])),n.questionTextHTML=t.querySelector(".question_essence")?.innerHTML.trim()||"";const r=t.querySelector('.question-score-marker span[class*="theme-color-"]');if(r){const e=r.innerText.trim().match(/(\d+)\s*\/\s*(\d+)/);e&&3===e.length&&(n.pointsEarnedForQuestion=parseInt(e[1]),n.pointsPossibleForQuestion=parseInt(e[2]),n.isAnsweredCorrectly=n.pointsEarnedForQuestion===n.pointsPossibleForQuestion&&n.pointsPossibleForQuestion>0)}if(null===n.isAnsweredCorrectly){const e=t.querySelector(".question-header--right-panel .question-score-marker span.theme-color-green"),o=t.querySelector(".question-header--right-panel .question-score-marker span.theme-color-error");e?n.isAnsweredCorrectly=!0:o&&(n.isAnsweredCorrectly=!1)}const i=t.querySelector(".question-markers"),s=i?.getAttribute("selectedanswerids");if(s)try{let e=[];s.startsWith("[")?e=JSON.parse(s):s&&(e=[s]),n.userSelectedOptionIds=Array.isArray(e)?e:e?[e]:[]}catch(e){console.warn("Testportal Scraper: Could not parse selectedanswerids JSON:",s,e),s&&(n.userSelectedOptionIds=[s])}const a=t.querySelectorAll(".answer-with-marker");if(a.length>0)a.forEach((e=>{const t={text:e.querySelector(".answer_body p, .answer_body img")?.outerHTML.trim()||e.querySelector(".answer_body")?.innerText.trim()||"",isCorrect:null!==e.querySelector(".answer_container.correct-answer-container")||null!==e.querySelector('i.answer-correctness-mark.correct-answer-color, i.answer-correctness-mark svg[stroke="#0BC279"]'),isUserSelected:!1},o=e.querySelector('input[type="checkbox"], input[type="radio"]');if(o){const e=o.id?.split(":")[1];e&&n.userSelectedOptionIds.includes(e)&&(t.isUserSelected=!0)}n.options.push(t)}));else{const e=t.querySelector(".provided-short-answer p");e&&(n.userAnswerText=e.innerText.trim());const o=t.querySelectorAll(".possible-answer-option--text");o.length>0&&o.forEach((e=>{n.possibleCorrectAnswersText.push(e.innerText.trim())})),null===n.isAnsweredCorrectly&&t.querySelector(".short-provided-answer-review-container i.correct-answer-color")?n.isAnsweredCorrectly=!0:null===n.isAnsweredCorrectly&&t.querySelector(".short-provided-answer-review-container i.wrong-answer-color")&&(n.isAnsweredCorrectly=!1)}}catch(e){console.warn(`Testportal Scraper: Error processing question ${o+1}:`,e,t)}e.questions.push(n)}))}catch(t){e.error=`Extraction failed: ${t.message}`}if(null!==e.totalQuestionsCountFromHeader&&e.questions.length!==e.totalQuestionsCountFromHeader&&console.warn(`Testportal Scraper: Mismatch in question count. Header: ${e.totalQuestionsCountFromHeader}, Found: ${e.questions.length}`),e.totalQuestionsFound=e.questions.length,null===e.pointsEarned&&e.questions.length>0){let t=0,o=0,n=0,r=!0;e.questions.forEach((e=>{!0===e.isAnsweredCorrectly&&t++,"number"==typeof e.pointsEarnedForQuestion&&"number"==typeof e.pointsPossibleForQuestion?(n+=e.pointsEarnedForQuestion,o+=e.pointsPossibleForQuestion):r=!1})),e.calculatedCorrectAnswersCount=t,r&&o>0&&(e.pointsEarned=n,e.pointsPossible=o,o>0&&(e.scorePercentage=parseFloat((n/o*100).toFixed(1))))}return e}function Z(){const e={platform:"Vseosvita",userEmail:null,scrapedAt:null,pageUrl:window.location.href,testTitle:null,testAttemptId:null,respondentIdentifier:null,dateTimeCompleted:null,durationInSeconds:null,scoreEarned:null,scorePossible:null,scorePercentage:null,resultStatus:null,totalQuestions:null,correctAnswersCount:null,incorrectAnswersCount:null,partiallyCorrectAnswersCount:0,skippedAnswersCount:null,questions:[],platformDetails:{vseosvita_dateTimeFullString:null,vseosvita_durationString:null,vseosvita_finalScoreString:null,vseosvita_rawPointsEarned:null,vseosvita_rawPointsPossible:null,vseosvita_pointsFromCorrect:null,vseosvita_partiallyCorrectDetails:[],vseosvita_pointsFromPartiallyCorrect:0,vseosvita_gradingSystemDetails:null,vseosvita_finalGradeCalculationString:null},error:null};try{const t=document.querySelector("div.v-hello-container.type-container-vo[data-v-499098f8]");if(!t)return e.error="Specific main info container not found.",e;if(t.querySelectorAll("div.row_info-test.vertical-center p.text_info-test.silver").forEach((t=>{const o=t.innerText.trim();if(o.toLowerCase().includes("id-код проходження:"))e.testAttemptId=o.replace(/id-код проходження:/i,"").trim();else if(o.match(/\d{1,2}\s+\S+\s+\d{4}\s+року о\s+\d{2}:\d{2}/)){e.platformDetails.vseosvita_dateTimeFullString=o.split("\n")[0].trim();const n=t.querySelector('span[title^="Час витрачений учнем"]');if(n)e.platformDetails.vseosvita_durationString=n.querySelector("span")?.innerText.trim();else{const o=t.querySelector("span[data-v-499098f8] > span[data-v-499098f8]");o&&(e.platformDetails.vseosvita_durationString=o.innerText.trim())}}})),e.platformDetails.vseosvita_dateTimeFullString&&(e.dateTimeCompleted=e.platformDetails.vseosvita_dateTimeFullString),e.platformDetails.vseosvita_durationString){const t=e.platformDetails.vseosvita_durationString.match(/(?:(\d+)\s*год)?\s*(?:(\d+)\s*хв)?\s*(?:(\d+)\s*с)?/);if(t){const o=parseInt(t[1]||0),n=parseInt(t[2]||0),r=parseInt(t[3]||0);e.durationInSeconds=3600*o+60*n+r}}const o=t.querySelector("p.text_info-test.center.vo-mb1");o&&(e.testTitle=o.querySelector("b[data-v-499098f8]")?.innerText.trim()||null);const n=t.querySelector("p.text_info-test.fs36.center.vo-mb2");if(n){const t=n.querySelector("b[data-v-499098f8]");if(t){e.platformDetails.vseosvita_finalScoreString=t.innerText.trim();const o=e.platformDetails.vseosvita_finalScoreString.match(/(\d+[\.,]?\d*)\s+з\s+(\d+[\.,]?\d*)\s+балів(?:\s*\((.+)\))?/i);o&&(e.scoreEarned=parseFloat(o[1]?.replace(",",".")),e.scorePossible=parseFloat(o[2]?.replace(",",".")),o[3]&&(e.resultStatus=o[3].trim()),e.scorePossible>0&&(e.scorePercentage=parseFloat((e.scoreEarned/e.scorePossible*100).toFixed(1))))}}const r=t.querySelector("div.table_answers-test[data-v-4b882196]");if(r){const t=r.querySelector("table[data-v-4b882196]");t&&t.querySelectorAll("tr[data-v-4b882196]").forEach((t=>{const o=t.querySelectorAll("td[data-v-4b882196]");if(o.length<2)return;const n=o[0].querySelector("p.text_info-test > b[data-v-4b882196]"),r=n?.innerText.trim(),i=o[1].querySelector("p.text_info-test");if(r&&i){const t=i.innerText.trim();if(r.startsWith("Всього:")){const o=t.match(/(\d+)\s+запитань/);o&&(e.totalQuestions=parseInt(o[1]))}else if(r.startsWith("Правильно:")){const o=t.match(/(\d+)\s+запитань\s*x\s*[\d\.,]+\s*бал(?:а|ів)?\s*=\s*([\d\.,]+)\s*бал/i);o&&(e.correctAnswersCount=parseInt(o[1]),e.platformDetails.vseosvita_pointsFromCorrect=parseFloat(o[2].replace(",",".")))}else if(r.startsWith("Частково правильно:")){const t=o[1].querySelectorAll("p.text_info-test");e.platformDetails.vseosvita_pointsFromPartiallyCorrect=0,e.partiallyCorrectAnswersCount=0,t.forEach((t=>{const o=t.innerText.trim().match(/(\d+)\s+запитан(?:ня|ь)\s*x\s*([\d\.,]+)\s*бал(?:а|ів)?\s*=\s*([\d\.,]+)\s*бал(?:а|ів)?\s*\(максимум\s*([\d\.,]+)\s*бал/i);if(o){const t={count:parseInt(o[1]),pointsPerQuestion:parseFloat(o[2].replace(",",".")),earnedPoints:parseFloat(o[3].replace(",",".")),maxPointsPerQuestion:parseFloat(o[4].replace(",","."))};e.platformDetails.vseosvita_partiallyCorrectDetails.push(t),e.platformDetails.vseosvita_pointsFromPartiallyCorrect+=t.earnedPoints,e.partiallyCorrectAnswersCount+=t.count}}))}else if(r.startsWith("Неправильно:")){const o=t.match(/(\d+)\s+запитань/);o&&(e.incorrectAnswersCount=parseInt(o[1]))}else if(r.startsWith("Розрахунок балів за відповіді:")){const t=i.querySelector('b[title="Сумарний бал за відповіді"]');if(t){const o=t.innerText.match(/([\d\.,]+)/);o&&(e.platformDetails.vseosvita_rawPointsEarned=parseFloat(o[1].replace(",",".")))}const o=i.querySelector('b[title="Максимальний бал за всі правильні відповіді"]');if(o){const t=o.innerText.match(/([\d\.,]+)/);t&&(e.platformDetails.vseosvita_rawPointsPossible=parseFloat(t[1].replace(",",".")))}}else r.startsWith("Система оцінювання:")?e.platformDetails.vseosvita_gradingSystemDetails=t:r.startsWith("Розрахунок оцінки:")&&(e.platformDetails.vseosvita_finalGradeCalculationString=t)}}))}"number"==typeof e.totalQuestions&&"number"==typeof e.correctAnswersCount&&"number"==typeof e.incorrectAnswersCount&&"number"==typeof e.partiallyCorrectAnswersCount&&(e.skippedAnswersCount=e.totalQuestions-e.correctAnswersCount-e.incorrectAnswersCount-e.partiallyCorrectAnswersCount,e.skippedAnswersCount<0&&(e.skippedAnswersCount=0))}catch(t){e.error=`Extraction failed: ${t.message}`}return e}function ee(){const e={platform:"Quizizz",userEmail:null,scrapedAt:null,pageUrl:window.location.href,testTitle:null,quizMode:null,playerName:null,accuracyPercentage:null,accuracyPointsEarned:null,accuracyPointsPossible:null,rankString:null,gameScore:null,totalQuestions:null,correctAnswersCount:null,incorrectAnswersCount:null,partiallyCorrectAnswersCount:null,avgTimePerQuestionString:null,longestStreak:null,questions:[],platformDetails:{quizizz_gameTypeTitle:null,quizizz_accuracyRawString:null,quizizz_motivationalMessage:null},error:null};try{const t=document.querySelector("div[data-v-5e383631].screen-container");if(!t)return e.error="Main screen container not found.",e;e.platformDetails.quizizz_gameTypeTitle=t.querySelector('.game-type-title[data-cy="game-type-title"]')?.innerText.trim()||null,e.quizMode=e.platformDetails.quizizz_gameTypeTitle,e.playerName=t.querySelector('span[data-testid="player-id-desktop"][data-cy="player-name"]')?.innerText.trim()||null,e.platformDetails.quizizz_motivationalMessage=t.querySelector("div[data-v-b15e54fe].text-ds-light-300.font-bold.text-xl")?.innerText.trim()||null;const o=t.querySelector("div[data-v-b15e54fe].accuracy-info-section");if(o){const t=o.querySelector('.accuracy-label-tooltip .tooltip-text[data-cy="tooltip-text"]');if(t){const o=t.innerText.trim().replace("%","");isNaN(parseFloat(o))||(e.accuracyPercentage=parseFloat(o))}const n=o.querySelector(".accuracy-bar + .show-tooltip .content");if(n){e.platformDetails.quizizz_accuracyRawString=n.innerText.trim();const t=e.platformDetails.quizizz_accuracyRawString.match(/(\d+)\s*\/\s*(\d+)\s*pts/);t&&(e.accuracyPointsEarned=parseInt(t[1]),e.accuracyPointsPossible=parseInt(t[2]),null===e.accuracyPercentage&&e.accuracyPointsPossible>0&&(e.accuracyPercentage=parseFloat((e.accuracyPointsEarned/e.accuracyPointsPossible*100).toFixed(1))))}}e.rankString=t.querySelector('.player-rank[data-cy="player-rank"]')?.innerText.trim()||null;const n=t.querySelector('.player-score[data-cy="player-score"]');n&&(e.gameScore=parseInt(n.innerText.trim().replace(/\s/g,""))||null);const r=t.querySelector(".stats-container");if(r){const t=r.querySelector(".stat-box-big.correct-container .value");t&&(e.correctAnswersCount=parseInt(t.innerText.trim()));const o=r.querySelector(".stat-box-big.partial-container .value");e.partiallyCorrectAnswersCount=o?parseInt(o.innerText.trim()):0;const n=r.querySelector(".stat-box-big.incorrect-container .value");n&&(e.incorrectAnswersCount=parseInt(n.innerText.trim())),e.avgTimePerQuestionString=r.querySelector(".stat-box-big.avg-time-container .value")?.innerText.trim()||null;const i=r.querySelector(".stat-box-big.streak-container .value");i&&(e.longestStreak=parseInt(i.innerText.trim())),"number"==typeof e.correctAnswersCount&&"number"==typeof e.incorrectAnswersCount&&"number"==typeof e.partiallyCorrectAnswersCount&&(e.totalQuestions=e.correctAnswersCount+e.incorrectAnswersCount+e.partiallyCorrectAnswersCount)}const i=t.querySelector(".question-review-list");i&&i.querySelectorAll("button.question-container").forEach((t=>{const o={questionNumber:null,questionText:null,isAnsweredCorrectlyByUser:null,userTypedAnswer:null,optionsDisplayed:[]},n=t.querySelector(".question-text");if(n){const e=n.innerText.trim(),t=e.match(/^(\d+)\.\s*/);t?(o.questionNumber=parseInt(t[1]),o.questionText=e.replace(t[0],"").trim()):o.questionText=e}const r=t.style.borderColor;"rgb(0, 201, 133)"===r?o.isAnsweredCorrectlyByUser=!0:"rgb(239, 60, 105)"===r&&(o.isAnsweredCorrectlyByUser=!1);const i=t.querySelector(".typed-answer-response .response-text span");i?o.userTypedAnswer=i.innerText.trim():t.querySelectorAll(".options-container .option-text p").forEach((e=>{o.optionsDisplayed.push(e.innerText.trim())})),e.questions.push(o)})),null===e.totalQuestions&&e.questions.length>0&&(e.totalQuestions=e.questions.length),null!==e.accuracyPointsEarned&&null!==e.accuracyPointsPossible?(e.scoreEarned=e.accuracyPointsEarned,e.scorePossible=e.accuracyPointsPossible,e.scorePossible>0&&(e.scorePercentage=parseFloat((e.scoreEarned/e.scorePossible*100).toFixed(1)))):null!==e.correctAnswersCount&&null!==e.totalQuestions&&e.totalQuestions>0&&(e.scoreEarned=e.correctAnswersCount,e.scorePossible=e.totalQuestions,e.scorePercentage=parseFloat((e.scoreEarned/e.scorePossible*100).toFixed(1)))}catch(t){e.error=`Extraction failed: ${t.message}`}return e}function te(){const e={platform:"Moodle",userEmail:null,scrapedAt:null,pageUrl:window.location.href,testTitle:null,courseTitle:null,dateTimeStarted:null,dateTimeCompleted:null,duration:null,scoreEarned:null,scorePossible:null,scorePercentage:null,resultStatus:null,totalQuestions:null,correctAnswersCount:0,questions:[],platformDetails:{moodle_marksEarned:null,moodle_marksPossible:null,moodle_rawGradeString:null,moodle_rawMarksString:null,moodle_statusString:null,moodle_durationString:null},error:null},t={status:["Status","Stan"],started:["Started","Rozpoczęto","Date taken"],completed:["Completed","Ukończono","Submitted on","Data oddania"],duration:["Duration","Wykorzystany czas","Time taken","Czas trwania"],marks:["Marks","Points","Punkty"],grade:["Grade","Ocena","Note","Bewertung","Final grade"]};function o(e,o){if(!e)return null;const n=Array.from(e.querySelectorAll("tr"));for(const e of n){const n=e.querySelector("th.cell");if(n){const r=n.innerText.trim();let i=!1;if(Array.isArray(o)){for(const e of o)if(t[e]&&t[e].some((e=>r.toLowerCase().startsWith(e.toLowerCase())))){i=!0;break}}else"string"==typeof o&&r.toLowerCase().startsWith(o.toLowerCase())&&(i=!0);if(i){const t=e.querySelector("td.cell");return t?t.innerText.trim():null}}}return null}try{e.testTitle=document.querySelector("#page-header h1.h2")?.innerText.trim()||document.querySelector("h1#page-title")?.innerText.trim()||document.title.split(":")[0].trim();const t=document.querySelectorAll("#page-navbar .breadcrumb-item a");if(t.length>0&&(e.courseTitle=t[0].innerText.trim(),t.length>1&&e.testTitle===document.title.split(":")[0].trim())){const o=t[t.length-2];o&&!["Preview","Summary","Podgląd","Podsumowanie"].includes(o.innerText.trim())&&(e.testTitle=o.innerText.trim())}const n=document.querySelector("table.generaltable.quizreviewsummary tbody, table.generaltable.generalbox.summarytable tbody");if(n){e.platformDetails.moodle_statusString=o(n,["status"]),e.resultStatus=e.platformDetails.moodle_statusString;const t=o(n,["started"]);t&&(e.dateTimeStarted=oe(t));const r=o(n,["completed"]);if(r&&(e.dateTimeCompleted=oe(r)),e.platformDetails.moodle_durationString=o(n,["duration"]),e.duration=e.platformDetails.moodle_durationString,e.platformDetails.moodle_rawMarksString=o(n,["marks"]),e.platformDetails.moodle_rawMarksString){const t=e.platformDetails.moodle_rawMarksString.match(/([\d\.,]+)\s*\/\s*([\d\.,]+)/);t&&(e.platformDetails.moodle_marksEarned=parseFloat(t[1].replace(",",".")),e.platformDetails.moodle_marksPossible=parseFloat(t[2].replace(",",".")))}if(e.platformDetails.moodle_rawGradeString=o(n,["grade"]),e.platformDetails.moodle_rawGradeString){const t=e.platformDetails.moodle_rawGradeString.match(/([\d\.,]+)\s*(?:out of|z|na)\s*([\d\.,]+)(?:\s*\(([\d\.,]+)%\))?/i);t&&(e.scoreEarned=parseFloat(t[1].replace(",",".")),e.scorePossible=parseFloat(t[2].replace(",",".")),t[3]?e.scorePercentage=parseFloat(t[3].replace(",",".")):e.scorePossible>0&&(e.scorePercentage=parseFloat((e.scoreEarned/e.scorePossible*100).toFixed(1))))}}else console.warn("Moodle Scraper: Summary table not found.");const r=document.querySelectorAll("div.que");e.totalQuestions=r.length,r.forEach(((t,o)=>{const n={questionNumber:o+1,questionTextHTML:null,isAnsweredCorrectly:null,pointsEarned:null,pointsPossible:null,options:[],userAnswerText:[],correctAnswerText:null,platformDetails:{moodle_state:null,moodle_gradeString:null}};try{const o=t.querySelector(".info .no .qno");if(o&&(n.questionNumber=parseInt(o.innerText.trim())),n.platformDetails.moodle_state=t.querySelector(".info .state")?.innerText.trim()||null,n.platformDetails.moodle_state){const e=n.platformDetails.moodle_state.toLowerCase();e.includes("correct")||e.includes("poprawna")?n.isAnsweredCorrectly=!0:e.includes("incorrect")||e.includes("niepoprawna")?n.isAnsweredCorrectly=!1:(e.includes("partially correct")||e.includes("częściowo poprawna"))&&(n.isAnsweredCorrectly="partial")}if(n.platformDetails.moodle_gradeString=t.querySelector(".info .grade")?.innerText.trim()||null,n.platformDetails.moodle_gradeString){const t=n.platformDetails.moodle_gradeString.match(/([\d\.,]+)\s*(?:out of|z)\s*([\d\.,]+)/i);t&&(n.pointsEarned=parseFloat(t[1].replace(",",".")),n.pointsPossible=parseFloat(t[2].replace(",",".")),!0===n.isAnsweredCorrectly&&n.pointsEarned>0&&e.correctAnswersCount++)}n.questionTextHTML=t.querySelector(".content .formulation .qtext")?.innerHTML.trim()||null;const r=t.querySelector(".content .formulation .ablock, .content .formulation .answer");r&&(r.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach((e=>{const t=e.closest('div[class^="r"]');let o="";const r=document.querySelector(`label[for="${e.id}"]`)||e.nextElementSibling;if(r){const e=r.querySelector(".flex-fill");o=e?e.innerText.trim():r.innerText.trim().replace(/^[a-z]\.\s*/i,"").trim()}else o=e.value;let i=!1;t&&(t.classList.contains("correct")||t.querySelector("i.text-success"))&&(i=!0),n.options.push({text:o,isUserSelected:e.checked,isCorrect:i}),e.checked&&n.userAnswerText.push(o)})),r.querySelectorAll("select").forEach((e=>{const t=e.options[e.selectedIndex];if(t&&"0"!==t.value){const o=e.closest("tr")?.querySelector("td.text")?.innerText.trim();n.userAnswerText.push(`${o||"Item"}: ${t.text.trim()}`);const r=e.nextElementSibling?.matches("i.text-success");n.options.push({text:`${o||"Item"} -> ${t.text.trim()}`,isUserSelected:!0,isCorrect:!!r})}})),r.querySelectorAll('input[type="text"].form-control, textarea.form-control').forEach((e=>{n.userAnswerText.push(e.value.trim())})));const i=t.querySelector(".outcome .feedback .rightanswer");if(i){let e=i.cloneNode(!0);e.querySelectorAll("p:first-child").forEach((e=>{e.innerText.toLowerCase().match(/^(the correct answer is:|poprawna odpowiedź to:|prawidłowymi odpowiedziami są:)/i)&&e.remove()})),n.correctAnswerText=e.innerText.trim().replace(/\n\s*\n/g,"\n").trim()}}catch(e){console.warn(`Moodle Scraper: Error processing question ${n.questionNumber}:`,e,t)}e.questions.push(n)})),e.totalQuestions>0&&0===e.correctAnswersCount&&e.questions.some((e=>!0===e.isAnsweredCorrectly))&&(e.correctAnswersCount=e.questions.filter((e=>!0===e.isAnsweredCorrectly)).length)}catch(t){e.error=`Extraction failed: ${t.message}`}return e}function oe(e){return e||null}async function ne(e){const t=window.location.href;let o=null,n=null;if(t.includes("naurok.com.ua/test/complete")?document.querySelector(".homework-result-page")&&(o="Naurok",n=X):t.includes("testportal.pl/exam/test-result.html")||t.includes("testportal.net/test-result/")?document.querySelector(".test-page-container")&&(o="Testportal",n=K):t.includes("vseosvita.ua")&&(document.querySelector(".vo-container")||document.querySelector("div.v-hello-container"))?(o="Vseosvita",n=Z):t.includes("quizizz.com")&&t.includes("page=summary")?(document.querySelector("div[data-v-5e383631].screen-container")||document.querySelector(".screen-summary")||document.querySelector(".summary-container"))&&(o="Quizizz",n=ee):(document.querySelector("body#page-mod-quiz-review")||t.includes("/mod/quiz/review.php")&&document.querySelector(".quizreviewsummary"))&&(o="Moodle",n=te),o&&n){const r=n();if(r&&Object.keys(r).length>(r.platform?1:0)){r.pageUrl||(r.pageUrl=t),r.scrapedAt=(new Date).toISOString(),r.userEmail=e;const n=function(e,t){let o=[t];switch(t){case"Naurok":e.quizTitle&&o.push(e.quizTitle),e.student&&o.push(e.student),e.dateTime&&o.push(e.dateTime),e.score&&void 0!==e.score.earned&&void 0!==e.score.total&&o.push(`s:${e.score.earned}/${e.score.total}`);break;case"Testportal":e.testTitle&&o.push(e.testTitle),e.respondentIdentifier&&o.push(e.respondentIdentifier),e.endTime&&o.push(e.endTime),e.date&&o.push(e.date),null!==e.scorePercentage&&o.push(`p:${e.scorePercentage}`),null!==e.pointsEarned&&null!==e.pointsPossible&&o.push(`pts:${e.pointsEarned}/${e.pointsPossible}`);break;case"Vseosvita":e.testAttemptId?o.push(e.testAttemptId):(e.testTitle&&o.push(e.testTitle),e.dateTimeCompleted&&o.push(e.dateTimeCompleted),null!==e.scoreEarned&&null!==e.scorePossible&&o.push(`s:${e.scoreEarned}/${e.scorePossible}`));break;case"Quizizz":e.playerName&&o.push(e.playerName),null!==e.gameScore&&o.push(`gs:${e.gameScore}`),e.quizMode&&o.push(e.quizMode),null!==e.accuracyPointsEarned&&null!==e.accuracyPointsPossible&&o.push(`acc:${e.accuracyPointsEarned}/${e.accuracyPointsPossible}`),o.length<3&&e.pageUrl&&o.push(e.pageUrl.split("?")[0].split("#")[0]);break;case"Moodle":const t=new URLSearchParams(e.pageUrl.split("?")[1]),n=t.get("attempt")||t.get("cmid");n&&o.push(`att:${n}`),e.testTitle&&o.push(e.testTitle),e.dateTimeCompleted&&o.push(e.dateTimeCompleted),null!==e.scoreEarned&&null!==e.scorePossible&&o.push(`s:${e.scoreEarned}/${e.scorePossible}`);break;default:e.testTitle&&o.push(e.testTitle),e.pageUrl&&o.push(e.pageUrl.split("?")[0].split("#")[0]),null!==e.scoreEarned&&null!==e.scorePossible&&o.push(`s:${e.scoreEarned}/${e.scorePossible}`)}if(o.length<3&&(null!==e.totalQuestions?o.push(`tq:${e.totalQuestions}`):e.questions&&e.questions.length>0&&o.push(`qcnt:${e.questions.length}`),e.questions&&e.questions.length>0&&(e.questions[0].questionText||e.questions[0].questionTextHTML))){const t=String(e.questions[0].questionText||e.questions[0].questionTextHTML).substring(0,30);o.push(`fq:${t}`)}return o.join("|").replace(/\s+/g,"_").replace(/[^\w\|\.\-]/g,"")}(r,o),i=`quizonator_sent_${n}`;if(sessionStorage.getItem(i))return;chrome.runtime.sendMessage({type:"QUIZ_DATA",payload:r},(e=>{chrome.runtime.lastError||sessionStorage.setItem(i,"true")}))}}}function re(e){return e.replace(/<(span\b[^>]*|b|strong)>([A-Za-zĄĆĘŁŃÓŚŹŻąćęłńóśźż])<\/\1>/g,"$2")}new MutationObserver((()=>{location.href!==W&&(W=location.href,setTimeout((()=>{processGoogleForms().then((e=>{})).catch((e=>{}))}),2e3))})).observe(document,{subtree:!0,childList:!0}),"complete"===document.readyState?setTimeout(Y,2e3):document.addEventListener("DOMContentLoaded",(function(){setTimeout(Y,2e3)}));class ie{constructor(){this.isVisible=!0,this.changedElements=new Map,this.svgElements=new Map,this.addedElements=new Map,this.changedClasses=new Map,this.observer=null,this.observeConfig={attributes:!0,attributeOldValue:!0,attributeFilter:["style","class"],childList:!0,subtree:!0},this.setupKeyboardShortcut(),this.injectStyles(),chrome.storage.sync.get({domTogglerVisible:!0},(e=>{this.isVisible=e.domTogglerVisible,this.scanExistingChanges(),this.startObserving(),this.isVisible||this.hideChanges()}))}pauseObserver(){this.observer&&this.observer.disconnect()}resumeObserver(){this.observer&&this.observer.observe(document.body,this.observeConfig)}saveVisibility(){chrome.storage.sync.set({domTogglerVisible:this.isVisible})}hideJustAdded(e,t){switch(t.type){case"style":case"border":case"outline":t.originalStyle?e.setAttribute("style",t.originalStyle):e.removeAttribute("style"),e.style.setProperty("font-weight","normal","important");break;case"class":e.className=t.originalClass;break;case"svg":t.originalStyle?e.setAttribute("style",t.originalStyle):e.removeAttribute("style");break;case"savemode-text":e.innerHTML=t.originalHTML;break;case"added":e.setAttribute("style",(e.getAttribute("style")||"")+"; display: none !important;")}}isTrackedStyle(e){return e.includes("color: green")||e.includes("#4CAF50")||e.includes("rgb(76, 175, 80)")||/font-weight\s*:\s*(bold|[67]00)/.test(e)||/color:\s*rgb\(153,\s*151,\s*151\)/.test(e)||/color:\s*rgb\(211,\s*211,\s*211\)/.test(e)||e.includes("#999797")||e.includes("#D3D3D3")||e.includes("#A9A9A9")||e.includes("rgb(169, 169, 169)")}isAnswerElement(e){const t=e.getAttribute("style")||"",o=e.textContent||"";return e.classList?.contains("correct-answer-info")||e.classList?.contains("correct-answer-date-info")||(t.includes("#4CAF50")||t.includes("rgb(76, 175, 80)"))&&t.includes("font-weight")||o.includes("Poprawna odpowiedź")||o.includes("Correct answer")}isFirstLetterBoldTag(e){return e&&["B","STRONG"].includes(e.tagName)&&1===e.textContent.length}isSavemodeSpan(e){if(!e||"SPAN"!==e.tagName||1!==e.textContent.length)return!1;const t=e.style.fontWeight||getComputedStyle(e).fontWeight;return"bold"===t||"600"===t||"700"===t||parseInt(t,10)>=600}scanExistingChanges(){document.querySelectorAll('\n        [style*="color: green"], [style*="#4CAF50"], [style*="rgb(76, 175, 80)"],\n        [style*="font-weight: 600"], [style*="font-weight:700"], [style*="font-weight: bold"],\n        [style*="#999797"], [style*="#D3D3D3"], [style*="#A9A9A9"],\n        [style*="rgb(169, 169, 169)"], [style*="rgb(153, 151, 151)"], [style*="rgb(211, 211, 211)"]\n      ').forEach((e=>{this.changedElements.has(e)||this.changedElements.set(e,{originalStyle:e.dataset.originalStyle||"",modifiedStyle:e.getAttribute("style")||"",type:"style"})})),document.querySelectorAll("b,strong").forEach((e=>{if(!this.isFirstLetterBoldTag(e))return;const t=e.closest("label,.YEVVod,.SG0AAe,p,pre,div")||e.parentElement;t&&!this.changedElements.has(t)&&(t.dataset.originalText||(t.dataset.originalText=re(t.innerHTML)),this.changedElements.set(t,{originalHTML:t.dataset.originalText,modifiedHTML:t.innerHTML,type:"savemode-text"}))})),document.querySelectorAll("*").forEach((e=>{const t=e.getAttribute("style")||"";!/rgb\( ?7?6?, ?17?5?, ?8?0 ?\)/.test(getComputedStyle(e).color)||t.includes("color")||this.changedClasses.has(e)||(e.dataset.originalClass=e.className,this.changedClasses.set(e,{originalClass:e.className,modifiedClass:e.className,type:"class"}))})),document.querySelectorAll(".correct-answer-info,.correct-answer-date-info").forEach((e=>{this.addedElements.has(e)||this.addedElements.set(e,{originalDisplay:getComputedStyle(e).display,inlineStyles:e.getAttribute("style")||"",className:e.className,innerHTML:e.innerHTML,type:"added"})})),document.querySelectorAll('svg path[style*="stroke"],svg path[style*="stroke-width"]').forEach((e=>{const t=e.getAttribute("style")||"";/stroke.*green|stroke-width:\s*2|stroke:\s*#ccc|rgb\(204, 204, 204\)/.test(t)&&this.svgElements.set(e,{originalStyle:"",modifiedStyle:t,type:"svg"})}))}toggle(){this.isVisible=!this.isVisible,this.saveVisibility(),this.isVisible?this.showChanges():this.hideChanges(),this.showNotification(this.isVisible?"Odpowiedzi pokazane":"Odpowiedzi ukryte")}hideChanges(){this.pauseObserver(),this.changedElements.forEach(((e,t)=>{"savemode-text"===e.type?(t.dataset.togglerModifiedHtml||(t.dataset.togglerModifiedHtml=t.innerHTML),t.innerHTML=e.originalHTML):["style","border","outline"].includes(e.type)&&(t.dataset.togglerModifiedStyle||(t.dataset.togglerModifiedStyle=t.getAttribute("style")||""),e.originalStyle?t.setAttribute("style",e.originalStyle):t.removeAttribute("style"),t.style.setProperty("font-weight","normal","important"))})),this.changedClasses.forEach(((e,t)=>{t.dataset.togglerModifiedClass||(t.dataset.togglerModifiedClass=t.className),t.className=e.originalClass})),this.svgElements.forEach(((e,t)=>{t.dataset.togglerModifiedStyle||(t.dataset.togglerModifiedStyle=t.getAttribute("style")||""),e.originalStyle?t.setAttribute("style",e.originalStyle):t.removeAttribute("style")})),this.addedElements.forEach(((e,t)=>{t.dataset.togglerSavedStyles||(t.dataset.togglerSavedStyles=t.getAttribute("style")||""),t.setAttribute("style",t.dataset.togglerSavedStyles+"; display: none !important;")})),this.resumeObserver()}showChanges(){this.pauseObserver(),this.changedElements.forEach(((e,t)=>{"savemode-text"===e.type?t.innerHTML=t.dataset.togglerModifiedHtml||e.modifiedHTML:["style","border","outline"].includes(e.type)&&t.setAttribute("style",t.dataset.togglerModifiedStyle||e.modifiedStyle)})),this.changedClasses.forEach(((e,t)=>{t.className=t.dataset.togglerModifiedClass||e.modifiedClass})),this.svgElements.forEach(((e,t)=>{t.setAttribute("style",t.dataset.togglerModifiedStyle||e.modifiedStyle)})),this.addedElements.forEach(((e,t)=>{const o=t.dataset.togglerSavedStyles||e.inlineStyles;t.setAttribute("style",o.replace(/;\s*display\s*:\s*none\s*!important/gi,""))})),this.resumeObserver()}startObserving(){this.observer||(this.observer=new MutationObserver((e=>{return t=()=>{e.forEach((e=>{if("attributes"===e.type&&"style"===e.attributeName){const t=e.target,o=t.getAttribute("style")||"";if(t.dataset.originalStyle||null===e.oldValue||(t.dataset.originalStyle=e.oldValue),"path"===t.tagName&&"svg"===t.parentElement?.tagName&&/stroke.*green|stroke-width:\s*2|stroke:\s*#ccc|rgb\(204, 204, 204\)/.test(o)){if(!this.svgElements.has(t)){const n={originalStyle:t.dataset.originalStyle||e.oldValue||"",modifiedStyle:o,type:"svg"};this.svgElements.set(t,n),this.isVisible||this.hideJustAdded(t,n)}}else if((this.isTrackedStyle(o)||/border:\s*(1|2|3)px/.test(o)||/outline:\s*green/.test(o))&&!this.changedElements.has(t)){const n=/border/.test(o)?"border":/outline/.test(o)?"outline":"style",r={originalStyle:t.dataset.originalStyle||e.oldValue||"",modifiedStyle:o,type:n};this.changedElements.set(t,r),this.isVisible||this.hideJustAdded(t,r)}}"childList"===e.type&&e.addedNodes.forEach((e=>{if(1===e.nodeType){if(this.isAnswerElement(e)){const t={originalDisplay:"block",inlineStyles:e.getAttribute("style")||"",className:e.className,innerHTML:e.innerHTML,type:"added"};return this.addedElements.set(e,t),void(this.isVisible||this.hideJustAdded(e,t))}if(this.isFirstLetterBoldTag(e)||this.isSavemodeSpan(e)){const t=e.closest("label,.YEVVod,.SG0AAe,p,pre,div")||e.parentElement;if(!t||this.changedElements.has(t))return;const o={originalHTML:re(t.innerHTML),modifiedHTML:t.innerHTML,type:"savemode-text"};this.changedElements.set(t,o),this.isVisible||this.hideJustAdded(t,o)}}}))}))},clearTimeout(t.t),void(t.t=setTimeout(t,40));var t})),this.resumeObserver())}setupKeyboardShortcut(){document.addEventListener("keydown",(e=>{(e.ctrlKey||e.metaKey)&&e.shiftKey&&"Space"===e.code&&(e.preventDefault(),this.toggle())}))}injectStyles(){if(document.getElementById("sc-toggle-styles"))return;const e=document.createElement("style");e.id="sc-toggle-styles",e.textContent='.sc-notification{position:fixed;top:5px;right:5px;background:rgba(0,0,0,.82);color:#fff;padding:3px 5px;border-radius:2px;font-size:10px;z-index:999999;transition:opacity .3s;pointer-events:none}.sc-notification.fade-out{opacity:0}[style*="display: none !important"]{display:none!important}',document.head.appendChild(e)}showNotification(e){const t=document.createElement("div");t.className="sc-notification",t.textContent=e,document.body.appendChild(t),setTimeout((()=>{t.classList.add("fade-out"),setTimeout((()=>t.remove()),300)}),1800)}}window.domToggler=new ie,function e(){"loading"!==document.readyState?setTimeout((()=>{window.domToggler=new ie,window.domObserver=window.domToggler?.startObserving(),setTimeout((()=>{window.domToggler.scanExistingChanges()}),1e3)}),500):document.addEventListener("DOMContentLoaded",e)}();let se,ae,le={isAutoModeEnabled:!1,isProcessing:!1,quizHandled:!1,observers:{main:null,dynamic:null},platform:{lastQuizSignature:null,lastFirstQuestionId:null,firstQuestionStaticTitle:null,formsHandled:!1,processedElementIds:new Set,processedQuestionsContent:new Map},lastUrl:window.location.href};function ce(){let e=0,t=0,o=!1;var n;document.addEventListener("keydown",(e=>{"Control"===e.key&&(o=!0)})),document.addEventListener("keyup",(t=>{"Control"===t.key&&(o=!1,e=0)})),document.addEventListener("click",(n=>{if(0===n.button&&o){const o=(new Date).getTime();o-t>500?e=1:e++,t=o,3===e&&(chrome.runtime.sendMessage({action:"selfDestruct"}),n.preventDefault(),n.stopPropagation())}})),we((()=>console.log("KaTeX loaded"))),chrome.runtime.onMessage.addListener(((e,t,o)=>{if("initiateScreenshot"===e.action)Ie(),Le(),se=document.createElement("div"),se.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.5);\n        z-index: 10000;\n        cursor: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='12' y1='2' x2='12' y2='22'/%3E%3Cline x1='2' y1='12' x2='22' y2='12'/%3E%3C/svg%3E\") 16 16, crosshair;\n    ",ae=document.createElement("div"),ae.style.cssText="\n        position: absolute;\n        border: 2px solid #fff;\n        background: rgba(255, 255, 255, 0.1);\n        display: none;\n    ",se.appendChild(ae),document.body.appendChild(se),se.addEventListener("mousedown",ze),se.addEventListener("mousemove",Me),se.addEventListener("mouseup",Pe),document.addEventListener("keydown",Ce);else if("displayAnalysis"===e.action)e.analysis&&(n=e.analysis,document.querySelector("#ai-analysis-popup")||we((function(){const e=document.createElement("div");e.id="ai-analysis-popup",e.style.cssText="\n            position: fixed;\n            top: 50px;\n            left: 50px;\n            width: 400px;\n            max-height: 600px;\n            background-color: #f0f8ff;\n            border: 2px solid #4169e1;\n            border-radius: 10px;\n            padding: 15px;\n            z-index: 10000;\n            overflow: hidden; \n            box-shadow: 0 4px 15px rgba(65, 105, 225, 0.3);\n            font-family: Arial, sans-serif;\n            color: #333;\n            cursor: move;\n        ";const t=document.createElement("div");t.style.cssText="\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 10px;\n            user-select: none;\n        ";const o=document.createElement("h3");o.textContent="Odpowiedź AI",o.style.cssText="\n            margin: 0;\n            color: #4169e1;\n            font-size: 18px;\n            font-weight: semi-bold;\n        ";const r=document.createElement("button");r.textContent="✕",r.style.cssText="\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n            color: #4169e1;\n        ",r.onclick=()=>document.body.removeChild(e);const i=document.createElement("div");i.style.cssText="\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-top: 15px;\n            width: 100%; /* Daje pełną szerokość kontenera */\n        ";const s=document.createElement("div");s.style.cssText="\n            display: flex;\n            gap: 10px; /* Odstęp między przyciskami */\n        ";const a=document.createElement("div");a.style.cssText="\n            display: flex;\n            gap: 10px; /* Odstęp między przyciskami */\n        ";const l=document.createElement("button");l.style.cssText="\n            display: flex;\n            align-items: center;\n            background: none;\n            border: none;\n            font-size: 16px;\n            cursor: pointer;\n            padding: 8px;\n        ",l.innerHTML='\n            <svg id="copyIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">\n            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>\n            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>\n            </svg>\n        \n        ',l.onclick=()=>{const e=document.querySelector("#ai-analysis-popup");if(e){const t=e.querySelector(".popup-content"),o=t?t.textContent.trim():"";navigator.clipboard.writeText(o).then((()=>{const e=document.getElementById("copyIcon");e&&(e.innerHTML='<path d="M20 6L9 17l-5-5"></path>',e.setAttribute("id","checkIcon"),setTimeout((()=>{e.innerHTML='\n                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>\n                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>\n                            ',e.setAttribute("id","copyIcon"),e.style.width="24px",e.style.height="24px",e.style.overflow="visible"}),2e3))})).catch((e=>{console.error("Failed to copy text: ",e)}))}};const c=document.createElement("button");c.style.cssText="\n            display: flex;\n            align-items: center;\n            background: none;\n            border: none;\n            font-size: 24px;\n            cursor: pointer;\n        ",c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>',c.onclick=()=>{xe(),chrome.runtime.sendMessage({action:"regenerateAnalysis"},(e=>{e&&e.success||(console.error("Error regenerating analysis:",e?.error),Se())}))};const u=document.createElement("button");u.style.cssText="\n            display: flex;\n            align-items: center;\n            background: none;\n            border: none;\n            font-size: 24px;\n            cursor: pointer;\n            transition: transform 0.2s ease, color 0.3s ease;\n        ",u.id="thumbsUpButton",u.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"/></svg>',u.onclick=()=>{Ne(!0),p(),m(u,!0)};const d=document.createElement("button");function p(){u.disabled=!0,u.style.cursor="default",d.disabled=!0,d.style.cursor="default"}function m(e,t){e.style.transform="scale(1.2)",e.style.color=t?"#45ba4f":"#f87171",setTimeout((()=>{e.style.transform="scale(1)"}),300)}function y(e){return/\\\(|\\\[|\$\$/.test(e)?e=(e=(e=(e=e.replace(/\\\[([\s\S]+?)\\\]/g,(function(e,t){return`<div style="margin: 16px 0; text-align: center;">${be(t,!0)}</div>`}))).replace(/\$\$([\s\S]+?)\$\$/g,(function(e,t){return`<div style="margin: 16px 0; text-align: center;">${be(t,!0)}</div>`}))).replace(/\\\((.+?)\\\)/g,(function(e,t){return`<span style="margin-left: 4px; margin-right: 4px;">${be(t,!1)}</span>`}))).replace(/(?:^|\n)([^$\n]+)(?:\n|$)/g,(function(e,t){return`<p style="margin-bottom: 12px; line-height: 1.6; text-align: justify;">${t.trim()}</p>`})):`<p style="margin-bottom: 0;">${e.trim()}</p>`}d.style.cssText="\n            display: flex;\n            align-items: center;\n            background: none;\n            border: none;\n            font-size: 24px;\n            cursor: pointer;\n            transition: transform 0.2s ease, color 0.3s ease;\n        ",d.id="thumbsDownButton",d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"/></svg>',d.onclick=()=>{Ne(!1),p(),m(d,!1)},s.appendChild(l),s.appendChild(c),a.appendChild(u),a.appendChild(d),i.appendChild(s),i.appendChild(a),t.appendChild(o),t.appendChild(r);const f=qe(n);let h=n.replace(/- Wyekstraktowana odpowiedź:\s*([\s\S]*?)\s*-/,"").trim();if(f){const o=document.createElement("div");o.id="extracted-answer",o.style.cssText="\n                padding: 10px;\n                border-radius: 5px;\n                margin-top: 10px;\n                margin-bottom: 10px;\n                display: flex;\n                align-items: center;\n                justify-content: flex-start;\n                width: 100%;\n                font-size: 18px; /* Większa czcionka dla wyeksponowania */\n                height: auto;\n                box-sizing: border-box;\n                overflow: hidden;\n            ",o.innerHTML=`\n                <span style="display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; background-color: #d4f5cc; border-radius: 50%; margin-right: 10px;">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#69e63c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check">\n                    <polyline points="20 6 9 17 4 12"></polyline>\n                </svg>\n                </span>\n                <span style=" font-weight: bold; font-size: 24px;">${y(f)}</span>\n            `,e.appendChild(t),e.appendChild(o),h=h.replace(/.*\*\$\*/,"").trim(),h=h.replace("Uzasadnienie: ","")}else e.appendChild(t);const g=document.createElement("div");if(g.className="popup-content",g.style.cssText="\n            max-height: 400px;\n            overflow-y: auto;\n            padding-right: 10px;\n            line-height: 1.5;\n            font-size: 14px;\n            cursor: default;\n        ",g.textContent=h,e.appendChild(g),e.appendChild(i),document.body.appendChild(e),!document.getElementById("custom-scrollbar-styles")){const e=document.createElement("style");e.id="custom-scrollbar-styles",e.textContent="\n                .custom-scrollbar {\n                    scrollbar-width: thin;\n                    scrollbar-color: #4169e1 #f0f8ff;\n                }\n                .custom-scrollbar::-webkit-scrollbar {\n                    width: 6px;\n                }\n                .custom-scrollbar::-webkit-scrollbar-track {\n                    background: #f0f8ff;\n                }\n                .custom-scrollbar::-webkit-scrollbar-thumb {\n                    background-color: #4169e1;\n                    border-radius: 3px;\n                }\n            ",document.head.appendChild(e)}g.classList.add("custom-scrollbar"),g.innerHTML=y(h);let w,b,x,S,q=!1;function v(){q=!1,e.style.cursor="move"}e.addEventListener("mousedown",(function(t){if(!g.contains(t.target)){q=!0,w=t.clientX,b=t.clientY;const o=window.getComputedStyle(e);x=parseInt(o.left,10),S=parseInt(o.top,10),e.style.cursor="grabbing"}})),e.addEventListener("mouseup",v),e.addEventListener("mousemove",(function(t){if(q){t.preventDefault();const o=t.clientX-w,n=t.clientY-b;e.style.left=`${x+o}px`,e.style.top=`${S+n}px`}})),e.addEventListener("mouseleave",v)})),Se());else if("updateAnalysis"===e.action)!function(e){const t=document.querySelector("#ai-analysis-popup");if(t){const o=t.querySelector("#extracted-answer"),n=t.querySelector(".popup-content");n.style.height="auto",n.style.overflow="auto";const r=t.querySelector(".loading-spinner");let i=t.querySelector("#thumbsUpButton"),s=t.querySelector("#thumbsDownButton");i.disabled=!1,s.disabled=!1,i.style.cursor="pointer",s.style.cursor="pointer",i.style.color="",s.style.color="";const a=qe(e);if(a)if(o)o.innerHTML=`\n                <span style="display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; background-color: #d4f5cc; border-radius: 50%; margin-right: 10px;">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#69e63c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check">\n                    <polyline points="20 6 9 17 4 12"></polyline>\n                    </svg>\n                </span>\n                <span style=" font-weight: bold; font-size: 24px;">${c(a)}</span>\n                `;else{const u=document.createElement("div");u.id="extracted-answer",u.style.cssText="\n                    padding: 10px;\n                    border-radius: 5px;\n                    margin-top: 10px;\n                    margin-bottom: 10px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: flex-start;\n                    width: 100%;\n                    font-size: 18px; /* Większa czcionka dla wyeksponowania */\n                    height: auto;\n                    box-sizing: border-box;\n                    overflow: hidden;\n                ",u.innerHTML=`\n                <span style="display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; background-color: #d4f5cc; border-radius: 50%; margin-right: 10px;">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#69e63c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check">\n                    <polyline points="20 6 9 17 4 12"></polyline>\n                    </svg>\n                </span>\n                <span style=" font-weight: bold; font-size: 24px;">${c(a)}</span>\n                `,t.appendChild(u)}let l=e.replace(/- Wyekstraktowana odpowiedź:\s*[A-Za-z0-9,\s]+\s*-/,"").trim();function c(e){return(e=(e=(e=e.replace(/\\\[([\s\S]+?)\\\]/g,(function(e,t){return`<div style="margin: 16px 0; text-align: center;">${be(t,!0)}</div>`}))).replace(/\$\$([\s\S]+?)\$\$/g,(function(e,t){return`<div style="margin: 16px 0; text-align: center;">${be(t,!0)}</div>`}))).replace(/\\\((.+?)\\\)/g,(function(e,t){return`<span style="margin-left: 4px; margin-right: 4px;">${be(t,!1)}</span>`}))).replace(/(?:^|\n)([^$\n]+)(?:\n|$)/g,(function(e,t){return`<p style="margin-bottom: 12px; line-height: 1.6; text-align: justify;">${t.trim()}</p>`}))}n&&(n.innerHTML=c(l)),r&&r.remove(),o&&(o.style.display="block"),n&&(n.style.display="block")}}(e.analysis),Se();else if("SEND_ERROR"===e.action){const{errorType:t,comment:n,userEmail:r}=e.errorData,i=document.querySelector(".qtext"),s=i?i.innerText:"Brak pytania",a=document.querySelector(".answer"),l=a?a.innerText:"Brak odpowiedzi",c=document.querySelector(".formulation.clearfix");return async function(e,t,o,n,r,i,s){const a={question:e,answer:t,errorType:o,comment:n,htmlElement:r,userEmail:s};try{(await fetch("https://us-central1-quizonator-a4513.cloudfunctions.net/api/api/send-error-to-slack",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok?i({success:!0}):i({success:!1})}catch(e){console.error("Błąd podczas wysyłania na serwer:",e),i({success:!1})}}(s,l,t,n,c?c.outerHTML:"Brak zawartości pytania",o,r),!0}var n})),window.addEventListener("message",(e=>{if(e.source===window&&(e.data.type&&"FROM_PAGE"===e.data.type?chrome.runtime.sendMessage({type:"TOKEN_FROM_WEBPAGE",token:e.data.token}):"LOGOUT"===e.data.type&&chrome.runtime.sendMessage({type:"LOGOUT"},(e=>{e&&e.success})),"FIREBASE_AUTH_EVENT"===e.data.type))try{chrome.runtime.sendMessage({type:"FIREBASE_AUTH_FROM_WEBAPP",idToken:e.data.idToken,userEmail:e.data.userEmail,uid:e.data.uid},(()=>{}))}catch(e){console.log("Błąd komunikacji z rozszerzeniem:",e)}})),n=e=>{le.isAutoModeEnabled=e,function(){const e=document.querySelector(".quizreviewsummary"),t=window.location.href.includes("testportal.pl/exam/test-result.html?"),o=window.location.href.includes("naurok.com.ua/test/complete"),n=window.location.href.includes("vseosvita.ua/test/go-olp"),r=window.location.href.includes("quizizz.com")&&window.location.href.includes("page=summary");return!!e||t||o||n||r}()&&chrome.storage.local.get(["email","userName"],(e=>{const t=e.email,o=e.userName;if(t||o){if(document.querySelector(".quizreviewsummary")&&ne(t),window.location.href.includes("testportal.pl/exam/test-result.html?")&&ne(t),window.location.href.includes("naurok.com.ua/test/complete")&&ne(t),window.location.href.includes("quizizz.com")&&window.location.href.includes("page=summary")){const e=function(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4;const n=Date.now(),r=setInterval((()=>{document.querySelector(e)?(clearInterval(r),t()):Date.now()-n>o&&(clearInterval(r),console.warn("Element '.screen-summary' not found within timeout."))}),100)};e(".accuracy-info-section",(()=>{ne(t)}))}if(window.location.href.includes("vseosvita.ua/test/go-olp")){const e=function(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4;const n=Date.now(),r=setInterval((()=>{document.querySelector(e)?(clearInterval(r),t()):Date.now()-n>o&&(clearInterval(r),console.warn("Element not found within timeout."))}),100)};e(".v-hello-container.type-container-vo",(()=>{ne(t)}))}}})),e&&pe()},chrome.storage.local.get("autoMode",(e=>{le.isAutoModeEnabled=!!e.autoMode,n(le.isAutoModeEnabled)})),chrome.storage.onChanged.addListener(((e,t)=>{if("local"===t&&"autoMode"in e){const t=e.autoMode.newValue,o=e.autoMode.oldValue;le.isAutoModeEnabled=!!t,!0===t&&!1===o?(he(),pe()):!1===t&&!0===o&&Object.values(le.observers).forEach((e=>{e&&e.disconnect()}))}})),function(){let e=window.location.href;new MutationObserver((()=>{const t=window.location.href;t!==e&&(e=t,le.isAutoModeEnabled&&(he(),pe()))})).observe(document,{subtree:!0,childList:!0})}(),function(){le.observers.main&&le.observers.main.disconnect();let e="body";switch(ue()){case"moodle":e="#responseform, #region-main, .content";break;case"socrative":e="#question-container";break;case"testportal":e=".test-question-body";break;case"quizizz":e=".question-container";break;case"microsoftForms":e="[data-automation-id='questionItem']"}const t=document.querySelector(e)||document.body;le.observers.main=new MutationObserver(ge((()=>{le.isAutoModeEnabled&&"unknown"!==ue()&&pe()}),1e3));le.observers.main.observe(t,{childList:!0,subtree:!0,attributeFilter:["id","class","data-question-id"]})}()}function ue(){return null!==document.querySelector(".que")||null!==document.querySelector(".formulation")?"moodle":null!==document.querySelector("#question-container")?"socrative":null!==document.querySelector(".test-question-body")?"testportal":window.location.href.includes("quizizz.com/join/game/")?"quizizz":"forms.office.com"===window.location.hostname?"microsoftForms":window.location.hostname.includes("vseosvita.ua")&&window.location.pathname.includes("/test/")?"vseosvita":"docs.google.com"===window.location.hostname&&window.location.pathname.includes("/forms/")?"googleForms":null!==document.querySelector(".test-container-inner")&&null!==document.querySelector(".test-question-content")?"naurok":"unknown"}function de(){const e=document.querySelector("#question-container");return e?`${e.getAttribute("id")||""}:${(e.querySelector(".question-text")?.textContent.trim()||"").substring(0,50)}`:""}function pe(){if(!le.isProcessing){le.isProcessing=!0;try{const t=ue();let l="";switch(t){case"moodle":l=function(){const e=document.querySelectorAll(".que");if(0===e.length)return"";const t=[];for(let o=0;o<Math.min(3,e.length);o++){const n=e[o],r=n.getAttribute("id")||"",i=n.querySelector(".qtext")?.textContent.trim()||"";t.push(`${r}:${i.substring(0,30)}`)}return t.join("|")}(),l&&l!==le.platform.lastQuizSignature&&(le.platform.lastQuizSignature=l,function(){if(!le.isAutoModeEnabled)return;const t=document.querySelectorAll(".que");document.querySelector(".quizreviewsummary")||(function(){const e=document.querySelector(".qn_buttons.clearfix.multipages");if(!e)return;const t=[...e.querySelectorAll("a")];let o=JSON.parse(localStorage.getItem("instructionsRanges"))||[],n=[],r=-1;t.forEach(((e,o)=>{const i=e.innerText.trim().toLowerCase(),s=parseInt(e.getAttribute("data-quiz-page"),10);i.includes("info")&&(r>=0&&null===n[r].endPage&&(n[r].endPage=t[o-1]?parseInt(t[o-1].getAttribute("data-quiz-page"),10):s),n.push({infoPage:s,startPage:t[o+1]?parseInt(t[o+1].getAttribute("data-quiz-page"),10):null,endPage:null}),r=n.length-1)})),n.length>0&&null===n[n.length-1].endPage&&(n[n.length-1].endPage=parseInt(t[t.length-1].getAttribute("data-quiz-page"),10)),JSON.stringify(o.map((e=>{let{instructionText:t,...o}=e;return o})))!==JSON.stringify(n)&&localStorage.setItem("instructionsRanges",JSON.stringify(n))}(),t.forEach((t=>{const l=t.getAttribute("id")||"",u=t.querySelector(".qtext")?.textContent.trim()||"",d=`${l}:${u.substring(0,20)}`;if(t.hasAttribute("data-sc-processed"))return;if(le.platform.processedElementIds.has(d))return;const p=function(e){return function(e){const t=o(),n=e.querySelector(".qtext"),r=n?n.innerText.trim():"";let i=JSON.parse(localStorage.getItem("instructionsRanges"))||[];const s=i.findIndex((e=>e.infoPage===t));-1!==s&&(i[s].instructionText=r),localStorage.setItem("instructionsRanges",JSON.stringify(i))}(e),e.closest(".que.multichoice")||e.closest(".que.calculatedmulti")?"multipleChoice":e.closest(".que.truefalse")?"trueFalse":e.closest(".que.match")?"matching":e.closest(".que.gapselect")?"cloze":e.closest(".que.multianswer")?"cloze-multianswer":e.closest(".que.shortanswer")||e.closest(".que.numerical")||e.closest(".que.calculated")?"shortAnswer":e.querySelector(".qtype_essay_editor")||e.querySelector("textarea.qtype_essay_plain")||e.querySelector("que.essay")?"longAnswer":e.querySelector(".sortablelist")?"ordering":e.querySelector(".answercontainer .draghome")?"dragAndDrop":"unknown"}(t);switch(t.setAttribute("data-sc-processed","true"),p){case"multipleChoice":!async function(t){const n=await async function(e){const t=e.querySelector(".qtext");return t?await s(t):""}(t),l=await async function(e){const t=e.querySelectorAll(".answer > div, .answer .r0, .answer .r1"),o=[];for(let e of t){let t="";const n=e.querySelector("div[data-region='answer-label'], label");if(n){const e=n.querySelectorAll("p"),r=n.querySelectorAll("pre"),i=n.querySelectorAll("div");e.length>0?t=Array.from(e).map((e=>e.textContent.trim())).join(" "):r.length>0?t=Array.from(r).map((e=>e.textContent.trim())).join(" "):i.length>0&&(t=Array.from(i).map((e=>e.textContent.trim())).join(" ")),t=t.trim(),t&&!o.includes(t)&&o.push(t)}}return o}(t),c=await a(t),u=t.querySelectorAll("input[type='checkbox']").length>1;e(i(n,r(o()),l),l,"multipleChoice",1,[],u,c).then((e=>{!function(e,t){const o=e.querySelectorAll(".answer > div, .answer .r0, .answer .r1, .radio-custom"),n=t.split(",").map((e=>e.trim()));chrome.storage.local.get(["markingMode"],(e=>{const t=e.markingMode||"default";o.forEach(((e,o)=>{const r=e.querySelector("input[type='checkbox'], input[type='radio']");let i=e.querySelector("div[data-region='answer-label']");i||(i=e.querySelector("label"));let s="";i&&(s=Array.from(i.querySelectorAll("p, pre, div")).map((e=>e.innerText.trim())).filter((e=>e.length>0)).join(" ").trim());const a=(o+1).toString(),l=n.includes(a),c=n.some((e=>e===s));(l||c)&&("immediate"===t?r?r.checked=!0:console.warn(`Input element for answer "${s}" not found.`):"saveMode"===t?Array.from(i.querySelectorAll("p, pre, div")).forEach((e=>{const t=e.innerText.trim();t&&(e.innerHTML=`<span style="font-weight: 600;">${t[0]}</span>${t.slice(1)}`)})):Array.from(i.querySelectorAll("p, pre, div")).forEach((e=>{e.style.fontWeight="bold",e.style.color="#4CAF50"})))}))}))}(t,e)})).catch((e=>{console.error("Error processing question with ChatGPT:",e)}))}(t);break;case"trueFalse":!async function(t){const o=await async function(e){const t=e.querySelector(".qtext");return t?await s(t):""}(t),n=await async function(e){const t=e.querySelectorAll(".answer label"),o=[];for(const e of t){const t=await s(e);o.push(t.trim())}return o}(t);Array.isArray(n)&&e(o,n,"trueFalse").then((e=>{!function(e,t){const o=e.querySelectorAll(".answer div"),n=t.trim().toLowerCase();chrome.storage.local.get(["markingMode"],(e=>{const t=e.markingMode||"default";o.forEach(((e,o)=>{const r=e.querySelector("label"),i=e.querySelector("input[type='radio']");if(r&&i){const e=r.innerText.trim().toLowerCase(),s=(o+1).toString();(n.includes(e)||n.includes(s))&&("immediate"===t?i.checked=!0:"saveMode"===t?r.innerHTML=`<span style="font-weight: 600;">${e[0]}</span>${e.slice(1)}`:(r.style.fontWeight="bold",r.style.color="#4CAF50"))}}))}))}(t,e)})).catch((e=>{console.error("Error processing true/false question with ChatGPT:",e)}))}(t);break;case"matching":!async function(t){const o=await async function(e){const t=e.querySelector(".qtext");return t?t.textContent.trim():(console.error("Nie znaleziono elementu .qtext."),"")}(t),n=await async function(e){const t=e.querySelector(".ablock .answer tbody");if(!t)return console.error("Nie znaleziono tabeli odpowiedzi."),[];const o=[];return t.querySelectorAll("tr").forEach((e=>{let t=e.querySelector("td.text pre");const n=e.querySelector("td.control select");if(t=e.querySelector("td.text p"),t||(t=e.querySelectorAll("td.text pre")),t&&n){const e=t.textContent.trim(),r=[];n.querySelectorAll("option").forEach((e=>{"0"!==e.value&&r.push(e.textContent.trim())})),o.push({term:e,options:r})}else console.error("Nie znaleziono elementów termElement lub selectElement w wierszu:",e)})),o}(t);Array.isArray(n)&&e(o,n,"matching").then((e=>{!function(e,t){const o=t.replace(/[^0-9,]/g,"").trim(),n=e.querySelectorAll(".ablock .answer tbody tr");n.length?chrome.storage.local.get(["markingMode"],(e=>{const t=e.markingMode||"default",r=o.split(",").map((e=>e.trim()));r.length===n.length?n.forEach(((e,o)=>{const n=e.querySelector("select"),i=r[o];if(!e.querySelector("td.text p"))return void console.error("Nie znaleziono elementu termElement w wierszu:",e);const s=n?n.querySelector(`option[value="${i}"]`):null;"immediate"===t?s&&(n.value=s.value):"saveMode"===t?s&&(s.style.color="#999797"):s&&(s.style.fontWeight="bold",s.style.color="#4CAF50")})):console.error("Mismatch between number of terms and answers. Check the response format.")})):console.error("Nie znaleziono żadnych wierszy w tabeli odpowiedzi.")}(t,e)})).catch((e=>{console.error("Error processing matching question with ChatGPT:",e)}))}(t);break;case"cloze":!async function(t){const o=await async function(e){const t=e.querySelector(".qtext");return t?await s(t):""}(t),n=await async function(e){const t=e.querySelectorAll(".qtext select");let o=[];for(const e of t){const t=[];for(const o of e.options)if(""!==o.value){const e=await s(o);t.push(e.trim())}o.push(t)}return o}(t);Array.isArray(n)?e(o,n,"cloze").then((e=>{!function(e,t){const o=e.querySelectorAll(".qtext select");chrome.storage.local.get(["markingMode"],(e=>{const n=e.markingMode||"default";t.split(",").forEach(((e,t)=>{const r=o[t];if(!r)return void console.warn(`No select element found for cloze part ${t+1}`);const i=e.trim(),s=r.querySelector(`option[value="${i}"]`);s?"immediate"===n?r.value=s.value:"saveMode"===n?s.style.color="#D3D3D3":(s.style.fontWeight="bold",s.style.color="#4CAF50"):console.warn(`No option found for value '${i}' in select element for cloze part ${t+1}`)}))}))}(t,e)})).catch((e=>{console.error("Error processing cloze question with ChatGPT:",e)})):console.error("clozeOptions is not an array:",n)}(t);break;case"cloze-multianswer":c(t);break;case"shortAnswer":!async function(t){const s=await async function(e){let t="";const o=e.querySelector(".qtext");return o?t=o.textContent.trim():e.querySelectorAll("p, pre").forEach((e=>{e.querySelector(".subquestion")||(t+=e.textContent.trim()+"\n")})),t.trim()}(t),l=t.querySelectorAll("input[type='text']").length,c=await a(t);e(i(s,r(o())),[],"shortAnswer",l,[],!1,c).then((e=>{!function(e,t){const o=e.querySelectorAll("input[type='text']"),r=t.split("\n").map((e=>e.trim().toLowerCase()));chrome.storage.local.get(["markingMode"],(e=>{const t=e.markingMode||"default";o.forEach((e=>{const o=r.find((t=>t===e.value.trim().toLowerCase()))||r[0];if("immediate"===t)e&&(e.value=o);else if("saveMode"===t)e&&(e.addEventListener("focus",(function(){e.placeholder=o})),e.addEventListener("blur",(function(){e.placeholder="",e.style.color=""})));else if(e){const t=document.createElement("div");t.style.color="#4CAF50",t.style.fontWeight="bold",t.innerText=`${n("correctAnswer")} ${o}`,e.parentNode.appendChild(t)}}))}))}(t,e)})).catch((e=>{console.error("Error processing short answer question with ChatGPT:",e)}))}(t);break;case"longAnswer":!async function(t){const o=await async function(e){const t=e.querySelector(".qtext p"),o=e.querySelector(".qtext");return(t?await s(t):await s(o)).trim()}(t);e(o,[],"longAnswer").then((e=>{!function(e,t){const o=e.querySelector("textarea.qtype_essay_plain"),r=e.querySelector("iframe");let i;if(r){const e=r.contentDocument||r.contentWindow.document;i=e.querySelector("body")}else i=e.querySelector("textarea");chrome.storage.local.get(["markingMode"],(e=>{const s=e.markingMode||"default";if("immediate"===s)o?o.value=t.trim():r&&(i.innerHTML=`<p>${t.trim()}</p>`);else if("saveMode"===s){const e=t.trim().split(" ");let n=0;const s=()=>{const e=document.createElement("div");return e.style.position="absolute",e.style.color="#999797",e.style.pointerEvents="none",e.style.whiteSpace="pre-wrap",e.style.opacity="0.5",e.style.zIndex="1",e},a=(e,t)=>{const o=e.getBoundingClientRect();t.style.top=`${o.top+window.scrollY}px`,t.style.left=`${o.left+window.scrollX}px`,t.style.width=`${o.width}px`,t.style.height=`${o.height}px`,t.style.padding=getComputedStyle(e).padding,t.style.fontSize=getComputedStyle(e).fontSize,t.style.lineHeight=getComputedStyle(e).lineHeight,t.style.fontFamily=getComputedStyle(e).fontFamily},l=(t,o)=>{const r=t.value;let i=e.slice(n).join(" ");if(r.trim()){const t=r.trim().split(" ");for(let o=0;o<t.length;o++){if(!e[o]||!e[o].startsWith(t[o])){n=o,i=e.slice(n).join(" ");break}n=o+1}}o.innerHTML=`${r}${i?" "+i:""}`},c=(t,o,r)=>{if("Tab"===t.key){if(t.preventDefault(),n<e.length){const t=e[n]+" ";o.value+=t,n++,l(o,r)}}else l(o,r)},u=e=>{const t=s();document.body.appendChild(t),a(e,t),l(e,t),e.addEventListener("keydown",(o=>c(o,e,t))),e.addEventListener("input",(()=>l(e,t))),window.addEventListener("resize",(()=>a(e,t)))};if(o)o.style.position="relative",u(o);else if(r){const e=document.createElement("div");e.style.color="#999797",e.style.fontStyle="italic",e.innerText=`Sugestia: ${t.trim()}`,r.closest(".qtype_essay_editor").appendChild(e);const o=s();document.body.appendChild(o),a(i,o),l(i,o),i.addEventListener("keydown",(e=>c(e,i,o))),i.addEventListener("input",(()=>l(i,o))),window.addEventListener("resize",(()=>a(i,o)))}}else if(o){const e=document.createElement("div");e.style.color="#4CAF50",e.style.fontWeight="bold",e.innerText=`${n("correctAnswer")} ${t.trim()}`,o.parentNode.appendChild(e)}else if(r){const e=document.createElement("div");e.style.color="#4CAF50",e.style.fontWeight="bold",e.innerText=`${n("correctAnswer")} ${t.trim()}`,r.closest(".qtype_essay_editor").appendChild(e)}}))}(t,e)})).catch((e=>{console.error("Error processing long answer question with ChatGPT:",e)}))}(t);break;case"dragAndDrop":!async function(t){const o=await async function(e){const t=e.querySelector(".qtext");return t?await s(t):""}(t),r=await async function(e){const t=e.querySelectorAll(".draghome.unplaced"),o=[];for(const e of t){const t=await s(e);o.push(t.trim())}return o}(t);Array.isArray(r)?e(o,r,"dragAndDrop").then((e=>{!function(e,t){const o=t.split(",").map((e=>parseInt(e.trim())-1)),r=e.querySelectorAll(".draghome.unplaced"),i=e.querySelectorAll(".place1.drop, .place2.drop, .place3.drop, .place4.drop");chrome.storage.local.get(["markingMode"],(t=>{const s=t.markingMode||"default";i.length>1&&r.length>1&&("immediate"===s?o.forEach(((e,t)=>{const o=r[e],n=i[t],s=o.getBoundingClientRect(),a=n.getBoundingClientRect();o.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,clientX:s.left,clientY:s.top})),o.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,clientX:a.left+a.width/2,clientY:a.top+a.height/2})),o.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,clientX:a.left+a.width/2,clientY:a.top+a.height/2}))})):"saveMode"===s?o.forEach((e=>{const t=r[e],o=t.innerText.trim();t.innerHTML=`<span style="font-weight: 600;">${o[0]}</span>${o.slice(1)}`})):o.forEach(((t,o)=>{const i=r[t].innerText.trim(),s=document.createElement("div");s.style.color="#4CAF50",s.style.fontWeight="bold",s.innerText=`${n("correctAnswer")} ${o+1}: ${i}`,e.appendChild(s)})))}))}(t,e)})).catch((e=>{console.error("Error processing drag-and-drop question with ChatGPT:",e)})):console.error("Possible answers are not an array:",r)}(t);break;case"ordering":!async function(t){const o=await async function(e){const t=e.querySelector(".qtext");return t?t.textContent.trim():""}(t),n=await async function(e){const t=e.querySelectorAll(".sortablelist .sortableitem"),o=[];return t.forEach((e=>{const t=e.querySelector(".flex-grow-1");t&&o.push(t.textContent.trim())})),o}(t);e(o,n,"ordering").then((e=>{!function(e,t){const o=t.split(",").map((e=>e.trim())),n=Array.from(e.querySelectorAll("li.sortableitem"));function r(){n.forEach(((e,t)=>{const n=e.querySelector(".d-flex.align-items-center.flex-grow-1.px-2").textContent.trim(),r=o.indexOf(n),i=e.querySelector("button[data-action='move-backward'] i"),s=e.querySelector("button[data-action='move-forward'] i");i.style.color="",s.style.color="",r!==t&&(r<t?i.style.color="#999999":r>t&&(s.style.color="#999999"))}))}chrome.storage.local.get(["markingMode"],(t=>{const i=t.markingMode||"default";if("immediate"===i){n.sort(((e,t)=>{const n=e.querySelector(".d-flex.align-items-center.flex-grow-1.px-2").textContent.trim(),r=t.querySelector(".d-flex.align-items-center.flex-grow-1.px-2").textContent.trim();return o.indexOf(n)-o.indexOf(r)}));const t=e.querySelector("ul.sortablelist");n.forEach((e=>t.appendChild(e))),r()}else"saveMode"===i?(r(),n.forEach((e=>{const t=e.querySelector("button[data-action='move-backward']"),o=e.querySelector("button[data-action='move-forward']");t.addEventListener("click",(()=>{setTimeout((()=>{r()}),100)})),o.addEventListener("click",(()=>{setTimeout((()=>{r()}),100)}))}))):n.forEach(((e,t)=>{const n=e.querySelector(".d-flex.align-items-center.flex-grow-1.px-2").textContent.trim(),r=o.indexOf(n);-1!==r?e.querySelector(".d-flex.align-items-center.flex-grow-1.px-2").innerHTML=`<span style="color: #4CAF50; font-weight: bold;">${r+1}. </span>${n}`:console.warn(`No match found for: ${n}`)}))}))}(t,e)})).catch((e=>{console.error("Error processing ordering question with ChatGPT:",e)}))}(t)}le.platform.processedElementIds.add(d),le.platform.processedQuestionsContent.set(l,u)})))}());break;case"socrative":l=de(),l&&l!==le.platform.lastQuizSignature&&(le.platform.lastQuizSignature=l,me(),function(){le.observers.dynamic&&le.observers.dynamic.disconnect();const e=document.querySelector("#question-container");e&&(le.observers.dynamic=new MutationObserver(ge((()=>{if(!le.isAutoModeEnabled)return;const e=de();e&&e!==le.platform.lastQuizSignature&&(le.platform.lastQuizSignature=e,me())}),500)),le.observers.dynamic.observe(e,{childList:!0,subtree:!0,attributeFilter:["id","class"]}))}());break;case"testportal":l=function(){const e=document.querySelector(".test-question-body");return e?`${e.getAttribute("data-question-id")||""}:${(e.querySelector(".question-text")?.textContent.trim()||"").substring(0,50)}`:""}(),l&&l!==le.platform.lastQuizSignature&&(le.platform.lastQuizSignature=l,async function(){const{markingMode:e}=await new Promise((e=>{chrome.storage.local.get(["markingMode"],(t=>{e({markingMode:t.markingMode||"default"})}))})),t=document.querySelectorAll(".test-question-body");if(!t.length)return;const o=Array.from(t).map((t=>m(t,e,undefined)));await Promise.all(o)}());break;case"quizizz":k();break;case"microsoftForms":le.platform.formsHandled||ye();break;case"googleForms":l=function(){const e=document.querySelector(".freebirdFormviewerViewItemsItemItem");return e?`${e.getAttribute("data-item-id")||""}:${(e.querySelector(".freebirdFormviewerViewItemsItemItemTitle")?.textContent.trim()||"").substring(0,50)}`:""}(),(!le.platform.googleFormsProcessed||l&&l!==le.platform.lastQuizSignature)&&(le.platform.lastQuizSignature=l,le.platform.googleFormsProcessed=!0,async function(){try{const{markingMode:e}=await new Promise((e=>{chrome.storage.local.get(["markingMode"],(t=>{e({markingMode:t.markingMode||"default"})}))}));let t=document.querySelectorAll('.Qr7Oae[role="listitem"]');if(0===t.length){const e=[".freebirdFormviewerViewItemsItemItem",".freebirdFormviewerViewNumberedItemContainer",'[role="listitem"]'];for(const o of e){const e=document.querySelectorAll(o);if(e.length>0){t=e;break}}}if(0===t.length)return[];const o=Array.from(t).map((t=>O(t,e))),n=(await Promise.all(o)).filter((e=>null!==e));return document.body.style.cursor="default",n}catch(e){return document.body.style.cursor="default",console.error(`Krytyczny błąd w processGoogleForms: ${e.message}`),[]}}());break;case"naurok":l=function(){const e=document.querySelector(".test-content-text-inner");return e?`naurok:${e.textContent.trim().substring(0,50)}`:""}(),l&&l!==le.platform.lastQuizSignature&&(le.platform.lastQuizSignature=l,Q());break;case"vseosvita":l=function(){const e=document.querySelector(".v-test-question");if(!e)return"";const t=e.querySelector(".v-test-questions-title p"),o=t?.textContent.trim()||"";return`${e.querySelector("input[type='radio']")?.name||""}:${o.substring(0,50)}`}(),l&&l!==le.platform.lastQuizSignature&&(le.platform.lastQuizSignature=l,Y())}}catch(e){console.error("Error processing content:",e)}finally{le.isProcessing=!1}}}function me(){if(!le.isAutoModeEnabled)return;const t=document.querySelector("#question-container");if(!t)return;const o=function(e){return e.querySelector("#question-container .mc-question")?"multipleChoiceSocrative":e.querySelector("#question-container .tf-question")?"trueFalseSocrative":e.querySelector("#question-container .fr-question")?"openEndedSocrative":"unknown"}(t);switch(o){case"multipleChoiceSocrative":!async function(t){const o=await async function(e){const t=e.querySelector(".question-text pre");return t?t.innerText.trim():""}(t),n=await async function(e){const t=e.querySelectorAll(".mc-answer-option"),o=[];for(let e of t){const t=e.querySelector(".mc-answer-option-text pre");if(t){const e=t.innerText.trim();e&&!o.includes(e)&&o.push(e)}}return o}(t);e(o,n,"multipleChoice",1,[],!1,[]).then((e=>{!function(e,t){const o=e.querySelectorAll(".mc-answer-option"),n=parseInt(t.trim())-1;chrome.storage.local.get(["markingMode"],(e=>{const r=e.markingMode||"default";if(n>=0&&n<o.length){const e=o[n],t=(e.querySelector(".mc-answer-option-container"),e.querySelector(".mc-answer-option-text pre"));"immediate"===r?t.click():"saveMode"===r?t&&(t.style.fontWeight="normal",t.innerHTML=`<span style="font-weight: 600;">${t.innerText[0]}</span>${t.innerText.slice(1)}`):t&&(t.style.fontWeight="bold",t.style.color="#4CAF50")}else console.warn("Niepoprawny numer odpowiedzi:",t)}))}(t,e)})).catch((e=>{console.error("Error processing question with ChatGPT:",e)}))}(t);break;case"trueFalseSocrative":!async function(t){const o=await async function(e){const t=e.querySelector(".question-text pre");return t?t.innerText.trim():""}(t),n=await async function(e){const t=e.querySelectorAll(".tf-answer-option"),o=[];for(let e of t){const t=e.querySelector(".tf-answer-option-text pre p");if(t){const e=t.innerText.trim();e&&!o.includes(e)&&o.push(e)}}return o}(t);e(o,n,"trueFalse",1,[],!1,[]).then((e=>{!function(e,t){const o=e.querySelectorAll(".mc-answer-option"),n=t.trim().replace(/[.,!]/g,"").toLowerCase();chrome.storage.local.get(["markingMode"],(e=>{const t=e.markingMode||"default";o.forEach((e=>{const o=e.querySelector(".mc-answer-option-text pre");if((o?o.innerText.trim().replace(/[.,!]/g,"").toLowerCase():"")===n)if("immediate"===t)o.click();else if("saveMode"===t){if(o){const e=o.innerText.trim();o.innerHTML=`<span style="font-weight: 600; color: inherit;">${e[0]}</span>${e.slice(1)}`}}else e.style.fontWeight="bold",e.style.color="#4CAF50"}))}))}(t,e)})).catch((e=>{console.error("Error processing True/False question with ChatGPT:",e)}))}(t);break;case"openEndedSocrative":!async function(t){const o=await async function(e){const t=e.querySelector(".question-text pre");return t?t.innerText.trim():""}(t);e(o,[],"openEnded",1,[],!1,[]).then((e=>{!function(e,t){const o=e.querySelector(".fr-question-textarea");o?chrome.storage.local.get(["markingMode"],(e=>{e.markingMode,o.value=t,o.dispatchEvent(new Event("input",{bubbles:!0})),o.addEventListener("focus",(()=>{o.style.color="",o.style.fontWeight=""}))})):console.warn("Answer textarea not found for open-ended question.")}(t,e)})).catch((e=>{console.error("Error processing open-ended question with ChatGPT:",e)}))}(t)}}function ye(){if("forms.office.com"!==window.location.hostname||!le.isAutoModeEnabled)return;le.platform.formsHandled=!1,window.formsCheckInterval&&clearInterval(window.formsCheckInterval);let e=0;window.formsCheckInterval=setInterval((()=>{e++,document.querySelector("[data-automation-id='questionItem']")&&(clearInterval(window.formsCheckInterval),le.platform.lastQuizSignature=fe(),le.isAutoModeEnabled&&(w(),function(){le.observers.dynamic&&le.observers.dynamic.disconnect();const e=document.querySelector("[data-automation-id='questionItem']")?.parentElement;e&&(le.observers.dynamic=new MutationObserver(ge((()=>{if(!le.isAutoModeEnabled)return;const e=fe();e&&e!==le.platform.lastQuizSignature&&(le.platform.lastQuizSignature=e,w())}),500)),le.observers.dynamic.observe(e,{childList:!0,subtree:!0}))}(),le.platform.formsHandled=!0)),e>=20&&clearInterval(window.formsCheckInterval)}),500)}function fe(){const e=document.querySelector("[data-automation-id='questionItem']");if(!e)return"";const t=e.firstElementChild;if(!t)return"";const o=t.getAttribute("id")||"";if(le.platform.lastFirstQuestionId!==o){le.platform.lastFirstQuestionId=o;const t=e.querySelector("[data-automation-id='questionTitle']");le.platform.firstQuestionStaticTitle=t?t.innerText.trim():""}return`${o}:${le.platform.firstQuestionStaticTitle}`}function he(){le.quizHandled=!1,le.isProcessing=!1,le.platform={lastQuizSignature:null,lastFirstQuestionId:null,firstQuestionStaticTitle:null,formsHandled:!1,googleFormsProcessed:!1,processedElementIds:new Set,processedQuestionsContent:new Map},void 0!==window.isNaurokProcessingActive&&(window.isNaurokProcessingActive=!1)}function ge(e,t){let o;return function(){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];const s=this;clearTimeout(o),o=setTimeout((()=>e.apply(s,r)),t)}}function we(e){if(window.katex)return void e();const t=document.createElement("script");t.src=chrome.runtime.getURL("vendor/katex/katex.min.js"),t.onload=function(){e()},document.head.appendChild(t);const o=document.createElement("link");o.rel="stylesheet",o.href=chrome.runtime.getURL("vendor/katex/katex.min.css"),document.head.appendChild(o)}function be(e,t){try{return katex.renderToString(e,{throwOnError:!1,displayMode:t})}catch(t){return e}}function xe(){const e=document.querySelector("#ai-analysis-popup");if(!e){const e=document.createElement("div");e.id="ai-loading-popup",e.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background-color: rgba(240, 248, 255, 0.9);\n            border: 2px solid #4169e1;\n            border-radius: 10px;\n            padding: 20px;\n            z-index: 10001;\n            text-align: center;\n            font-family: Arial, sans-serif;\n            color: #4169e1;\n            box-shadow: 0 4px 15px rgba(65, 105, 225, 0.3);\n        ";const t=document.createElement("p");t.textContent="Ładowanie odpowiedzi AI...",t.className="loading-text",t.style.marginBottom="10px";const o=document.createElement("div");o.className="loading-spinner",o.style.cssText="\n            border: 4px solid #f3f3f3;\n            border-top: 4px solid #4169e1;\n            border-radius: 50%;\n            width: 30px;\n            height: 30px;\n            animation: spin 1s linear infinite;\n            margin: 0 auto;\n        ";const n="\n            @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n            }\n        ",r=document.createElement("style");return r.appendChild(document.createTextNode(n)),document.head.appendChild(r),e.appendChild(t),e.appendChild(o),document.body.appendChild(e),e}{const t=e.querySelector(".loading-spinner");t&&t.remove();const o=e.querySelector(".popup-content");o&&(o.innerHTML="",o.style.overflow="hidden",o.style.height="150px");const n=e.querySelector("#extracted-answer");n&&(n.style.display="none");const r=document.createElement("div");r.className="loading-container",r.style.cssText="\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            height: 100%;\n            width: 100%; \n            position: absolute; \n            top: 0; \n            left: 0;\n        ";const i=document.createElement("p");i.textContent="Ładowanie odpowiedzi AI...",i.className="loading-text",i.style.marginBottom="10px",i.style.textAlign="center";const s=document.createElement("div");s.className="loading-spinner",s.style.cssText="\n            border: 4px solid #f3f3f3;\n            border-top: 4px solid #4169e1;\n            border-radius: 50%;\n            width: 30px;\n            height: 30px;\n            animation: spin 1s linear infinite;\n            margin: 0 auto;\n        ";const a="\n            @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n            }\n        ",l=document.createElement("style");l.appendChild(document.createTextNode(a)),document.head.appendChild(l);const c=e.querySelector(".loading-text");c&&c.remove(),r.appendChild(i),r.appendChild(s),o.appendChild(r),o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center"}}function Se(){const e=document.getElementById("ai-loading-popup");e&&document.body.removeChild(e)}function qe(e){const t=e.match(/- Wyekstraktowana odpowiedź:\s*([\s\S]*?)\s*-/);if(t)return t[1].trim();const o=e.match(/^(true|false)/i);if(o)return o[1].toUpperCase();const n=e.match(/^([a-z0-9]+(?:\s*,\s*[a-z0-9]+)*)/i);return n&&n[1].split(/\s+/).length<=2?n[1].toUpperCase():null}window.contentScriptInjected?(he(),ce()):(window.contentScriptInjected=!0,ce()),window.addEventListener("load",(()=>{le.isAutoModeEnabled&&(he(),pe())})),window.addEventListener("pageshow",(()=>{le.isAutoModeEnabled&&(he(),pe(),"forms.office.com"===window.location.hostname&&(le.platform.formsHandled=!1,ye()))}));let ve,ke,Te,Ae,Ee=!1;function Ce(e){"Escape"===e.key&&Ie()}function ze(e){Ee=!0,ve=e.clientX,ke=e.clientY,Te=e.clientX,Ae=e.clientY,je(),Le()}function Me(e){Ee&&(Te=e.clientX,Ae=e.clientY,je())}function Pe(e){Ee=!1,Te=e.clientX,Ae=e.clientY,function(){Le();const e=Math.abs(Te-ve),t=Math.abs(Ae-ke);if(e<20||t<20)return void Ie();const o=document.createElement("div");o.classList.add("confirmation-button-container"),o.style.cssText=`\n        position: fixed;\n        top: ${Ae+10}px;\n        left: ${Te+10}px;\n        display: flex;\n        gap: 10px; /* Odstęp między przyciskami */\n        z-index: 10001;\n    `;const n=document.createElement("button");n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><polyline points="20 6 9 17 4 12"></polyline></svg>',n.style.cssText="\n        width: 48px;\n        height: 48px;\n        border-radius: 8px;\n        background: linear-gradient(to bottom right, #38bdf8, #22d3ee);\n        color: white;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.15);\n        transition: box-shadow 0.3s ease-in-out;\n        border: none;\n        cursor: pointer;\n    ",n.onmouseover=()=>n.style.boxShadow="0px 6px 12px rgba(0, 0, 0, 0.25)",n.onmouseout=()=>n.style.boxShadow="0px 4px 8px rgba(0, 0, 0, 0.15)",n.onclick=()=>{var e;Le(),e={x:Math.min(ve,Te),y:Math.min(ke,Ae),width:Math.abs(Te-ve),height:Math.abs(Ae-ke)},Ie(),Le(),xe(),chrome.runtime.sendMessage({action:"captureAndAnalyzeScreenshot",area:e})};const r=document.createElement("button");r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',r.style.cssText="\n        width: 48px;\n        height: 48px;\n        border-radius: 8px;\n        background: linear-gradient(to bottom right, #f87171, #fb7185);\n        color: white;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.15);\n        transition: box-shadow 0.3s ease-in-out;\n        border: none;\n        cursor: pointer;\n    ",r.onmouseover=()=>r.style.boxShadow="0px 6px 12px rgba(0, 0, 0, 0.25)",r.onmouseout=()=>r.style.boxShadow="0px 4px 8px rgba(0, 0, 0, 0.15)",r.onclick=()=>{Le(),Ie()},o.appendChild(n),o.appendChild(r),document.body.appendChild(o)}()}function je(){const e=Math.min(ve,Te),t=Math.min(ke,Ae),o=Math.abs(Te-ve),n=Math.abs(Ae-ke);ae.style.left=`${e}px`,ae.style.top=`${t}px`,ae.style.width=`${o}px`,ae.style.height=`${n}px`,ae.style.display="block"}function Le(){const e=document.querySelector(".confirmation-button-container");e&&e.remove()}function Ie(){se&&se.parentNode&&(se.parentNode.removeChild(se),document.removeEventListener("keydown",Ce)),Le()}function Ne(e){const t=e?"positive":"negative",o=document.querySelector("#ai-analysis-popup");let n="",r="";if(o){const e=o.querySelector("#extracted-answer"),t=o.querySelector(".popup-content");t&&(n=t.textContent.trim()),e&&(r=e.textContent.trim())}chrome.storage.local.get(["lastScreenshot","email"],(function(e){const o=e.lastScreenshot||"",i={userEmail:e.email||"",extractedAnswer:r,analysis:n,screenshotDataUrl:o,feedback:t};fetch("https://us-central1-quizonator-a4513.cloudfunctions.net/api/snapshot-feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then((e=>{e.ok||console.error("Błąd podczas wysyłania feedbacku:",e.statusText)})).catch((e=>{console.error("Wystąpił błąd:",e)}))}))}})();
//# sourceMappingURL=contentScript.bundle.js.map